"use strict";function changeSlice(a,b){"add"==b?"AXIAL"===a?$(".AxialAdd").click():"CORONAL"===a?$(".CoronalAdd").click():"SAGITTAL"===a&&$(".SagittalAdd").click():"AXIAL"===a?$(".AxialSub").click():"CORONAL"===a?$(".CoronalSub").click():"SAGITTAL"===a&&$(".SagittalSub").click()}function changeMagnifySlice(a,b){"add"==b?"AXIAL"===a?$(".AxialAdd").click():"CORONAL"===a?$(".CoronalAdd").click():"SAGITTAL"===a&&$(".SagittalAdd").click():"AXIAL"===a?$(".AxialSub").click():"CORONAL"===a?$(".CoronalSub").click():"SAGITTAL"===a&&$(".SagittalSub").click()}var papaya=papaya||{};papaya.viewer=papaya.viewer||{},papaya.viewer.Atlas=papaya.viewer.Atlas||function(a,b,c){this.container=b,this.callback=c,this.name=null,this.transformedname=null,this.labels=[],this.atlasLabelData=a.labels,this.volume=new papaya.volume.Volume(b.display,b.viewer),this.displayColumns=null,this.returnLabels=null,this.transform=null,this.currentAtlas=null,this.maxLabels=0,this.probabilistic=!1;var d=b.findLoadableImage(a.labels.atlas.header.images.summaryimagefile);b.params.atlasURL?this.volume.readURLs([b.params.atlasURL],papaya.utilities.ObjectUtils.bind(this,this.readFinished)):null!==d&&void 0!==d.encode?this.volume.readEncodedData([d.encode],papaya.utilities.ObjectUtils.bind(this,this.readFinished)):null!==d&&void 0!==d.url&&this.volume.readURLs([d.url],papaya.utilities.ObjectUtils.bind(this,this.readFinished))},papaya.viewer.Atlas.MAX_LABELS=4,papaya.viewer.Atlas.PROBABILISTIC=["probabalistic","probabilistic","statistic"],papaya.viewer.Atlas.LABEL_SPLIT_REGEX=/\.|:|,|\//,papaya.viewer.Atlas.prototype.getLabelAtCoordinate=function(a,b,c){var d,e,f,g;return this.transform&&this.currentAtlas===this.transformedname?(d=a*this.transform[0][0]+b*this.transform[0][1]+c*this.transform[0][2]+this.transform[0][3],e=a*this.transform[1][0]+b*this.transform[1][1]+c*this.transform[1][2]+this.transform[1][3],f=a*this.transform[2][0]+b*this.transform[2][1]+c*this.transform[2][2]+this.transform[2][3]):(d=a,e=b,f=c),g=this.volume.getVoxelAtCoordinate(d,e,f,0,!0),this.probabilistic&&(g-=1),this.formatLabels(this.labels[g],this.returnLabels)},papaya.viewer.Atlas.prototype.readFinished=function(){this.parseTransform(),this.parseLabels(),this.parseDisplayColumns(),this.maxLabels=this.findMaxLabelParts(),this.probabilistic=this.atlasLabelData.atlas.header.type&&(this.atlasLabelData.atlas.header.type.toLowerCase()===papaya.viewer.Atlas.PROBABILISTIC[0]||this.atlasLabelData.atlas.header.type.toLowerCase()===papaya.viewer.Atlas.PROBABILISTIC[1]||this.atlasLabelData.atlas.header.type.toLowerCase()===papaya.viewer.Atlas.PROBABILISTIC[2]),this.returnLabels=[],this.returnLabels.length=this.maxLabels,this.atlasLabelData.atlas.header.transformedname&&(this.transformedname=this.atlasLabelData.atlas.header.transformedname),this.name=this.atlasLabelData.atlas.header.name,this.currentAtlas=this.name;var a=this.container.params.atlas;a&&a===this.transformedname&&(this.currentAtlas=this.transformedname),this.callback()},papaya.viewer.Atlas.prototype.parseDisplayColumns=function(){var a,b,c;if(this.atlasLabelData.atlas.header.display)for(this.displayColumns=[],a=0,b=this.atlasLabelData.atlas.header.display.split(papaya.viewer.Atlas.LABEL_SPLIT_REGEX),c=0;c<b.length;c+=1)"*"===b[c]&&(this.displayColumns[a]=c,a+=1)},papaya.viewer.Atlas.prototype.parseTransform=function(){var a,b,c;if(this.atlasLabelData.atlas.header.transform&&(a=this.atlasLabelData.atlas.header.transform.split(" "),this.transform=papaya.volume.Transform.IDENTITY.clone(),16===a.length))for(b=0;b<4;b+=1)for(c=0;c<4;c+=1)this.transform[b][c]=parseFloat(a[4*b+c])},papaya.viewer.Atlas.prototype.parseLabels=function(){var a,b,c;for(a=0;a<this.atlasLabelData.atlas.data.label.length;a+=1)c=this.atlasLabelData.atlas.data.label[a],b=c.index?parseInt(c.index,10):a,c.content?this.labels[b]=c.content:this.labels[b]=c},papaya.viewer.Atlas.prototype.formatLabels=function(a,b){var c,d,e,f;if(a)if(e=a.split(papaya.viewer.Atlas.LABEL_SPLIT_REGEX),this.displayColumns)for(c=0;c<e.length;c+=1)c<this.displayColumns.length&&(b[c]=e[this.displayColumns[c]]);else for(f=e.length,d=0,f>papaya.viewer.Atlas.MAX_LABELS&&(d=f-papaya.viewer.Atlas.MAX_LABELS),c=d;c<e.length;c+=1)b[c]=e[c].trim();else for(c=0;c<b.length;c+=1)b[c]="";return b},papaya.viewer.Atlas.prototype.findMaxLabelParts=function(){var a,b;if(this.displayColumns)return this.displayColumns.length;for(b=[],a=0;a<this.labels.length;a+=1)this.formatLabels(this.labels[a],b);return b.length};var papaya=papaya||{};papaya.viewer=papaya.viewer||{},papaya.viewer.ColorTable=papaya.viewer.ColorTable||function(a,b,c){var d=null;d=void 0!==c?c:papaya.viewer.ColorTable.findLUT(a),this.lutData=d.data,this.maxLUT=0,this.minLUT=0,this.knotThresholds=[],this.knotRangeRatios=[],this.LUTarrayG=new Array(256),this.LUTarrayR=new Array(256),this.LUTarrayB=new Array(256),this.isBaseImage=b,this.knotMin=this.lutData[0],this.knotMax=this.lutData[this.lutData.length-1],this.useGradation="undefined"==typeof d.gradation||d.gradation,this.updateLUT(papaya.viewer.ColorTable.LUT_MIN,papaya.viewer.ColorTable.LUT_MAX)},papaya.viewer.ColorTable.TABLE_GRAYSCALE={name:"Grayscale",data:[[0,0,0,0],[1,1,1,1]],gradation:!0},papaya.viewer.ColorTable.TABLE_SPECTRUM={name:"Spectrum",data:[[0,0,0,0],[.1,0,0,1],[.33,0,1,1],[.5,0,1,0],[.66,1,1,0],[.9,1,0,0],[1,1,1,1]],gradation:!0},papaya.viewer.ColorTable.TABLE_RED2YELLOW={name:"Overlay (Positives)",data:[[0,1,0,0],[1,1,1,0]],gradation:!0},papaya.viewer.ColorTable.TABLE_BLUE2GREEN={name:"Overlay (Negatives)",data:[[0,0,0,1],[1,0,1,0]],gradation:!0},papaya.viewer.ColorTable.TABLE_HOTANDCOLD={name:"Hot-and-Cold",data:[[0,0,0,1],[.15,0,1,1],[.3,0,1,0],[.45,0,0,0],[.5,0,0,0],[.55,0,0,0],[.7,1,1,0],[.85,1,0,0],[1,1,1,1]],gradation:!0},papaya.viewer.ColorTable.TABLE_GOLD={name:"Gold",data:[[0,0,0,0],[.13,.19,.03,0],[.25,.39,.12,0],[.38,.59,.26,0],[.5,.8,.46,.08],[.63,.99,.71,.21],[.75,.99,.88,.34],[.88,.99,.99,.48],[1,.9,.95,.61]],gradation:!0},papaya.viewer.ColorTable.TABLE_RED2WHITE={name:"Red Overlay",data:[[0,.75,0,0],[.5,1,.5,0],[.95,1,1,0],[1,1,1,1]],gradation:!0},papaya.viewer.ColorTable.TABLE_GREEN2WHITE={name:"Green Overlay",data:[[0,0,.75,0],[.5,.5,1,0],[.95,1,1,0],[1,1,1,1]],gradation:!0},papaya.viewer.ColorTable.TABLE_BLUE2WHITE={name:"Blue Overlay",data:[[0,0,0,1],[.5,0,.5,1],[.95,0,1,1],[1,1,1,1]],gradation:!0},papaya.viewer.ColorTable.TABLE_DTI_SPECTRUM={name:"Spectrum",data:[[0,1,0,0],[.5,0,1,0],[1,0,0,1]],gradation:!0},papaya.viewer.ColorTable.TABLE_FIRE={name:"Fire",data:[[0,0,0,0],[.06,0,0,.36],[.16,.29,0,.75],[.22,.48,0,.89],[.31,.68,0,.6],[.37,.76,0,.36],[.5,.94,.31,0],[.56,1,.45,0],[.81,1,.91,0],[.88,1,1,.38],[1,1,1,1]],gradation:!0},papaya.viewer.ColorTable.ARROW_ICON="data:image/gif;base64,R0lGODlhCwARAPfGMf//////zP//mf//Zv//M///AP/M///MzP/Mmf/MZv/MM//MAP+Z//+ZzP+Zmf+ZZv+ZM/+ZAP9m//9mzP9mmf9mZv9mM/9mAP8z//8zzP8zmf8zZv8zM/8zAP8A//8AzP8Amf8AZv8AM/8AAMz//8z/zMz/mcz/Zsz/M8z/AMzM/8zMzMzMmczMZszMM8zMAMyZ/8yZzMyZmcyZZsyZM8yZAMxm/8xmzMxmmcxmZsxmM8xmAMwz/8wzzMwzmcwzZswzM8wzAMwA/8wAzMwAmcwAZswAM8wAAJn//5n/zJn/mZn/Zpn/M5n/AJnM/5nMzJnMmZnMZpnMM5nMAJmZ/5mZzJmZmZmZZpmZM5mZAJlm/5lmzJlmmZlmZplmM5lmAJkz/5kzzJkzmZkzZpkzM5kzAJkA/5kAzJkAmZkAZpkAM5kAAGb//2b/zGb/mWb/Zmb/M2b/AGbM/2bMzGbMmWbMZmbMM2bMAGaZ/2aZzGaZmWaZZmaZM2aZAGZm/2ZmzGZmmWZmZmZmM2ZmAGYz/2YzzGYzmWYzZmYzM2YzAGYA/2YAzGYAmWYAZmYAM2YAADP//zP/zDP/mTP/ZjP/MzP/ADPM/zPMzDPMmTPMZjPMMzPMADOZ/zOZzDOZmTOZZjOZMzOZADNm/zNmzDNmmTNmZjNmMzNmADMz/zMzzDMzmTMzZjMzMzMzADMA/zMAzDMAmTMAZjMAMzMAAAD//wD/zAD/mQD/ZgD/MwD/AADM/wDMzADMmQDMZgDMMwDMAACZ/wCZzACZmQCZZgCZMwCZAABm/wBmzABmmQBmZgBmMwBmAAAz/wAzzAAzmQAzZgAzMwAzAAAA/wAAzAAAmQAAZgAAM+4AAN0AALsAAKoAAIgAAHcAAFUAAEQAACIAABEAAADuAADdAAC7AACqAACIAAB3AABVAABEAAAiAAARAAAA7gAA3QAAuwAAqgAAiAAAdwAAVQAARAAAIgAAEe7u7t3d3bu7u6qqqoiIiHd3d1VVVURERCIiIhEREQAAACH5BAEAAMYALAAAAAALABEAAAg/AI0JFGhvoEGC+vodRKgv4UF7DSMqZBixoUKIFSv2w5jRIseOGztK/JgxpMiEJDWmHHkSZUuTIvvt60ezps2AADs=",papaya.viewer.ColorTable.ARROW_ICON_WIDTH=11,papaya.viewer.ColorTable.DEFAULT_COLOR_TABLE=papaya.viewer.ColorTable.TABLE_GRAYSCALE,papaya.viewer.ColorTable.PARAMETRIC_COLOR_TABLES=[papaya.viewer.ColorTable.TABLE_RED2YELLOW,papaya.viewer.ColorTable.TABLE_BLUE2GREEN],papaya.viewer.ColorTable.OVERLAY_COLOR_TABLES=[papaya.viewer.ColorTable.TABLE_RED2WHITE,papaya.viewer.ColorTable.TABLE_GREEN2WHITE,papaya.viewer.ColorTable.TABLE_BLUE2WHITE],papaya.viewer.ColorTable.TABLE_ALL=[papaya.viewer.ColorTable.TABLE_GRAYSCALE,papaya.viewer.ColorTable.TABLE_SPECTRUM,papaya.viewer.ColorTable.TABLE_FIRE,papaya.viewer.ColorTable.TABLE_HOTANDCOLD,papaya.viewer.ColorTable.TABLE_GOLD,papaya.viewer.ColorTable.TABLE_RED2YELLOW,papaya.viewer.ColorTable.TABLE_BLUE2GREEN,papaya.viewer.ColorTable.TABLE_RED2WHITE,papaya.viewer.ColorTable.TABLE_GREEN2WHITE,papaya.viewer.ColorTable.TABLE_BLUE2WHITE],papaya.viewer.ColorTable.LUT_MIN=0,papaya.viewer.ColorTable.LUT_MAX=255,papaya.viewer.ColorTable.ICON_SIZE=18,papaya.viewer.ColorTable.COLOR_BAR_WIDTH=100,papaya.viewer.ColorTable.COLOR_BAR_HEIGHT=15,papaya.viewer.ColorTable.findLUT=function(a){var b;for(b=0;b<papaya.viewer.ColorTable.TABLE_ALL.length;b+=1)if(papaya.viewer.ColorTable.TABLE_ALL[b].name==a)return papaya.viewer.ColorTable.TABLE_ALL[b];return papaya.viewer.ColorTable.TABLE_GRAYSCALE},papaya.viewer.ColorTable.addCustomLUT=function(a){papaya.viewer.ColorTable.findLUT(a.name).data===papaya.viewer.ColorTable.TABLE_GRAYSCALE.data&&papaya.viewer.ColorTable.TABLE_ALL.push(a)},papaya.viewer.ColorTable.prototype.updateMinLUT=function(a){this.updateLUT(a,this.maxLUT)},papaya.viewer.ColorTable.prototype.updateMaxLUT=function(a){this.updateLUT(this.minLUT,a)},papaya.viewer.ColorTable.prototype.updateLUT=function(a,b){var c,d,e,f;for(this.maxLUT=b,this.minLUT=a,c=this.maxLUT-this.minLUT,d=0;d<this.lutData.length;d+=1)this.knotThresholds[d]=this.lutData[d][0]*c+this.minLUT;for(d=0;d<this.lutData.length-1;d+=1)this.knotRangeRatios[d]=papaya.viewer.ColorTable.LUT_MAX/(this.knotThresholds[d+1]-this.knotThresholds[d]);for(d=0;d<256;d+=1)if(d<=this.minLUT)this.LUTarrayR[d]=this.knotMin[1]*papaya.viewer.ColorTable.LUT_MAX,this.LUTarrayG[d]=this.knotMin[2]*papaya.viewer.ColorTable.LUT_MAX,this.LUTarrayB[d]=this.knotMin[3]*papaya.viewer.ColorTable.LUT_MAX;else if(d>this.maxLUT)this.LUTarrayR[d]=this.knotMax[1]*papaya.viewer.ColorTable.LUT_MAX,this.LUTarrayG[d]=this.knotMax[2]*papaya.viewer.ColorTable.LUT_MAX,this.LUTarrayB[d]=this.knotMax[3]*papaya.viewer.ColorTable.LUT_MAX;else for(e=0;e<this.lutData.length-1;e+=1)d>this.knotThresholds[e]&&d<=this.knotThresholds[e+1]&&(this.useGradation?(f=((d-this.knotThresholds[e])*this.knotRangeRatios[e]+.5)/papaya.viewer.ColorTable.LUT_MAX,this.LUTarrayR[d]=((1-f)*this.lutData[e][1]+f*this.lutData[e+1][1])*papaya.viewer.ColorTable.LUT_MAX,this.LUTarrayG[d]=((1-f)*this.lutData[e][2]+f*this.lutData[e+1][2])*papaya.viewer.ColorTable.LUT_MAX,this.LUTarrayB[d]=((1-f)*this.lutData[e][3]+f*this.lutData[e+1][3])*papaya.viewer.ColorTable.LUT_MAX):(this.LUTarrayR[d]=this.lutData[e][1]*papaya.viewer.ColorTable.LUT_MAX,this.LUTarrayG[d]=this.lutData[e][2]*papaya.viewer.ColorTable.LUT_MAX,this.LUTarrayB[d]=this.lutData[e][3]*papaya.viewer.ColorTable.LUT_MAX))},papaya.viewer.ColorTable.prototype.lookupRed=function(a){return a>=0&&a<256?255&this.LUTarrayR[a]:0},papaya.viewer.ColorTable.prototype.lookupGreen=function(a){return a>=0&&a<256?255&this.LUTarrayG[a]:0},papaya.viewer.ColorTable.prototype.lookupBlue=function(a){return a>=0&&a<256?255&this.LUTarrayB[a]:0};var papaya=papaya||{};papaya.viewer=papaya.viewer||{},papaya.viewer.Display=papaya.viewer.Display||function(a,b){this.container=a,this.viewer=a.viewer,this.canvas=document.createElement("canvas"),this.canvas.width=b,this.canvas.height=papaya.viewer.Display.SIZE,this.context=this.canvas.getContext("2d"),this.canvas.style.padding=0,this.canvas.style.margin=0,this.canvas.style.border="none",this.canvas.style.cursor="default",this.tempCoord=new papaya.core.Coordinate(0,0,0),this.drawingError=!1,this.progress=0,this.progressStartTime=0,this.progressTimeout=null,this.drawingProgress=!1,this.errorMessage="",this.drawUninitializedDisplay()},papaya.viewer.Display.SIZE=50,papaya.viewer.Display.MINI_LABELS_THRESH=700,papaya.viewer.Display.PADDING=8,papaya.viewer.Display.FONT_COLOR_WHITE="white",papaya.viewer.Display.FONT_COLOR_ORANGE="rgb(182, 59, 0)",papaya.viewer.Display.FONT_SIZE_COORDINATE_LABEL=12,papaya.viewer.Display.FONT_COLOR_COORDINATE_LABEL=papaya.viewer.Display.FONT_COLOR_WHITE,papaya.viewer.Display.FONT_TYPE_COORDINATE_LABEL="sans-serif",papaya.viewer.Display.FONT_SIZE_COORDINATE_VALUE=18,papaya.viewer.Display.FONT_COLOR_COORDINATE_VALUE=papaya.viewer.Display.FONT_COLOR_ORANGE,papaya.viewer.Display.FONT_TYPE_COORDINATE_VALUE="sans-serif",papaya.viewer.Display.PRECISION_COORDINATE_VALUE=5,papaya.viewer.Display.PRECISION_COORDINATE_MAX=12,papaya.viewer.Display.FONT_SIZE_IMAGE_VALUE=20,papaya.viewer.Display.FONT_COLOR_IMAGE_VALUE=papaya.viewer.Display.FONT_COLOR_WHITE,papaya.viewer.Display.FONT_TYPE_IMAGE_VALUE="sans-serif",papaya.viewer.Display.PRECISION_IMAGE_VALUE=9,papaya.viewer.Display.PRECISION_IMAGE_MAX=14,papaya.viewer.Display.FONT_SIZE_ATLAS_MINI=14,papaya.viewer.Display.FONT_SIZE_ATLAS=20,papaya.viewer.Display.FONT_TYPE_ATLAS="sans-serif",papaya.viewer.Display.FONT_SIZE_MESSAGE_VALUE=20,papaya.viewer.Display.FONT_TYPE_MESSAGE_VALUE="sans-serif",papaya.viewer.Display.FONT_COLOR_MESSAGE="rgb(200, 75, 25)",papaya.viewer.Display.PROGRESS_LABEL_SUFFIX=["...","",".",".."],papaya.viewer.Display.PROGRESS_LABEL_DEFAULT="Loading",papaya.viewer.Display.prototype.drawUninitializedDisplay=function(){this.context.fillStyle="#000000",this.context.fillRect(0,0,this.canvas.width,this.canvas.height)},papaya.viewer.Display.prototype.canDraw=function(){return!(this.drawingError||this.drawingProgress)},papaya.viewer.Display.prototype.drawEmptyDisplay=function(){this.canDraw()?(this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.fillStyle="#000000",this.context.fillRect(0,0,this.canvas.width,this.canvas.height)):this.drawError&&this.drawError(this.errorMessage)},papaya.viewer.Display.prototype.drawDisplay=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;if(this.canDraw()){if(m=this.viewer.canvas.width/600,p=this.viewer.canvas.width/2,q=p/5,g=this.canvas.height,r=p<300,"Mouse"!==this.container.preferences.atlasLocks&&(a=this.viewer.currentCoord.x,b=this.viewer.currentCoord.y,c=this.viewer.currentCoord.z),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.fillStyle="#000000",this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.fillStyle=papaya.viewer.Display.FONT_COLOR_COORDINATE_LABEL,this.context.font=papaya.viewer.Display.FONT_SIZE_COORDINATE_LABEL+"px "+papaya.viewer.Display.FONT_TYPE_COORDINATE_LABEL,d=papaya.viewer.Display.FONT_SIZE_COORDINATE_LABEL+.75*papaya.viewer.Display.PADDING,this.context.fillText("x",1.5*papaya.viewer.Display.PADDING,d),this.context.fillText("y",1.5*papaya.viewer.Display.PADDING+q,d),this.context.fillText("z",1.5*papaya.viewer.Display.PADDING+2*q,d),d+=papaya.viewer.Display.FONT_SIZE_COORDINATE_VALUE+papaya.viewer.Display.PADDING/2,this.context.fillStyle=papaya.viewer.Display.FONT_COLOR_COORDINATE_VALUE,this.context.font=papaya.viewer.Display.FONT_SIZE_COORDINATE_VALUE-(r?2:0)+"px "+papaya.viewer.Display.FONT_TYPE_COORDINATE_VALUE,this.viewer.worldSpace?(f=this.viewer.screenVolumes[0].volume.header.origin,n=this.viewer.screenVolumes[0].volume.header.voxelDimensions,s=Math.min(papaya.viewer.Display.PRECISION_COORDINATE_MAX,Math.round(papaya.viewer.Display.PRECISION_COORDINATE_VALUE*m)),this.context.fillText(parseFloat(((a-f.x)*n.xSize).toString().substr(0,s)),1.5*papaya.viewer.Display.PADDING,d),this.context.fillText(parseFloat(((f.y-b)*n.ySize).toString().substr(0,s)),1.5*papaya.viewer.Display.PADDING+q,d),this.context.fillText(parseFloat(((f.z-c)*n.zSize).toString().substr(0,s)),1.5*papaya.viewer.Display.PADDING+2*q,d),$(".posX").text(parseFloat(((a-f.x)*n.xSize).toString().substr(0,s))),$(".posY").text(parseFloat(((f.y-b)*n.ySize).toString().substr(0,s))),$(".posZ").text(parseFloat(((f.z-c)*n.zSize).toString().substr(0,s)))):(this.context.fillText(Math.round(a).toString(),1.5*papaya.viewer.Display.PADDING,d),this.context.fillText(Math.round(b).toString(),1.5*papaya.viewer.Display.PADDING+q,d),this.context.fillText(Math.round(c).toString(),1.5*papaya.viewer.Display.PADDING+2*q,d),$(".posX").text(Math.round(a).toString()),$(".posY").text(Math.round(b).toString()),$(".posZ").text(Math.round(c).toString())),this.viewer.currentScreenVolume.rgb||this.viewer.currentScreenVolume.dti||(e=this.viewer.getCurrentValueAt(a,b,c),this.canvas.currentval=e.toString(),d=g/2+papaya.viewer.Display.FONT_SIZE_IMAGE_VALUE/2-papaya.viewer.Display.PADDING/2,this.context.fillStyle=papaya.viewer.Display.FONT_COLOR_IMAGE_VALUE,this.context.font=papaya.viewer.Display.FONT_SIZE_IMAGE_VALUE-(r?2:0)+"px "+papaya.viewer.Display.FONT_TYPE_IMAGE_VALUE,s=Math.min(papaya.viewer.Display.PRECISION_IMAGE_MAX,Math.round(papaya.viewer.Display.PRECISION_IMAGE_VALUE*m)),this.context.fillText(parseFloat(e.toString().substr(0,s)),2*papaya.viewer.Display.PADDING+3*q,d),$(".value").text(parseFloat(e.toString().substr(0,s)))),this.viewer.atlas&&this.viewer.atlas.volume.isLoaded)if(this.viewer.getWorldCoordinateAtIndex(a,b,c,this.tempCoord),j=this.viewer.atlas.getLabelAtCoordinate(this.tempCoord.x,this.tempCoord.y,this.tempCoord.z),h=j.length,o=Math.ceil(this.viewer.atlas.maxLabels/2),p<300&&h>=2)for(i=.75*p,k=h-1;k>=0;k-=1)k===h-2?(this.context.fillStyle=papaya.viewer.Display.FONT_COLOR_ORANGE,this.context.font=papaya.viewer.Display.FONT_SIZE_ATLAS_MINI+"px "+papaya.viewer.Display.FONT_TYPE_ATLAS):(this.context.fillStyle=papaya.viewer.Display.FONT_COLOR_WHITE,this.context.font=papaya.viewer.Display.FONT_SIZE_ATLAS_MINI+"px "+papaya.viewer.Display.FONT_TYPE_ATLAS),l=this.context.measureText(j[k]),l.width>i-2*papaya.viewer.Display.PADDING&&(j[k]=j[k].substr(0,Math.round(j[k].length/3))+" ... "+j[k].substr(j[k].length-3,3)),k===h-2?this.context.fillText(j[k],p+.25*p,1.5*papaya.viewer.Display.PADDING+papaya.viewer.Display.FONT_SIZE_ATLAS_MINI/2):k===h-1&&this.context.fillText(j[k],p+.25*p,papaya.viewer.Display.PADDING+g/2+papaya.viewer.Display.FONT_SIZE_ATLAS_MINI/2);else if(p<600&&h>2)for(i=p/2,k=h-1;k>=0;k-=1)k<o?(this.context.fillStyle=papaya.viewer.Display.FONT_COLOR_ORANGE,this.context.font=papaya.viewer.Display.FONT_SIZE_ATLAS_MINI+"px "+papaya.viewer.Display.FONT_TYPE_ATLAS):(this.context.fillStyle=papaya.viewer.Display.FONT_COLOR_WHITE,this.context.font=papaya.viewer.Display.FONT_SIZE_ATLAS_MINI+"px "+papaya.viewer.Display.FONT_TYPE_ATLAS),l=this.context.measureText(j[k]),l.width>i-6*papaya.viewer.Display.PADDING&&(j[k]=j[k].substr(0,Math.round(j[k].length/3))+" ... "+j[k].substr(j[k].length-3,3)),0===k?this.context.fillText(j[k],p+5*papaya.viewer.Display.PADDING,1.5*papaya.viewer.Display.PADDING+papaya.viewer.Display.FONT_SIZE_ATLAS_MINI/2):1===k?this.context.fillText(j[k],p+5*papaya.viewer.Display.PADDING,papaya.viewer.Display.PADDING+g/2+papaya.viewer.Display.FONT_SIZE_ATLAS_MINI/2):2===k?this.context.fillText(j[k],1.5*p+5*papaya.viewer.Display.PADDING,1.5*papaya.viewer.Display.PADDING+papaya.viewer.Display.FONT_SIZE_ATLAS_MINI/2):3===k&&this.context.fillText(j[k],1.5*p+5*papaya.viewer.Display.PADDING,papaya.viewer.Display.PADDING+g/2+papaya.viewer.Display.FONT_SIZE_ATLAS_MINI/2);else if(p<800&&h>3)for(i=p/3,k=0;k<4;k+=1)k<2?(k<o?(this.context.fillStyle=papaya.viewer.Display.FONT_COLOR_ORANGE,this.context.font=papaya.viewer.Display.FONT_SIZE_ATLAS_MINI+"px "+papaya.viewer.Display.FONT_TYPE_ATLAS):(this.context.fillStyle=papaya.viewer.Display.FONT_COLOR_WHITE,this.context.font=papaya.viewer.Display.FONT_SIZE_ATLAS_MINI+"px "+papaya.viewer.Display.FONT_TYPE_ATLAS),l=this.context.measureText(j[k]),l.width>i-6*papaya.viewer.Display.PADDING&&(j[k]=j[k].substr(0,Math.round(j[k].length/3))+" ... "+j[k].substr(j[k].length-3,3)),0===k?this.context.fillText(j[k],p+5*papaya.viewer.Display.PADDING,1.5*papaya.viewer.Display.PADDING+papaya.viewer.Display.FONT_SIZE_ATLAS_MINI/2):1===k?this.context.fillText(j[k],p+5*papaya.viewer.Display.PADDING,papaya.viewer.Display.PADDING+g/2+papaya.viewer.Display.FONT_SIZE_ATLAS_MINI/2):2===k?this.context.fillText(j[k],1.5*p+5*papaya.viewer.Display.PADDING,1.5*papaya.viewer.Display.PADDING+papaya.viewer.Display.FONT_SIZE_ATLAS_MINI/2):3===k&&this.context.fillText(j[k],1.5*p+5*papaya.viewer.Display.PADDING,papaya.viewer.Display.PADDING+g/2+papaya.viewer.Display.FONT_SIZE_ATLAS_MINI/2)):(d=g/2+papaya.viewer.Display.FONT_SIZE_ATLAS/2-papaya.viewer.Display.PADDING/2,k<o?(this.context.fillStyle=papaya.viewer.Display.FONT_COLOR_ORANGE,this.context.font=papaya.viewer.Display.FONT_SIZE_ATLAS+"px "+papaya.viewer.Display.FONT_TYPE_ATLAS):(this.context.fillStyle=papaya.viewer.Display.FONT_COLOR_WHITE,this.context.font=papaya.viewer.Display.FONT_SIZE_ATLAS+"px "+papaya.viewer.Display.FONT_TYPE_ATLAS),l=this.context.measureText(j[k]),l.width>i-2*papaya.viewer.Display.PADDING&&(j[k]=j[k].substr(0,Math.round(j[k].length/3))+" ... "+j[k].substr(j[k].length-3,3)),2===k?this.context.fillText(j[k],p+papaya.viewer.Display.PADDING+i,d):3===k&&this.context.fillText(j[k],p+papaya.viewer.Display.PADDING+2*i,d));else for(i=p/h,d=g/2+papaya.viewer.Display.FONT_SIZE_ATLAS/2-papaya.viewer.Display.PADDING/2,k=0;k<h;k+=1)k<o?(this.context.fillStyle=papaya.viewer.Display.FONT_COLOR_ORANGE,this.context.font=papaya.viewer.Display.FONT_SIZE_ATLAS-(r?4:0)+"px "+papaya.viewer.Display.FONT_TYPE_ATLAS):(this.context.fillStyle=papaya.viewer.Display.FONT_COLOR_WHITE,this.context.font=papaya.viewer.Display.FONT_SIZE_ATLAS-(r?4:0)+"px "+papaya.viewer.Display.FONT_TYPE_ATLAS),l=this.context.measureText(j[k]),l.width>i-2*papaya.viewer.Display.PADDING-.05*p*Math.max(0,3-h)&&(j[k]=j[k].substr(0,Math.round(j[k].length/3))+" ... "+j[k].substr(j[k].length-3,3)),this.context.fillText(j[k],p+papaya.viewer.Display.PADDING+.05*p*Math.max(0,3-h)+k*i,d)}else this.drawError&&this.drawError(this.errorMessage)},papaya.viewer.Display.prototype.drawError=function(a){var b,c;this.errorMessage=a,this.drawingError=!0,c=this,window.setTimeout(papaya.utilities.ObjectUtils.bind(c,function(){c.drawingError=!1}),3e3),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.fillStyle="#000000",this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.fillStyle="red",this.context.font=papaya.viewer.Display.FONT_SIZE_MESSAGE_VALUE+"px "+papaya.viewer.Display.FONT_TYPE_MESSAGE_VALUE,b=papaya.viewer.Display.FONT_SIZE_COORDINATE_LABEL+papaya.viewer.Display.PADDING+1.5*papaya.viewer.Display.PADDING,this.context.fillText(a,papaya.viewer.Display.PADDING,b)},papaya.viewer.Display.prototype.drawProgress=function(a,b){var c,d,e,f,g,h;c=Math.round(1e3*a),c>this.progress&&(this.progress=c,h=void 0!==b?b:papaya.viewer.Display.PROGRESS_LABEL_DEFAULT,0===this.progressStartTime?(this.progressStartTime=(new Date).getTime(),e=this.progressStartTime):e=(new Date).getTime(),f=parseInt((e-this.progressStartTime)/500,10)%4,this.progress>=990?(this.progressTimeout&&(window.clearTimeout(this.progressTimeout),this.progressTimeout=null),this.drawingProgress=!1,this.progress=0,this.progressStartTime=0,this.drawEmptyDisplay()):(this.progressTimeout&&window.clearTimeout(this.progressTimeout),d=this,this.progressTimeout=window.setTimeout(papaya.utilities.ObjectUtils.bind(d,function(){d.drawingProgress=!1}),3e3),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.fillStyle="#fff",this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.fillStyle="#000",this.context.fillRect(0,0,this.canvas.width*a,this.canvas.height),this.context.font=papaya.viewer.Display.FONT_SIZE_MESSAGE_VALUE+"px "+papaya.viewer.Display.FONT_TYPE_MESSAGE_VALUE,this.context.fillStyle=papaya.viewer.Display.FONT_COLOR_MESSAGE,g=papaya.viewer.Display.FONT_SIZE_COORDINATE_LABEL+papaya.viewer.Display.PADDING+1.5*papaya.viewer.Display.PADDING,this.context.fillText(h+papaya.viewer.Display.PROGRESS_LABEL_SUFFIX[f],2*papaya.viewer.Display.PADDING,g)))};var papaya=papaya||{};papaya.volume=papaya.volume||{},papaya.viewer.Preferences=papaya.viewer.Preferences||function(){this.viewer=null,this.showCrosshairs=papaya.viewer.Preferences.DEFAULT_SHOW_CROSSHAIRS,this.atlasLocks=papaya.viewer.Preferences.DEFAULT_ATLAS_LOCKS,this.showOrientation=papaya.viewer.Preferences.DEFAULT_SHOW_ORIENTATION,this.scrollBehavior=papaya.viewer.Preferences.DEFAULT_SCROLL,this.smoothDisplay=papaya.viewer.Preferences.DEFAULT_SMOOTH_DISPLAY,this.radiological=papaya.viewer.Preferences.DEFAULT_RADIOLOGICAL,this.showRuler=papaya.viewer.Preferences.DEFAULT_SHOW_RULER,this.surfaceBackgroundColor=papaya.viewer.Preferences.DEFAULT_SURFACE_BACKGROUND_COLOR,this.showSurfacePlanes=papaya.viewer.Preferences.DEFAULT_SHOW_SURFACE_PLANES,this.showSurfaceCrosshairs=papaya.viewer.Preferences.DEFAULT_SHOW_SURFACE_CROSSHAIRS},papaya.viewer.Preferences.ALL_PREFS=["showCrosshairs","atlasLocks","showOrientation","scrollBehavior","smoothDisplay","radiological","showRuler","surfaceBackgroundColor","showSurfacePlanes"],papaya.viewer.Preferences.COOKIE_PREFIX="papaya-",papaya.viewer.Preferences.COOKIE_EXPIRY_DAYS=365,papaya.viewer.Preferences.DEFAULT_SHOW_CROSSHAIRS="Yes",papaya.viewer.Preferences.DEFAULT_ATLAS_LOCKS="Mouse",papaya.viewer.Preferences.DEFAULT_SHOW_ORIENTATION="No",papaya.viewer.Preferences.DEFAULT_SCROLL="Increment Slice",papaya.viewer.Preferences.DEFAULT_SMOOTH_DISPLAY="Yes",papaya.viewer.Preferences.DEFAULT_RADIOLOGICAL="No",papaya.viewer.Preferences.DEFAULT_SHOW_RULER="No",papaya.viewer.Preferences.DEFAULT_SURFACE_BACKGROUND_COLOR="Gray",papaya.viewer.Preferences.DEFAULT_SHOW_SURFACE_PLANES="Yes",papaya.viewer.Preferences.prototype.updatePreference=function(a,b){this[a]=b,this.viewer.drawViewer(!0),papaya.utilities.UrlUtils.createCookie(papaya.viewer.Preferences.COOKIE_PREFIX+a,b,papaya.viewer.Preferences.COOKIE_EXPIRY_DAYS)},papaya.viewer.Preferences.prototype.readPreferences=function(){var a,b;for(a=0;a<papaya.viewer.Preferences.ALL_PREFS.length;a+=1)b=papaya.utilities.UrlUtils.readCookie(papaya.viewer.Preferences.COOKIE_PREFIX+papaya.viewer.Preferences.ALL_PREFS[a]),b&&(this[papaya.viewer.Preferences.ALL_PREFS[a]]=b)};var papaya=papaya||{};papaya.viewer=papaya.viewer||{},papaya.viewer.ScreenSlice=papaya.viewer.ScreenSlice||function(a,b,c,d,e,f,g,h){this.screenVolumes=g,this.sliceDirection=b,this.currentSlice=-1,this.xDim=c,this.yDim=d,this.xSize=e,this.ySize=f,this.canvasMain=document.createElement("canvas"),this.canvasMain.width=this.xDim,this.canvasMain.height=this.yDim,this.contextMain=this.canvasMain.getContext("2d"),this.imageDataDraw=this.contextMain.createImageData(this.xDim,this.yDim),this.screenOffsetX=0,this.screenOffsetY=0,this.screenDim=0,this.screenTransform=[[1,0,0],[0,1,0],[0,0,1]],this.zoomTransform=[[1,0,0],[0,1,0],[0,0,1]],this.finalTransform=[[1,0,0],[0,1,0],[0,0,1]],this.radiologicalTransform=[[-1,0,this.xDim],[0,1,0],[0,0,1]],this.tempTransform=[[1,0,0],[0,1,0],[0,0,1]],this.tempTransform2=[[1,0,0],[0,1,0],[0,0,1]],this.screenTransform2=[[1,0,0],[0,1,0],[0,0,1]],this.finalTransform2=[[1,0,0],[0,1,0],[0,0,1]],this.imageData=[],this.imageData2=[],this.manager=h,this.rulerPoints=[new papaya.core.Point(parseInt(.25*c),parseInt(.25*d)),new papaya.core.Point(parseInt(.75*c),parseInt(.75*d))],this.tempPoint=new papaya.core.Point,this.canvasDTILines=null,this.contextDTILines=null},papaya.viewer.ScreenSlice.DIRECTION_UNKNOWN=0,papaya.viewer.ScreenSlice.DIRECTION_AXIAL=1,papaya.viewer.ScreenSlice.DIRECTION_CORONAL=2,papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL=3,papaya.viewer.ScreenSlice.DIRECTION_TEMPORAL=4,papaya.viewer.ScreenSlice.DIRECTION_SURFACE=5,papaya.viewer.ScreenSlice.SCREEN_PIXEL_MAX=255,papaya.viewer.ScreenSlice.SCREEN_PIXEL_MIN=0,papaya.viewer.ScreenSlice.GRAB_RADIUS=5,papaya.viewer.ScreenSlice.DTI_COLORS=["#ff0000","#00ff00","#0000ff"],papaya.viewer.ScreenSlice.prototype.updateSlice=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q=!1,R=0,S=!1,T=this.manager.isWorldMode();if(a=Math.round(a),N=this.manager.isRadiologicalMode()&&this.isRadiologicalSensitive()?-1:1,b||this.currentSlice!==a){for(this.currentSlice=a,c=this.screenVolumes[0].volume.header.origin,d=this.screenVolumes[0].volume.header.voxelDimensions,this.contextMain.clearRect(0,0,this.canvasMain.width,this.canvasMain.height),this.contextDTILines&&this.contextDTILines.clearRect(0,0,this.screenDim,this.screenDim),this.imageData.length<this.screenVolumes.length&&(this.imageData=papaya.utilities.ArrayUtils.createArray(this.screenVolumes.length,this.xDim*this.yDim),this.imageData2=papaya.utilities.ArrayUtils.createArray(this.screenVolumes.length,1)),e=0;e<this.screenVolumes.length;e+=1)if(!this.screenVolumes[e].hidden){for(l=this.screenVolumes[e].currentTimepoint,m=this.screenVolumes[e].rgb,n=this.screenVolumes[e].dti,p=this.screenVolumes[e].dtiLines,S|=!p,G=this.screenVolumes[e].dtiColors,M=this.screenVolumes[e].dtiAlphaFactor,O=0===e||this.screenVolumes[e].interpolation,O&="Yes"===this.manager.container.preferences.smoothDisplay,p&&(this.updateDTILinesImage(),this.contextDTILines.lineWidth=1,G||(this.contextDTILines.strokeStyle=papaya.viewer.ScreenSlice.DTI_COLORS[R],R+=1,R%=3,this.contextDTILines.beginPath())),f=0;f<this.yDim;f+=1)for(g=0;g<this.xDim;g+=1){var U=this.xDim-g-1;h=0,i=255,k=this.screenVolumes[e].alpha,m?(this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?h=this.screenVolumes[e].volume.getVoxelAtIndex(g,f,a,l,!0):this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?h=this.screenVolumes[e].volume.getVoxelAtIndex(g,a,f,l,!0):this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&(h=this.screenVolumes[e].volume.getVoxelAtIndex(a,g,f,l,!0)),j=4*(f*this.xDim+g),this.imageData[e][j]=h,this.imageDataDraw.data[j]=h>>16&255,this.imageDataDraw.data[j+1]=h>>8&255,this.imageDataDraw.data[j+2]=255&h,this.imageDataDraw.data[j+3]=i):n?(T?(this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?(H=(g-c.x)*d.xSize,I=(c.y-f)*d.ySize,J=(c.z-a)*d.zSize):this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?(H=(g-c.x)*d.xSize,I=(c.y-a)*d.ySize,J=(c.z-f)*d.zSize):this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&(H=(a-c.x)*d.xSize,I=(c.y-g)*d.ySize,J=(c.z-f)*d.zSize),A=this.screenVolumes[e].volume.getVoxelAtCoordinate(H,I,J,0,!O),B=this.screenVolumes[e].volume.getVoxelAtCoordinate(H,I,J,1,!O),C=this.screenVolumes[e].volume.getVoxelAtCoordinate(H,I,J,2,!O),this.screenVolumes[e].dtiVolumeMod&&(k=Math.min(1,this.screenVolumes[e].dtiVolumeMod.getVoxelAtCoordinate(H,I,J,0,!O)))):(this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?(H=g*d.xSize,I=f*d.ySize,J=a*d.zSize):this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?(H=g*d.xSize,I=a*d.ySize,J=f*d.zSize):this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&(H=a*d.xSize,I=g*d.ySize,J=f*d.zSize),A=this.screenVolumes[e].volume.getVoxelAtMM(H,I,J,0,!O),B=this.screenVolumes[e].volume.getVoxelAtMM(H,I,J,1,!O),C=this.screenVolumes[e].volume.getVoxelAtMM(H,I,J,2,!O),this.screenVolumes[e].dtiVolumeMod&&(k=Math.min(1,this.screenVolumes[e].dtiVolumeMod.getVoxelAtMM(H,I,J,0,!O)))),j=4*(f*this.xDim+g),p?0!==A||0!==B||0!==C?(this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?(D=Math.atan2(N*B,A),L=Math.acos(Math.abs(C)/Math.sqrt(A*A+B*B+C*C))):this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?(D=Math.atan2(N*C,A),L=Math.acos(Math.abs(B)/Math.sqrt(A*A+B*B+C*C))):this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&(D=Math.atan2(C,B),L=Math.acos(Math.abs(A)/Math.sqrt(A*A+B*B+C*C))),L=1-L/1.5708,A=papayaRoundFast(Math.abs(255*A)),B=papayaRoundFast(Math.abs(255*B)),C=papayaRoundFast(Math.abs(255*C)),o=papayaRoundFast(255*k),
h=(255&o)<<24|(255&A)<<16|(255&B)<<8|255&C,G&&(this.contextDTILines.beginPath(),K=16777215&h,this.contextDTILines.strokeStyle="#"+papaya.utilities.StringUtils.pad(K.toString(16),6)),this.imageData[e][j]=D,this.imageData2[e][j]=h,E=Math.sin(D),F=Math.cos(D),y=this.finalTransform2[0][2]+(g+.5)*this.finalTransform2[0][0],z=this.finalTransform2[1][2]+(f+.5)*this.finalTransform2[1][1],q=this.finalTransform2[0][2]+(g+.5*L)*this.finalTransform2[0][0],r=this.finalTransform2[1][2]+(f+.5)*this.finalTransform2[1][1],u=F*(q-y)-E*(r-z)+y,v=E*(q-y)+F*(r-z)+z,this.contextDTILines.moveTo(u,v),s=this.finalTransform2[0][2]+(g+1-.5*L)*this.finalTransform2[0][0],t=this.finalTransform2[1][2]+(f+.5)*this.finalTransform2[1][1],w=F*(s-y)-E*(t-z)+y,x=E*(s-y)+F*(t-z)+z,this.contextDTILines.lineTo(w,x),G&&this.contextDTILines.stroke()):this.imageData[e][j]=Number.NaN:(k=0!==A||0!==B||0!==C?1-(1-k)*M:0,A=papayaRoundFast(Math.abs(255*A)),B=papayaRoundFast(Math.abs(255*B)),C=papayaRoundFast(Math.abs(255*C)),o=papayaRoundFast(255*k),this.imageData[e][j]=(255&o)<<24|(255&A)<<16|(255&B)<<8|255&C,Q?(this.imageDataDraw.data[j]=this.imageDataDraw.data[j]*(1-k)+(255&A)*k,this.imageDataDraw.data[j+1]=this.imageDataDraw.data[j+1]*(1-k)+(255&B)*k,this.imageDataDraw.data[j+2]=this.imageDataDraw.data[j+2]*(1-k)+(255&C)*k,this.imageDataDraw.data[j+3]=i):(this.imageDataDraw.data[j]=255&A,this.imageDataDraw.data[j+1]=255&B,this.imageDataDraw.data[j+2]=255&C,this.imageDataDraw.data[j+3]=255&o))):(T?this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?h=this.screenVolumes[e].volume.getVoxelAtCoordinate((U-c.x)*d.xSize,(c.y-f)*d.ySize,(c.z-a)*d.zSize,l,!O):this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?h=this.screenVolumes[e].volume.getVoxelAtCoordinate((U-c.x)*d.xSize,(c.y-a)*d.ySize,(c.z-f)*d.zSize,l,!O):this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&(h=this.screenVolumes[e].volume.getVoxelAtCoordinate((a-c.x)*d.xSize,(c.y-g)*d.ySize,(c.z-f)*d.zSize,l,!O)):this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?h=this.screenVolumes[e].volume.getVoxelAtMM(U*d.xSize,f*d.ySize,a*d.zSize,l,!O):this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?h=this.screenVolumes[e].volume.getVoxelAtMM(U*d.xSize,a*d.ySize,f*d.zSize,l,!O):this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&(h=this.screenVolumes[e].volume.getVoxelAtMM(a*d.xSize,g*d.ySize,f*d.zSize,l,!O)),j=4*(f*this.xDim+g),P=h,this.imageData[e][j]=h,!this.screenVolumes[e].negative&&h<=this.screenVolumes[e].screenMin||this.screenVolumes[e].negative&&h>=this.screenVolumes[e].screenMin||isNaN(h)?(h=papaya.viewer.ScreenSlice.SCREEN_PIXEL_MIN,i=this.screenVolumes[e].isOverlay()?0:255):h=this.screenVolumes[e].negative&&h<=this.screenVolumes[e].screenMax?papaya.viewer.ScreenSlice.SCREEN_PIXEL_MAX:!this.screenVolumes[e].negative&&h>=this.screenVolumes[e].screenMax?papaya.viewer.ScreenSlice.SCREEN_PIXEL_MAX:papayaRoundFast((h-this.screenVolumes[e].screenMin)*this.screenVolumes[e].screenRatio),Q?i>0&&(this.imageDataDraw.data[j]=this.imageDataDraw.data[j]*(1-k)+this.screenVolumes[e].colorTable.lookupRed(h,P)*k,this.imageDataDraw.data[j+1]=this.imageDataDraw.data[j+1]*(1-k)+this.screenVolumes[e].colorTable.lookupGreen(h,P)*k,this.imageDataDraw.data[j+2]=this.imageDataDraw.data[j+2]*(1-k)+this.screenVolumes[e].colorTable.lookupBlue(h,P)*k,this.imageDataDraw.data[j+3]=i):(this.imageDataDraw.data[j]=this.screenVolumes[e].colorTable.lookupRed(h,P)*k,this.imageDataDraw.data[j+1]=this.screenVolumes[e].colorTable.lookupGreen(h,P)*k,this.imageDataDraw.data[j+2]=this.screenVolumes[e].colorTable.lookupBlue(h,P)*k,this.imageDataDraw.data[j+3]=i))}G||this.contextDTILines.stroke(),p||(Q=!0)}S&&this.contextMain.putImageData(this.imageDataDraw,0,0)}},papaya.viewer.ScreenSlice.prototype.repaint=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G=0,H=0,I=!1;if(a=Math.round(a),this.currentSlice=a,this.contextMain.clearRect(0,0,this.canvasMain.width,this.canvasMain.height),this.contextDTILines&&this.contextDTILines.clearRect(0,0,this.screenDim,this.screenDim),this.imageData.length===this.screenVolumes.length){for(d=0;d<this.screenVolumes.length;d+=1)if(!this.screenVolumes[d].hidden){for(j=this.screenVolumes[d].rgb,k=this.screenVolumes[d].dti,l=this.screenVolumes[d].dtiLines,B=this.screenVolumes[d].dtiColors,l&&(this.contextDTILines.lineWidth=1,B||(this.contextDTILines.strokeStyle=papaya.viewer.ScreenSlice.DTI_COLORS[H],H+=1,H%=3,this.contextDTILines.beginPath())),e=0;e<this.yDim;e+=1)for(f=0;f<this.xDim;f+=1)g=this.imageData[d][G],h=255,i=this.screenVolumes[d].alpha,G=4*(e*this.xDim+f),j?(this.imageDataDraw.data[G]=g>>16&255,this.imageDataDraw.data[G+1]=g>>8&255,this.imageDataDraw.data[G+2]=255&g,this.imageDataDraw.data[G+3]=h):k?l?(y=this.imageData[d][G],isNaN(y)||(g=this.imageData2[d][G],C=g>>16&255,D=g>>8&255,E=255&g,m=16777215&g,this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?n=Math.acos(Math.abs(E)/Math.sqrt(C*C+D*D+E*E)):this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?n=Math.acos(Math.abs(D)/Math.sqrt(C*C+D*D+E*E)):this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&(n=Math.acos(Math.abs(C)/Math.sqrt(C*C+D*D+E*E))),n=1-n/1.5708,B&&(this.contextDTILines.beginPath(),this.contextDTILines.strokeStyle="#"+papaya.utilities.StringUtils.pad(m.toString(16),6)),z=Math.sin(y),A=Math.cos(y),o=this.finalTransform2[0][2]+(f+.5)*this.finalTransform2[0][0],p=this.finalTransform2[1][2]+(e+.5)*this.finalTransform2[1][1],q=this.finalTransform2[0][2]+(f+.5*n)*this.finalTransform2[0][0],s=this.finalTransform2[1][2]+(e+.5)*this.finalTransform2[1][1],u=A*(q-o)-z*(s-p)+o,w=z*(q-o)+A*(s-p)+p,this.contextDTILines.moveTo(u,w),r=this.finalTransform2[0][2]+(f+1-.5*n)*this.finalTransform2[0][0],t=this.finalTransform2[1][2]+(e+.5)*this.finalTransform2[1][1],v=A*(r-o)-z*(t-p)+o,x=z*(r-o)+A*(t-p)+p,this.contextDTILines.lineTo(v,x),B&&this.contextDTILines.stroke())):(g=this.imageData[d][G],m=16777215&g,i=0!==m?(g>>24&255)/255:0,I?(this.imageDataDraw.data[G]=this.imageDataDraw.data[G]*(1-i)+(g>>16&255)*i,this.imageDataDraw.data[G+1]=this.imageDataDraw.data[G+1]*(1-i)+(g>>8&255)*i,this.imageDataDraw.data[G+2]=this.imageDataDraw.data[G+2]*(1-i)+(255&g)*i,this.imageDataDraw.data[G+3]=h):(this.imageDataDraw.data[G]=g>>16&255,this.imageDataDraw.data[G+1]=g>>8&255,this.imageDataDraw.data[G+2]=255&g,this.imageDataDraw.data[G+3]=g>>24&255)):(g=this.imageData[d][G],F=g,!this.screenVolumes[d].negative&&g<=this.screenVolumes[d].screenMin||this.screenVolumes[d].negative&&g>=this.screenVolumes[d].screenMin||isNaN(g)?(g=papaya.viewer.ScreenSlice.SCREEN_PIXEL_MIN,h=this.screenVolumes[d].isOverlay()?0:255):g=!this.screenVolumes[d].negative&&g>=this.screenVolumes[d].screenMax||this.screenVolumes[d].negative&&g<=this.screenVolumes[d].screenMax?papaya.viewer.ScreenSlice.SCREEN_PIXEL_MIN:papayaRoundFast((g-this.screenVolumes[d].screenMin)*this.screenVolumes[d].screenRatio),I?h>0&&(this.imageDataDraw.data[G]=this.imageDataDraw.data[G]*(1-i)+this.screenVolumes[d].colorTable.lookupRed(g,F)*i,this.imageDataDraw.data[G+1]=this.imageDataDraw.data[G+1]*(1-i)+this.screenVolumes[d].colorTable.lookupGreen(g,F)*i,this.imageDataDraw.data[G+2]=this.imageDataDraw.data[G+2]*(1-i)+this.screenVolumes[d].colorTable.lookupBlue(g,F)*i,this.imageDataDraw.data[G+3]=h):(this.imageDataDraw.data[G]=this.screenVolumes[d].colorTable.lookupRed(g,F)*i,this.imageDataDraw.data[G+1]=this.screenVolumes[d].colorTable.lookupGreen(g,F)*i,this.imageDataDraw.data[G+2]=this.screenVolumes[d].colorTable.lookupBlue(g,F)*i,this.imageDataDraw.data[G+3]=h));B||this.contextDTILines.stroke(),l||(I=!0)}this.contextMain.putImageData(this.imageDataDraw,0,0)}else this.updateSlice(a,!0)},papaya.viewer.ScreenSlice.prototype.getRealWidth=function(){return this.xDim*this.xSize},papaya.viewer.ScreenSlice.prototype.getRealHeight=function(){return this.yDim*this.ySize},papaya.viewer.ScreenSlice.prototype.getXYratio=function(){return this.xSize/this.ySize},papaya.viewer.ScreenSlice.prototype.getYXratio=function(){return this.ySize/this.xSize},papaya.viewer.ScreenSlice.prototype.getXSize=function(){return this.xSize},papaya.viewer.ScreenSlice.prototype.getYSize=function(){return this.ySize},papaya.viewer.ScreenSlice.prototype.getXDim=function(){return this.xDim},papaya.viewer.ScreenSlice.prototype.getYDim=function(){return this.yDim},papaya.viewer.ScreenSlice.prototype.updateZoomTransform=function(a,b,c,d,e,f){var g,h,i,j;b=(b+.5)*(a-1)*-1,c=(c+.5)*(a-1)*-1,d*=a-1,e*=a-1,g=b+d,i=-1*(a-1)*this.xDim,g>0?g=0:g<i&&(g=i),h=c+e,j=-1*(a-1)*this.yDim,h>0?h=0:h<j&&(h=j),a>1&&(this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?(f.panAmountX=Math.round((g-b)/(a-1)),f.panAmountY=Math.round((h-c)/(a-1))):this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?(f.panAmountX=Math.round((g-b)/(a-1)),f.panAmountZ=Math.round((h-c)/(a-1))):this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&(f.panAmountY=Math.round((g-b)/(a-1)),f.panAmountZ=Math.round((h-c)/(a-1)))),this.zoomTransform[0][0]=a,this.zoomTransform[0][1]=0,this.zoomTransform[0][2]=g,this.zoomTransform[1][0]=0,this.zoomTransform[1][1]=a,this.zoomTransform[1][2]=h,this.updateFinalTransform()},papaya.viewer.ScreenSlice.prototype.updateFinalTransform=function(){var a,b;if(this.manager.isRadiologicalMode()&&this.isRadiologicalSensitive()){for(a=0;a<3;a+=1)for(b=0;b<3;b+=1)this.tempTransform[a][b]=this.screenTransform[a][b];for(a=0;a<3;a+=1)for(b=0;b<3;b+=1)this.tempTransform2[a][b]=this.tempTransform[a][0]*this.radiologicalTransform[0][b]+this.tempTransform[a][1]*this.radiologicalTransform[1][b]+this.tempTransform[a][2]*this.radiologicalTransform[2][b];for(a=0;a<3;a+=1)for(b=0;b<3;b+=1)this.finalTransform[a][b]=this.tempTransform2[a][0]*this.zoomTransform[0][b]+this.tempTransform2[a][1]*this.zoomTransform[1][b]+this.tempTransform2[a][2]*this.zoomTransform[2][b];for(a=0;a<3;a+=1)for(b=0;b<3;b+=1)this.tempTransform[a][b]=this.screenTransform2[a][b];for(a=0;a<3;a+=1)for(b=0;b<3;b+=1)this.tempTransform2[a][b]=this.tempTransform[a][0]*this.radiologicalTransform[0][b]+this.tempTransform[a][1]*this.radiologicalTransform[1][b]+this.tempTransform[a][2]*this.radiologicalTransform[2][b];for(a=0;a<3;a+=1)for(b=0;b<3;b+=1)this.finalTransform2[a][b]=this.tempTransform2[a][0]*this.zoomTransform[0][b]+this.tempTransform2[a][1]*this.zoomTransform[1][b]+this.tempTransform2[a][2]*this.zoomTransform[2][b]}else{for(a=0;a<3;a+=1)for(b=0;b<3;b+=1)this.finalTransform[a][b]=this.screenTransform[a][0]*this.zoomTransform[0][b]+this.screenTransform[a][1]*this.zoomTransform[1][b]+this.screenTransform[a][2]*this.zoomTransform[2][b];for(a=0;a<3;a+=1)for(b=0;b<3;b+=1)this.finalTransform2[a][b]=this.screenTransform2[a][0]*this.zoomTransform[0][b]+this.screenTransform2[a][1]*this.zoomTransform[1][b]+this.screenTransform2[a][2]*this.zoomTransform[2][b]}},papaya.viewer.ScreenSlice.prototype.isRadiologicalSensitive=function(){return this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL||this.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL},papaya.viewer.ScreenSlice.prototype.findProximalRulerHandle=function(a,b){return this.tempPoint.x=a,this.tempPoint.y=b,papaya.utilities.MathUtils.lineDistance(this.tempPoint.x,this.tempPoint.y,this.rulerPoints[0].x,this.rulerPoints[0].y)<papaya.viewer.ScreenSlice.GRAB_RADIUS?this.rulerPoints[0]:papaya.utilities.MathUtils.lineDistance(this.tempPoint.x,this.tempPoint.y,this.rulerPoints[1].x,this.rulerPoints[1].y)<papaya.viewer.ScreenSlice.GRAB_RADIUS?this.rulerPoints[1]:null},papaya.viewer.ScreenSlice.prototype.updateDTILinesImage=function(){null!==this.canvasDTILines&&this.canvasDTILines.width===this.screenDim||(this.canvasDTILines=document.createElement("canvas"),this.canvasDTILines.width=this.screenDim,this.canvasDTILines.height=this.screenDim,this.contextDTILines=this.canvasDTILines.getContext("2d"))},papaya.viewer.ScreenSlice.prototype.clearDTILinesImage=function(){this.canvasDTILines=null,this.contextDTILines=null};var papaya=papaya||{};papaya.viewer=papaya.viewer||{};var shaderVert=["precision mediump float;","attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec4 aVertexColor;","attribute vec2 aTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","uniform mat3 uNMatrix;","uniform vec3 uAmbientColor;","uniform vec3 uPointLightingLocation;","uniform vec3 uPointLightingColor;","uniform bool uActivePlane;","uniform bool uActivePlaneEdge;","uniform bool uCrosshairs;","uniform bool uColors;","uniform bool uColorPicking;","uniform bool uTrianglePicking;","uniform bool uColorSolid;","uniform vec4 uSolidColor;","uniform bool uOrientationText;","uniform bool uRuler;","uniform float uAlpha;","varying vec3 vLightWeighting;","varying lowp vec4 vColor;","varying vec2 vTextureCoord;","void main(void) {","    vec4 mvPosition = uMVMatrix * vec4(aVertexPosition, 1.0);","    gl_Position = uPMatrix * mvPosition;","    if (!uActivePlane && !uActivePlaneEdge && !uCrosshairs && !uOrientationText && !uRuler) {","       vec3 lightDirection = normalize(uPointLightingLocation - mvPosition.xyz);","       vec3 transformedNormal = uNMatrix * aVertexNormal;","       float directionalLightWeighting = max(dot(transformedNormal, lightDirection), 0.0);","       vLightWeighting = uAmbientColor + uPointLightingColor * directionalLightWeighting;","       if (uColors) {","           vColor = aVertexColor;","       }","   }","   if (uColorSolid) {","       vColor = uSolidColor;","   }","   if (uOrientationText) {","       vTextureCoord = aTextureCoord;","   }","}"].join("\n"),shaderFrag=["precision mediump float;","uniform bool uActivePlane;","uniform bool uActivePlaneEdge;","uniform bool uCrosshairs;","uniform bool uColors;","uniform bool uColorPicking;","uniform bool uTrianglePicking;","uniform bool uColorSolid;","uniform vec4 uSolidColor;","uniform bool uOrientationText;","uniform bool uRuler;","uniform sampler2D uSampler;","uniform float uAlpha;","varying vec3 vLightWeighting;","varying lowp vec4 vColor;","varying vec2 vTextureCoord;","vec4 packFloatToVec4i(const float value) {","   const vec4 bitSh = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);","   const vec4 bitMsk = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);","   vec4 res = fract(value * bitSh);","   res -= res.xxyz * bitMsk;","   return res;","}","void main(void) {","    vec4 fragmentColor = vec4(1.0, 1.0, 1.0, 1.0);","    if (uColors) {","       fragmentColor = vColor;","    } else if (uColorSolid) {","       fragmentColor = vColor;","    }","    if (uActivePlane) {","       gl_FragColor = vec4(0.10980392156863, 0.52549019607843, 0.93333333333333, 0.5);","    } else if (uActivePlaneEdge) {","       gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);","    } else if (uRuler) {","       gl_FragColor = vec4(1.0, 0.078, 0.576, 1.0);","    } else if (uOrientationText) {","        vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));","        if (textureColor.a > 0.0) {","           gl_FragColor = vec4(textureColor.rgb, textureColor.a);","        } else {","           gl_FragColor = vec4(textureColor.rgb, 0);","        }","    } else if (uCrosshairs) {","       gl_FragColor = vec4(0.10980392156863, 0.52549019607843, 0.93333333333333, 1.0);","    } else if (uColorPicking) {","       gl_FragColor = vec4(fragmentColor.r, fragmentColor.g, fragmentColor.b, 1);","    } else if (uTrianglePicking) {","       gl_FragColor = packFloatToVec4i(gl_FragCoord.z);","    } else {","       gl_FragColor = vec4(fragmentColor.rgb * vLightWeighting, uAlpha);","    }","}"].join("\n");papaya.viewer.ScreenSurface=papaya.viewer.ScreenSurface||function(a,b,c,d){this.shaderProgram=null,this.mvMatrix=mat4.create(),this.pMatrix=mat4.create(),this.pMatrix1=mat4.create(),this.centerMat=mat4.create(),this.centerMatInv=mat4.create(),this.tempMat=mat4.create(),this.tempMat2=mat4.create(),this.pickingBuffer=null,this.initialized=!1,this.screenOffsetX=0,this.screenOffsetY=0,this.screenDim=0,this.screenTransform=[[1,0,0],[0,1,0],[0,0,1]],this.volume=a,this.surfaces=b,this.viewer=c,this.currentCoord=c.currentCoord,this.zoom=0,this.sliceDirection=papaya.viewer.ScreenSlice.DIRECTION_SURFACE,this.dynamicStartX=-1,this.dynamicStartY=-1,this.activePlaneVertsAxial=new Float32Array(12),this.activePlaneVertsCoronal=new Float32Array(12),this.activePlaneVertsSagittal=new Float32Array(12),this.activePlaneVertsAxialEdges=new Float32Array(24),this.activePlaneVertsCoronalEdges=new Float32Array(24),this.activePlaneVertsSagittalEdges=new Float32Array(24),this.orientationVerts=new Float32Array(24),this.crosshairLineVertsX=new Float32Array(6),this.crosshairLineVertsY=new Float32Array(6),this.crosshairLineVertsZ=new Float32Array(6),this.mouseRotDragX=this.clearTransform([]),this.mouseRotDragY=this.clearTransform([]),this.mouseRotDrag=this.clearTransform([]),this.mouseTransDrag=this.clearTransform([]),this.mouseRotCurrent=this.clearTransform([]),this.mouseTransCurrent=this.clearTransform([]),this.mouseRotTemp=this.clearTransform([]),this.mouseTransTemp=this.clearTransform([]),this.activePlaneAxialBuffer=null,this.activePlaneCoronalBuffer=null,this.activePlaneSagittalBuffer=null,this.activePlaneAxialEdgesBuffer=null,this.activePlaneCoronalEdgesBuffer=null,this.activePlaneSagittalEdgesBuffer=null,this.orientationBuffer=null,this.crosshairLineXBuffer=null,this.crosshairLineYBuffer=null,this.crosshairLineZBuffer=null,this.crosshairLineZBuffer=null,this.xSize=this.volume.header.voxelDimensions.xSize,this.xDim=this.volume.header.imageDimensions.xDim,this.xHalf=this.xDim*this.xSize/2,this.ySize=this.volume.header.voxelDimensions.ySize,this.yDim=this.volume.header.imageDimensions.yDim,this.yHalf=this.yDim*this.ySize/2,this.zSize=this.volume.header.voxelDimensions.zSize,this.zDim=this.volume.header.imageDimensions.zDim,this.zHalf=this.zDim*this.zSize/2,this.showSurfacePlanes="Yes"===c.container.preferences.showSurfacePlanes,this.backgroundColor=papaya.viewer.ScreenSurface.DEFAULT_BACKGROUND,this.pickLocX=0,this.pickLocY=0,this.needsPickColor=!1,this.pickedColor=null,this.needsPick=!1,this.pickedCoordinate=null,this.scaleFactor=1,this.orientationTexture=null,this.orientationTextureCoords=null,this.orientationTextureCoordBuffer=null,this.orientationCanvas=null,this.orientationContext=null,this.rulerPoints=null,this.grabbedRulerPoint=-1,this.processParams(d)},papaya.viewer.ScreenSurface.DEFAULT_ORIENTATION=[-.015552218963737041,.09408106275544359,-.9954430697501158,0,-.9696501263313991,.24152923619118966,.03797658948646743,0,.24400145970103732,.965822108594413,.0874693978960848,0,0,0,0,1],papaya.viewer.ScreenSurface.MOUSE_SENSITIVITY=.3,papaya.viewer.ScreenSurface.DEFAULT_BACKGROUND=[.5,.5,.5],papaya.viewer.ScreenSurface.TEXT_SIZE=50,papaya.viewer.ScreenSurface.ORIENTATION_SIZE=10,papaya.viewer.ScreenSurface.RULER_COLOR=[1,.078,.576],papaya.viewer.ScreenSurface.RULER_NUM_LINES=25,papaya.viewer.ScreenSurface.RULER_RADIUS=1,papaya.viewer.ScreenSurface.EXT_INT=null,papaya.viewer.ScreenSurface.makeShader=function(a,b,c){var d=a.createShader(c);return a.shaderSource(d,b),a.compileShader(d),a.getShaderParameter(d,a.COMPILE_STATUS)?d:(console.log(a.getShaderInfoLog(d)),null)},papaya.viewer.ScreenSurface.initShaders=function(a){var b=papaya.viewer.ScreenSurface.makeShader(a,shaderVert,a.VERTEX_SHADER),c=papaya.viewer.ScreenSurface.makeShader(a,shaderFrag,a.FRAGMENT_SHADER),d=a.createProgram();return a.attachShader(d,c),a.attachShader(d,b),a.linkProgram(d),a.getProgramParameter(d,a.LINK_STATUS)||console.log("Could not initialise shaders"),a.useProgram(d),d.vertexPositionAttribute=a.getAttribLocation(d,"aVertexPosition"),a.enableVertexAttribArray(d.vertexPositionAttribute),d.vertexNormalAttribute=a.getAttribLocation(d,"aVertexNormal"),a.enableVertexAttribArray(d.vertexNormalAttribute),d.vertexColorAttribute=a.getAttribLocation(d,"aVertexColor"),d.textureCoordAttribute=a.getAttribLocation(d,"aTextureCoord"),d.pMatrixUniform=a.getUniformLocation(d,"uPMatrix"),d.mvMatrixUniform=a.getUniformLocation(d,"uMVMatrix"),d.nMatrixUniform=a.getUniformLocation(d,"uNMatrix"),d.ambientColorUniform=a.getUniformLocation(d,"uAmbientColor"),d.pointLightingLocationUniform=a.getUniformLocation(d,"uPointLightingLocation"),d.pointLightingColorUniform=a.getUniformLocation(d,"uPointLightingColor"),d.activePlane=a.getUniformLocation(d,"uActivePlane"),d.activePlaneEdge=a.getUniformLocation(d,"uActivePlaneEdge"),d.colorPicking=a.getUniformLocation(d,"uColorPicking"),d.trianglePicking=a.getUniformLocation(d,"uTrianglePicking"),d.crosshairs=a.getUniformLocation(d,"uCrosshairs"),d.hasColors=a.getUniformLocation(d,"uColors"),d.hasSolidColor=a.getUniformLocation(d,"uColorSolid"),d.solidColor=a.getUniformLocation(d,"uSolidColor"),d.orientationText=a.getUniformLocation(d,"uOrientationText"),d.samplerUniform=a.getUniformLocation(d,"uSampler"),d.ruler=a.getUniformLocation(d,"uRuler"),d.alphaVal=a.getUniformLocation(d,"uAlpha"),d},papaya.viewer.ScreenSurface.prototype.initialize=function(){var a;for(this.initialized=!0,this.canvas=document.createElement("canvas"),this.canvas.width=this.screenDim,this.canvas.height=this.screenDim,this.context=this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl"),this.context.viewportWidth=this.canvas.width,this.context.viewportHeight=this.canvas.height,this.zoom=this.volume.header.imageDimensions.yDim*this.volume.header.voxelDimensions.ySize*1.5,this.initPerspective(),this.shaderProgram=papaya.viewer.ScreenSurface.initShaders(this.context),a=0;a<this.surfaces.length;a+=1)this.initBuffers(this.context,this.surfaces[a]);this.calculateScaleFactor(),this.initActivePlaneBuffers(this.context),this.initRulerBuffers(this.context),mat4.multiply(this.centerMat,papaya.viewer.ScreenSurface.DEFAULT_ORIENTATION,this.tempMat),mat4.multiply(this.tempMat,this.centerMatInv,this.mouseRotCurrent),papaya.viewer.ScreenSurface.EXT_INT=this.context.getExtension("OES_element_index_uint"),papaya.viewer.ScreenSurface.EXT_INT||console.log("This browser does not support OES_element_index_uint extension!"),this.updateBackgroundColor()},papaya.viewer.ScreenSurface.prototype.calculateScaleFactor=function(){var a=this.xSize*this.xDim,b=this.ySize*this.yDim,c=this.zSize*this.zDim,d=a;b>d&&(d=b),c>d&&(d=c),this.scaleFactor=d/256},papaya.viewer.ScreenSurface.prototype.resize=function(a){this.initialized||this.initialize(),this.screenDim=a,this.canvas.width=this.screenDim,this.canvas.height=this.screenDim,this.context.viewportWidth=this.canvas.width,this.context.viewportHeight=this.canvas.height},papaya.viewer.ScreenSurface.prototype.applyMatrixUniforms=function(a){a.uniformMatrix4fv(this.shaderProgram.pMatrixUniform,!1,this.pMatrix),a.uniformMatrix4fv(this.shaderProgram.mvMatrixUniform,!1,this.mvMatrix);var b=mat3.create();mat4.toInverseMat3(this.mvMatrix,b),mat3.transpose(b),a.uniformMatrix3fv(this.shaderProgram.nMatrixUniform,!1,b)},papaya.viewer.ScreenSurface.prototype.draw=function(){this.surfaces.length>0&&(this.initialized||this.initialize(),this.drawScene(this.context))},papaya.viewer.ScreenSurface.prototype.initBuffers=function(a,b){b.pointsBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,b.pointsBuffer),a.bufferData(a.ARRAY_BUFFER,b.pointData,a.STATIC_DRAW),b.pointsBuffer.itemSize=3,b.pointsBuffer.numItems=b.numPoints,b.normalsBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,b.normalsBuffer),a.bufferData(a.ARRAY_BUFFER,b.normalsData,a.STATIC_DRAW),b.normalsBuffer.itemSize=3,b.normalsBuffer.numItems=b.numPoints,b.colorsData&&(b.colorsBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,b.colorsBuffer),a.bufferData(a.ARRAY_BUFFER,b.colorsData,a.STATIC_DRAW),b.colorsBuffer.itemSize=4,b.colorsBuffer.numItems=b.numPoints),b.trianglesBuffer=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b.trianglesBuffer),a.bufferData(a.ELEMENT_ARRAY_BUFFER,b.triangleData,a.STATIC_DRAW),b.trianglesBuffer.itemSize=1,b.trianglesBuffer.numItems=3*b.numTriangles},papaya.viewer.ScreenSurface.prototype.initOrientationBuffers=function(a){this.makeOrientedTextSquare(),this.orientationBuffer=a.createBuffer(),this.orientationBuffer.itemSize=3,this.orientationBuffer.numItems=4,this.orientationTextureCoordBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.orientationTextureCoordBuffer),this.orientationTextureCoords=[0,1,0,0,1,1,1,0],a.bufferData(a.ARRAY_BUFFER,new Float32Array(this.orientationTextureCoords),a.STATIC_DRAW),this.orientationTextureCoordBuffer.itemSize=2,this.orientationTextureCoordBuffer.numItems=4},papaya.viewer.ScreenSurface.prototype.initActivePlaneBuffers=function(a){this.updateActivePlanes(),this.activePlaneAxialBuffer=a.createBuffer(),this.activePlaneAxialBuffer.itemSize=3,this.activePlaneAxialBuffer.numItems=4,this.activePlaneCoronalBuffer=a.createBuffer(),this.activePlaneCoronalBuffer.itemSize=3,this.activePlaneCoronalBuffer.numItems=4,this.activePlaneSagittalBuffer=a.createBuffer(),this.activePlaneSagittalBuffer.itemSize=3,this.activePlaneSagittalBuffer.numItems=4,this.activePlaneAxialEdgesBuffer=a.createBuffer(),this.activePlaneAxialEdgesBuffer.itemSize=3,this.activePlaneAxialEdgesBuffer.numItems=8,this.activePlaneCoronalEdgesBuffer=a.createBuffer(),this.activePlaneCoronalEdgesBuffer.itemSize=3,this.activePlaneCoronalEdgesBuffer.numItems=8,this.activePlaneSagittalEdgesBuffer=a.createBuffer(),this.activePlaneSagittalEdgesBuffer.itemSize=3,this.activePlaneSagittalEdgesBuffer.numItems=8,this.crosshairLineXBuffer=a.createBuffer(),this.crosshairLineXBuffer.itemSize=3,this.crosshairLineXBuffer.numItems=2,this.crosshairLineYBuffer=a.createBuffer(),this.crosshairLineYBuffer.itemSize=3,this.crosshairLineYBuffer.numItems=2,this.crosshairLineZBuffer=a.createBuffer(),this.crosshairLineZBuffer.itemSize=3,this.crosshairLineZBuffer.numItems=2},papaya.viewer.ScreenSurface.prototype.initRulerBuffers=function(a){this.rulerPointData=this.makeSphere(papaya.viewer.ScreenSurface.RULER_NUM_LINES,papaya.viewer.ScreenSurface.RULER_NUM_LINES,papaya.viewer.ScreenSurface.RULER_RADIUS*this.scaleFactor),this.sphereVertexPositionBuffer=a.createBuffer(),this.sphereVertexPositionBuffer.itemSize=3,this.sphereVertexPositionBuffer.numItems=this.rulerPointData.vertices.length/3,this.sphereNormalsPositionBuffer=a.createBuffer(),this.sphereNormalsPositionBuffer.itemSize=3,this.sphereNormalsPositionBuffer.numItems=this.rulerPointData.normals.length/3,this.sphereVertexIndexBuffer=a.createBuffer(),this.sphereVertexIndexBuffer.itemSize=1,this.sphereVertexIndexBuffer.numItems=this.rulerPointData.indices.length,this.rulerLineBuffer=a.createBuffer(),this.rulerLineBuffer.itemSize=3,this.rulerLineBuffer.numItems=2},papaya.viewer.ScreenSurface.prototype.initPerspective=function(){mat4.perspective(45,1,10,1e5,this.pMatrix1),this.eye=new vec3.create,this.eye[0]=0,this.eye[1]=0,this.center=new vec3.create,this.centerWorld=new papaya.core.Coordinate,this.viewer.getWorldCoordinateAtIndex(parseInt(this.xDim/2,10),parseInt(this.yDim/2,10),parseInt(this.zDim/2,10),this.centerWorld),this.center[0]=this.centerWorld.x,this.center[1]=this.centerWorld.y,this.center[2]=this.centerWorld.z,mat4.identity(this.centerMat),mat4.translate(this.centerMat,[this.center[0],this.center[1],this.center[2]]),mat4.identity(this.centerMatInv),mat4.translate(this.centerMatInv,[-this.center[0],-this.center[1],-this.center[2]]),this.up=new vec3.create,this.up[0]=0,this.up[1]=1,this.up[2]=0},papaya.viewer.ScreenSurface.prototype.updatePerspective=function(){var a;this.eye[2]=this.zoom,a=mat4.lookAt(this.eye,this.center,this.up),mat4.multiply(this.pMatrix1,a,this.pMatrix)},papaya.viewer.ScreenSurface.prototype.unpackFloatFromVec4i=function(a){var b=[1/16777216,1/65536,1/256,1];return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},papaya.viewer.ScreenSurface.prototype.hasTranslucentSurfaces=function(){var a;for(a=0;a<this.surfaces.length;a+=1)if(this.surfaces[a].alpha<1)return!0;return!1},papaya.viewer.ScreenSurface.prototype.drawScene=function(a){var b,c,d,e,f=this.hasTranslucentSurfaces();for(a.clearColor(this.backgroundColor[0],this.backgroundColor[1],this.backgroundColor[2],1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),a.viewport(0,0,a.viewportWidth,a.viewportHeight),mat4.identity(this.mvMatrix),mat4.multiply(this.mouseRotDrag,this.mouseRotCurrent,this.mouseRotTemp),mat4.multiply(this.mouseTransDrag,this.mouseTransCurrent,this.mouseTransTemp),mat4.multiply(this.mouseTransTemp,this.mouseRotTemp,this.tempMat),mat4.set(this.tempMat,this.mvMatrix),this.updatePerspective(),this.applyMatrixUniforms(a),a.uniform3f(this.shaderProgram.ambientColorUniform,.2,.2,.2),a.uniform3f(this.shaderProgram.pointLightingLocationUniform,0,0,300*this.scaleFactor),a.uniform3f(this.shaderProgram.pointLightingColorUniform,.8,.8,.8),a.uniform1i(this.shaderProgram.orientationText,0),a.uniform1i(this.shaderProgram.activePlane,0),a.uniform1i(this.shaderProgram.activePlaneEdge,0),a.uniform1i(this.shaderProgram.crosshairs,0),a.uniform1i(this.shaderProgram.hasColors,0),a.uniform1i(this.shaderProgram.colorPicking,0),a.uniform1i(this.shaderProgram.trianglePicking,0),this.needsPick?(a.uniform1i(this.shaderProgram.trianglePicking,1),null!==this.pickingBuffer&&this.pickingBuffer.length===a.viewportWidth*a.viewportHeight*4||(this.pickingBuffer=new Uint8Array(a.viewportWidth*a.viewportHeight*4))):this.needsPickColor&&(a.uniform1i(this.shaderProgram.colorPicking,1),null!==this.pickingBuffer&&this.pickingBuffer.length===a.viewportWidth*a.viewportHeight*4||(this.pickingBuffer=new Uint8Array(a.viewportWidth*a.viewportHeight*4))),a.enable(a.DEPTH_TEST),b=0;b<this.surfaces.length;b+=1)this.renderSurface(a,b,this.surfaces[b].alpha<1,!0,!1);if(a.uniform1i(this.shaderProgram.hasSolidColor,0),a.uniform1i(this.shaderProgram.hasColors,0),this.needsPick)this.needsPick=!1,this.pickedCoordinate=this.findPickedCoordinate(a,this.pickLocX,this.pickLocY),a.uniform1i(this.shaderProgram.trianglePicking,0);else if(this.needsPickColor)this.needsPickColor=!1,this.pickedColor=this.findPickedColor(a),a.uniform1i(this.shaderProgram.colorPicking,0);else{for(this.showSurfacePlanes&&(this.needsUpdateActivePlanes&&(this.needsUpdateActivePlanes=!1,this.bindActivePlanes(a)),a.depthMask(!1),a.uniform1i(this.shaderProgram.activePlane,1),a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),a.bindBuffer(a.ARRAY_BUFFER,this.activePlaneAxialBuffer),a.vertexAttribPointer(this.shaderProgram.vertexPositionAttribute,this.activePlaneAxialBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLE_STRIP,0,4),a.bindBuffer(a.ARRAY_BUFFER,this.activePlaneCoronalBuffer),a.vertexAttribPointer(this.shaderProgram.vertexPositionAttribute,this.activePlaneCoronalBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLE_STRIP,0,4),a.bindBuffer(a.ARRAY_BUFFER,this.activePlaneSagittalBuffer),a.vertexAttribPointer(this.shaderProgram.vertexPositionAttribute,this.activePlaneSagittalBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLE_STRIP,0,4),a.depthMask(!0),a.disable(a.BLEND),a.uniform1i(this.shaderProgram.activePlane,0),a.uniform1i(this.shaderProgram.activePlaneEdge,1),a.lineWidth(this.isMainView()?3:2),a.bindBuffer(a.ARRAY_BUFFER,this.activePlaneAxialEdgesBuffer),a.vertexAttribPointer(this.shaderProgram.vertexPositionAttribute,this.activePlaneAxialEdgesBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.LINES,0,8),a.bindBuffer(a.ARRAY_BUFFER,this.activePlaneCoronalEdgesBuffer),a.vertexAttribPointer(this.shaderProgram.vertexPositionAttribute,this.activePlaneCoronalEdgesBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.LINES,0,8),a.bindBuffer(a.ARRAY_BUFFER,this.activePlaneSagittalEdgesBuffer),a.vertexAttribPointer(this.shaderProgram.vertexPositionAttribute,this.activePlaneSagittalEdgesBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.LINES,0,8),a.uniform1i(this.shaderProgram.activePlaneEdge,0)),this.viewer.isShowingCrosshairs()&&(this.viewer.mainImage!==this||this.viewer.toggleMainCrosshairs)&&(this.needsUpdateActivePlanes&&(this.needsUpdateActivePlanes=!1,
this.bindActivePlanes(a)),a.uniform1i(this.shaderProgram.crosshairs,1),a.lineWidth(this.isMainView()?3:2),a.bindBuffer(a.ARRAY_BUFFER,this.crosshairLineXBuffer),a.vertexAttribPointer(this.shaderProgram.vertexPositionAttribute,this.crosshairLineXBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.LINES,0,2),a.bindBuffer(a.ARRAY_BUFFER,this.crosshairLineYBuffer),a.vertexAttribPointer(this.shaderProgram.vertexPositionAttribute,this.crosshairLineYBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.LINES,0,2),a.bindBuffer(a.ARRAY_BUFFER,this.crosshairLineZBuffer),a.vertexAttribPointer(this.shaderProgram.vertexPositionAttribute,this.crosshairLineZBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.LINES,0,2),a.uniform1i(this.shaderProgram.crosshairs,0)),a.enable(a.DEPTH_TEST),b=0;b<this.surfaces.length;b+=1)f&&this.renderSurface(a,b,this.surfaces[b].alpha<1,!1,!0);this.viewer.mainImage===this.viewer.surfaceView&&"Yes"===this.viewer.container.preferences.showOrientation&&(c=this.currentCoord.x+(this.xDim/2-this.volume.header.origin.x),d=this.yDim-this.currentCoord.y-(this.yDim/2-this.volume.header.origin.y),e=this.zDim-this.currentCoord.z-(this.zDim/2-this.volume.header.origin.z),this.drawOrientedText(a,"S",papaya.viewer.ScreenSurface.TEXT_SIZE,[c*this.xSize-this.xHalf,d*this.ySize-this.yHalf,this.zHalf+papaya.viewer.ScreenSurface.ORIENTATION_SIZE*this.scaleFactor-(this.zDim/2-this.volume.header.origin.z)*this.zSize]),this.drawOrientedText(a,"I",papaya.viewer.ScreenSurface.TEXT_SIZE,[c*this.xSize-this.xHalf,d*this.ySize-this.yHalf,-this.zHalf-papaya.viewer.ScreenSurface.ORIENTATION_SIZE*this.scaleFactor-(this.zDim/2-this.volume.header.origin.z)*this.zSize]),this.drawOrientedText(a,"P",papaya.viewer.ScreenSurface.TEXT_SIZE,[c*this.xSize-this.xHalf,-this.yHalf-papaya.viewer.ScreenSurface.ORIENTATION_SIZE*this.scaleFactor-(this.yDim/2-this.volume.header.origin.y)*this.ySize,e*this.zSize-this.zHalf]),this.drawOrientedText(a,"A",papaya.viewer.ScreenSurface.TEXT_SIZE,[c*this.xSize-this.xHalf,this.yHalf+papaya.viewer.ScreenSurface.ORIENTATION_SIZE*this.scaleFactor-(this.yDim/2-this.volume.header.origin.y)*this.ySize,e*this.zSize-this.zHalf]),this.drawOrientedText(a,"L",papaya.viewer.ScreenSurface.TEXT_SIZE,[-this.xHalf-papaya.viewer.ScreenSurface.ORIENTATION_SIZE*this.scaleFactor+(this.xDim/2-this.volume.header.origin.x)*this.xSize,d*this.ySize-this.yHalf,e*this.zSize-this.zHalf]),this.drawOrientedText(a,"R",papaya.viewer.ScreenSurface.TEXT_SIZE,[this.xHalf+papaya.viewer.ScreenSurface.ORIENTATION_SIZE*this.scaleFactor+(this.xDim/2-this.volume.header.origin.x)*this.xSize,d*this.ySize-this.yHalf,e*this.zSize-this.zHalf])),"Yes"===this.viewer.container.preferences.showRuler?this.isMainView()&&this.drawRuler(a):this.rulerPoints=null}a.disable(a.DEPTH_TEST)},papaya.viewer.ScreenSurface.prototype.renderSurface=function(a,b,c,d,e){a.uniform1f(this.shaderProgram.alphaVal,this.surfaces[b].alpha),c?d?(a.enable(a.BLEND),a.enable(a.CULL_FACE),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),a.frontFace(a.CCW),a.cullFace(a.FRONT),a.uniform3f(this.shaderProgram.ambientColorUniform,0,0,0),a.uniform3f(this.shaderProgram.pointLightingLocationUniform,0,0,-300*this.scaleFactor)):e&&(a.enable(a.BLEND),a.enable(a.CULL_FACE),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),a.frontFace(a.CCW),a.cullFace(a.BACK),a.uniform3f(this.shaderProgram.ambientColorUniform,.2,.2,.2),a.uniform3f(this.shaderProgram.pointLightingLocationUniform,0,0,300*this.scaleFactor)):(a.uniform3f(this.shaderProgram.ambientColorUniform,.2,.2,.2),a.uniform3f(this.shaderProgram.pointLightingLocationUniform,0,0,300*this.scaleFactor)),a.uniform1i(this.shaderProgram.hasSolidColor,0),a.uniform1i(this.shaderProgram.hasColors,0),this.surfaces[b].solidColor&&(a.uniform1i(this.shaderProgram.hasSolidColor,1),a.uniform4f(this.shaderProgram.solidColor,this.surfaces[b].solidColor[0],this.surfaces[b].solidColor[1],this.surfaces[b].solidColor[2],1)),a.bindBuffer(a.ARRAY_BUFFER,this.surfaces[b].pointsBuffer),a.vertexAttribPointer(this.shaderProgram.vertexPositionAttribute,this.surfaces[b].pointsBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.surfaces[b].normalsBuffer),a.vertexAttribPointer(this.shaderProgram.vertexNormalAttribute,this.surfaces[b].normalsBuffer.itemSize,a.FLOAT,!1,0,0),this.surfaces[b].colorsData?(a.uniform1i(this.shaderProgram.hasColors,1),a.bindBuffer(a.ARRAY_BUFFER,this.surfaces[b].colorsBuffer),a.enableVertexAttribArray(this.shaderProgram.vertexColorAttribute),a.vertexAttribPointer(this.shaderProgram.vertexColorAttribute,this.surfaces[b].colorsBuffer.itemSize,a.FLOAT,!1,0,0)):a.disableVertexAttribArray(this.shaderProgram.vertexColorAttribute),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.surfaces[b].trianglesBuffer),a.drawElements(a.TRIANGLES,this.surfaces[b].trianglesBuffer.numItems,a.UNSIGNED_INT,0),c&&(d||e)&&(a.disable(a.BLEND),a.disable(a.CULL_FACE))},papaya.viewer.ScreenSurface.prototype.drawRuler=function(a){var b=!0;null===this.rulerPoints&&(this.rulerPoints=new Float32Array(6),b=this.findInitialRulerPoints(a),this.drawScene(a)),b&&(a.uniform1i(this.shaderProgram.ruler,1),this.drawRulerPoint(a,this.rulerPoints[0],this.rulerPoints[1],this.rulerPoints[2]),this.drawRulerPoint(a,this.rulerPoints[3],this.rulerPoints[4],this.rulerPoints[5]),a.bindBuffer(a.ARRAY_BUFFER,this.rulerLineBuffer),a.bufferData(a.ARRAY_BUFFER,this.rulerPoints,a.DYNAMIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,this.rulerLineBuffer),a.vertexAttribPointer(this.shaderProgram.vertexPositionAttribute,this.rulerLineBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.LINES,0,2),a.uniform1i(this.shaderProgram.ruler,0))},papaya.viewer.ScreenSurface.prototype.drawRulerPoint=function(a,b,c,d){this.sphereVertexPositionBuffer.numItems=this.rulerPointData.vertices.length/3,a.bindBuffer(a.ARRAY_BUFFER,this.sphereVertexPositionBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array(this.rulerPointData.vertices),a.STATIC_DRAW),this.sphereNormalsPositionBuffer.numItems=this.rulerPointData.normals.length/3,a.bindBuffer(a.ARRAY_BUFFER,this.sphereNormalsPositionBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array(this.rulerPointData.normals),a.STATIC_DRAW),this.sphereVertexIndexBuffer.numItems=this.rulerPointData.indices.length,a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.sphereVertexIndexBuffer),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.rulerPointData.indices),a.STATIC_DRAW),a.uniform1i(this.shaderProgram.hasSolidColor,1),a.uniform4f(this.shaderProgram.solidColor,papaya.viewer.ScreenSurface.RULER_COLOR[0],papaya.viewer.ScreenSurface.RULER_COLOR[1],papaya.viewer.ScreenSurface.RULER_COLOR[2],1),a.bindBuffer(a.ARRAY_BUFFER,this.sphereVertexPositionBuffer),a.vertexAttribPointer(this.shaderProgram.vertexPositionAttribute,this.sphereVertexPositionBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.sphereNormalsPositionBuffer),a.vertexAttribPointer(this.shaderProgram.vertexNormalAttribute,this.sphereNormalsPositionBuffer.itemSize,a.FLOAT,!1,0,0),mat4.set(this.mvMatrix,this.tempMat),mat4.translate(this.mvMatrix,[b,c,d]),this.applyMatrixUniforms(a),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.sphereVertexIndexBuffer),a.drawElements(a.TRIANGLES,this.sphereVertexIndexBuffer.numItems,a.UNSIGNED_SHORT,0),mat4.set(this.tempMat,this.mvMatrix),this.applyMatrixUniforms(a)},papaya.viewer.ScreenSurface.prototype.drawOrientedText=function(a,b,c,d){null===this.orientationCanvas&&this.initOrientationBuffers(this.context),this.updateOrientedTextSquare(c,b),null===this.orientationTexture&&(this.orientationTexture=a.createTexture()),this.bindOrientation(a),a.enableVertexAttribArray(this.shaderProgram.textureCoordAttribute),a.uniform1i(this.shaderProgram.orientationText,1),a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),this.orientationContext.imageSmoothingEnabled=!0,this.orientationContext.mozImageSmoothingEnabled=!0,this.orientationContext.msImageSmoothingEnabled=!0,this.orientationContext.textAlign="center",this.orientationContext.textBaseline="middle",this.orientationContext.font=c+"px sans-serif",this.orientationContext.clearRect(0,0,this.orientationCanvas.width,this.orientationCanvas.height),this.orientationContext.fillStyle="#FFFFFF",this.orientationContext.fillText(b,this.orientationCanvas.width/2,this.orientationCanvas.height/2),mat4.set(this.mvMatrix,this.tempMat),mat4.multiplyVec3(this.mvMatrix,d),mat4.identity(this.mvMatrix),a.bindBuffer(a.ARRAY_BUFFER,this.orientationBuffer),a.vertexAttribPointer(this.shaderProgram.vertexPositionAttribute,this.orientationBuffer.itemSize,a.FLOAT,!1,0,0),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,1),a.bindTexture(a.TEXTURE_2D,this.orientationTexture),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.orientationCanvas),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_NEAREST),a.generateMipmap(a.TEXTURE_2D),a.bindTexture(a.TEXTURE_2D,null),a.bindBuffer(a.ARRAY_BUFFER,this.orientationTextureCoordBuffer),a.vertexAttribPointer(this.shaderProgram.textureCoordAttribute,this.orientationTextureCoordBuffer.itemSize,a.FLOAT,!1,0,0),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this.orientationTexture),a.uniform1i(this.shaderProgram.samplerUniform,0),mat4.translate(this.mvMatrix,d),this.applyMatrixUniforms(a),a.drawArrays(a.TRIANGLE_STRIP,0,4),mat4.set(this.tempMat,this.mvMatrix),this.applyMatrixUniforms(a),a.disable(a.BLEND),a.uniform1i(this.shaderProgram.orientationText,0),a.disableVertexAttribArray(this.shaderProgram.textureCoordAttribute)},papaya.viewer.ScreenSurface.prototype.bindOrientation=function(a){a.bindBuffer(a.ARRAY_BUFFER,this.orientationBuffer),a.bufferData(a.ARRAY_BUFFER,this.orientationVerts,a.DYNAMIC_DRAW)},papaya.viewer.ScreenSurface.prototype.bindActivePlanes=function(a){a.bindBuffer(a.ARRAY_BUFFER,this.activePlaneAxialBuffer),a.bufferData(a.ARRAY_BUFFER,this.activePlaneVertsAxial,a.DYNAMIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,this.activePlaneCoronalBuffer),a.bufferData(a.ARRAY_BUFFER,this.activePlaneVertsCoronal,a.DYNAMIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,this.activePlaneSagittalBuffer),a.bufferData(a.ARRAY_BUFFER,this.activePlaneVertsSagittal,a.DYNAMIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,this.activePlaneAxialEdgesBuffer),a.bufferData(a.ARRAY_BUFFER,this.activePlaneVertsAxialEdges,a.DYNAMIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,this.activePlaneCoronalEdgesBuffer),a.bufferData(a.ARRAY_BUFFER,this.activePlaneVertsCoronalEdges,a.DYNAMIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,this.activePlaneSagittalEdgesBuffer),a.bufferData(a.ARRAY_BUFFER,this.activePlaneVertsSagittalEdges,a.DYNAMIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,this.crosshairLineXBuffer),a.bufferData(a.ARRAY_BUFFER,this.crosshairLineVertsX,a.DYNAMIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,this.crosshairLineYBuffer),a.bufferData(a.ARRAY_BUFFER,this.crosshairLineVertsY,a.DYNAMIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,this.crosshairLineZBuffer),a.bufferData(a.ARRAY_BUFFER,this.crosshairLineVertsZ,a.DYNAMIC_DRAW)},papaya.viewer.ScreenSurface.prototype.clearDTILinesImage=function(){},papaya.viewer.ScreenSurface.prototype.findProximalRulerHandle=function(a,b){return this.pick(a,b,!0),this.grabbedRulerPoint=-1,this.pickedCoordinate&&this.rulerPoints&&(papaya.utilities.MathUtils.lineDistance3d(this.rulerPoints[0],this.rulerPoints[1],this.rulerPoints[2],this.pickedCoordinate.coordinate[0],this.pickedCoordinate.coordinate[1],this.pickedCoordinate.coordinate[2])<papaya.viewer.ScreenSlice.GRAB_RADIUS*this.scaleFactor?this.grabbedRulerPoint=0:papaya.utilities.MathUtils.lineDistance3d(this.rulerPoints[3],this.rulerPoints[4],this.rulerPoints[5],this.pickedCoordinate.coordinate[0],this.pickedCoordinate.coordinate[1],this.pickedCoordinate.coordinate[2])<papaya.viewer.ScreenSlice.GRAB_RADIUS*this.scaleFactor&&(this.grabbedRulerPoint=1)),this.grabbedRulerPoint!==-1},papaya.viewer.ScreenSurface.prototype.setStartDynamic=function(a,b){this.dynamicStartX=a,this.dynamicStartY=b},papaya.viewer.ScreenSurface.prototype.updateDynamic=function(a,b,c){var d=(b-this.dynamicStartY)*papaya.viewer.ScreenSurface.MOUSE_SENSITIVITY*c,e=(a-this.dynamicStartX)*papaya.viewer.ScreenSurface.MOUSE_SENSITIVITY*c,f=e*Math.PI/180;mat4.identity(this.mouseRotDragX),mat4.rotateY(this.mouseRotDragX,f),f=d*Math.PI/180,mat4.identity(this.mouseRotDragY),mat4.rotateX(this.mouseRotDragY,f),mat4.multiply(this.centerMat,this.mouseRotDragY,this.tempMat),mat4.multiply(this.tempMat,this.mouseRotDragX,this.tempMat2),mat4.multiply(this.tempMat2,this.centerMatInv,this.mouseRotDrag)},papaya.viewer.ScreenSurface.prototype.updateTranslateDynamic=function(a,b,c){var d=(a-this.dynamicStartX)*papaya.viewer.ScreenSurface.MOUSE_SENSITIVITY*c,e=(b-this.dynamicStartY)*papaya.viewer.ScreenSurface.MOUSE_SENSITIVITY*c*-1;mat4.identity(this.mouseTransDrag),mat4.translate(this.mouseTransDrag,[d,e,0])},papaya.viewer.ScreenSurface.prototype.updateCurrent=function(){var a=mat4.multiply(this.mouseRotDrag,this.mouseRotCurrent);mat4.set(a,this.mouseRotCurrent),a=mat4.multiply(this.mouseTransDrag,this.mouseTransCurrent),mat4.set(a,this.mouseTransCurrent),mat4.identity(this.mouseTransDrag),mat4.identity(this.mouseRotDragX),mat4.identity(this.mouseRotDragY),mat4.identity(this.mouseRotDrag)},papaya.viewer.ScreenSurface.prototype.clearTransform=function(a){return mat4.identity(a),a},papaya.viewer.ScreenSurface.prototype.makeOrientedTextSquare=function(){var a=papaya.viewer.ScreenSurface.ORIENTATION_SIZE*this.scaleFactor;this.orientationVerts[0]=-a,this.orientationVerts[1]=a,this.orientationVerts[2]=0,this.orientationVerts[3]=-a,this.orientationVerts[4]=-a,this.orientationVerts[5]=0,this.orientationVerts[6]=a,this.orientationVerts[7]=a,this.orientationVerts[8]=0,this.orientationVerts[9]=a,this.orientationVerts[10]=-a,this.orientationVerts[11]=0,this.orientationCanvas=document.createElement("canvas"),this.orientationContext=this.orientationCanvas.getContext("2d"),this.orientationContext.imageSmoothingEnabled=!0,this.orientationContext.mozImageSmoothingEnabled=!0,this.orientationContext.msImageSmoothingEnabled=!0,this.orientationContext.fillStyle="#FFFFFF",this.orientationContext.textAlign="center",this.orientationContext.textBaseline="middle"},papaya.viewer.ScreenSurface.prototype.updateOrientedTextSquare=function(a,b){var c,d,e;this.orientationContext.imageSmoothingEnabled=!0,this.orientationContext.mozImageSmoothingEnabled=!0,this.orientationContext.msImageSmoothingEnabled=!0,this.orientationContext.fillStyle="#FFFFFF",this.orientationContext.textAlign="center",this.orientationContext.textBaseline="middle",this.orientationContext.font=a+"px sans-serif",c=this.orientationContext.measureText(b).width,d=a,e=Math.max(c,d),this.orientationCanvas.width=papaya.utilities.MathUtils.getPowerOfTwo(e),this.orientationCanvas.height=papaya.utilities.MathUtils.getPowerOfTwo(e)},papaya.viewer.ScreenSurface.prototype.updateActivePlanes=function(){var a,b,c;(this.showSurfacePlanes||this.viewer.isShowingCrosshairs())&&(a=this.currentCoord.x+(this.xDim/2-this.volume.header.origin.x),b=this.yDim-this.currentCoord.y-(this.yDim/2-this.volume.header.origin.y),c=this.zDim-this.currentCoord.z-(this.zDim/2-this.volume.header.origin.z),this.activePlaneVertsAxial[0]=-this.xHalf+this.centerWorld.x,this.activePlaneVertsAxial[1]=this.yHalf+this.centerWorld.y,this.activePlaneVertsAxial[2]=c*this.zSize-this.zHalf,this.activePlaneVertsAxial[3]=-this.xHalf+this.centerWorld.x,this.activePlaneVertsAxial[4]=-this.yHalf+this.centerWorld.y,this.activePlaneVertsAxial[5]=c*this.zSize-this.zHalf,this.activePlaneVertsAxial[6]=this.xHalf+this.centerWorld.x,this.activePlaneVertsAxial[7]=this.yHalf+this.centerWorld.y,this.activePlaneVertsAxial[8]=c*this.zSize-this.zHalf,this.activePlaneVertsAxial[9]=this.xHalf+this.centerWorld.x,this.activePlaneVertsAxial[10]=-this.yHalf+this.centerWorld.y,this.activePlaneVertsAxial[11]=c*this.zSize-this.zHalf,this.activePlaneVertsAxialEdges[0]=-this.xHalf+this.centerWorld.x,this.activePlaneVertsAxialEdges[1]=this.yHalf+this.centerWorld.y,this.activePlaneVertsAxialEdges[2]=c*this.zSize-this.zHalf,this.activePlaneVertsAxialEdges[3]=-this.xHalf+this.centerWorld.x,this.activePlaneVertsAxialEdges[4]=-this.yHalf+this.centerWorld.y,this.activePlaneVertsAxialEdges[5]=c*this.zSize-this.zHalf,this.activePlaneVertsAxialEdges[6]=-this.xHalf+this.centerWorld.x,this.activePlaneVertsAxialEdges[7]=-this.yHalf+this.centerWorld.y,this.activePlaneVertsAxialEdges[8]=c*this.zSize-this.zHalf,this.activePlaneVertsAxialEdges[9]=this.xHalf+this.centerWorld.x,this.activePlaneVertsAxialEdges[10]=-this.yHalf+this.centerWorld.y,this.activePlaneVertsAxialEdges[11]=c*this.zSize-this.zHalf,this.activePlaneVertsAxialEdges[12]=this.xHalf+this.centerWorld.x,this.activePlaneVertsAxialEdges[13]=-this.yHalf+this.centerWorld.y,this.activePlaneVertsAxialEdges[14]=c*this.zSize-this.zHalf,this.activePlaneVertsAxialEdges[15]=this.xHalf+this.centerWorld.x,this.activePlaneVertsAxialEdges[16]=this.yHalf+this.centerWorld.y,this.activePlaneVertsAxialEdges[17]=c*this.zSize-this.zHalf,this.activePlaneVertsAxialEdges[18]=this.xHalf+this.centerWorld.x,this.activePlaneVertsAxialEdges[19]=this.yHalf+this.centerWorld.y,this.activePlaneVertsAxialEdges[20]=c*this.zSize-this.zHalf,this.activePlaneVertsAxialEdges[21]=-this.xHalf+this.centerWorld.x,this.activePlaneVertsAxialEdges[22]=this.yHalf+this.centerWorld.y,this.activePlaneVertsAxialEdges[23]=c*this.zSize-this.zHalf,this.activePlaneVertsCoronal[0]=-this.xHalf+this.centerWorld.x,this.activePlaneVertsCoronal[1]=b*this.ySize-this.yHalf,this.activePlaneVertsCoronal[2]=this.zHalf+this.centerWorld.z,this.activePlaneVertsCoronal[3]=-this.xHalf+this.centerWorld.x,this.activePlaneVertsCoronal[4]=b*this.ySize-this.yHalf,this.activePlaneVertsCoronal[5]=-this.zHalf+this.centerWorld.z,this.activePlaneVertsCoronal[6]=this.xHalf+this.centerWorld.x,this.activePlaneVertsCoronal[7]=b*this.ySize-this.yHalf,this.activePlaneVertsCoronal[8]=this.zHalf+this.centerWorld.z,this.activePlaneVertsCoronal[9]=this.xHalf+this.centerWorld.x,this.activePlaneVertsCoronal[10]=b*this.ySize-this.yHalf,this.activePlaneVertsCoronal[11]=-this.zHalf+this.centerWorld.z,this.activePlaneVertsCoronalEdges[0]=-this.xHalf+this.centerWorld.x,this.activePlaneVertsCoronalEdges[1]=b*this.ySize-this.yHalf,this.activePlaneVertsCoronalEdges[2]=this.zHalf+this.centerWorld.z,this.activePlaneVertsCoronalEdges[3]=-this.xHalf+this.centerWorld.x,this.activePlaneVertsCoronalEdges[4]=b*this.ySize-this.yHalf,this.activePlaneVertsCoronalEdges[5]=-this.zHalf+this.centerWorld.z,this.activePlaneVertsCoronalEdges[6]=-this.xHalf+this.centerWorld.x,this.activePlaneVertsCoronalEdges[7]=b*this.ySize-this.yHalf,this.activePlaneVertsCoronalEdges[8]=-this.zHalf+this.centerWorld.z,this.activePlaneVertsCoronalEdges[9]=this.xHalf+this.centerWorld.x,this.activePlaneVertsCoronalEdges[10]=b*this.ySize-this.yHalf,this.activePlaneVertsCoronalEdges[11]=-this.zHalf+this.centerWorld.z,this.activePlaneVertsCoronalEdges[12]=this.xHalf+this.centerWorld.x,this.activePlaneVertsCoronalEdges[13]=b*this.ySize-this.yHalf,this.activePlaneVertsCoronalEdges[14]=-this.zHalf+this.centerWorld.z,this.activePlaneVertsCoronalEdges[15]=this.xHalf+this.centerWorld.x,this.activePlaneVertsCoronalEdges[16]=b*this.ySize-this.yHalf,this.activePlaneVertsCoronalEdges[17]=this.zHalf+this.centerWorld.z,this.activePlaneVertsCoronalEdges[18]=this.xHalf+this.centerWorld.x,this.activePlaneVertsCoronalEdges[19]=b*this.ySize-this.yHalf,this.activePlaneVertsCoronalEdges[20]=this.zHalf+this.centerWorld.z,this.activePlaneVertsCoronalEdges[21]=-this.xHalf+this.centerWorld.x,this.activePlaneVertsCoronalEdges[22]=b*this.ySize-this.yHalf,this.activePlaneVertsCoronalEdges[23]=this.zHalf+this.centerWorld.z,this.activePlaneVertsSagittal[0]=a*this.xSize-this.xHalf,this.activePlaneVertsSagittal[1]=-this.yHalf+this.centerWorld.y,this.activePlaneVertsSagittal[2]=this.zHalf+this.centerWorld.z,this.activePlaneVertsSagittal[3]=a*this.xSize-this.xHalf,this.activePlaneVertsSagittal[4]=-this.yHalf+this.centerWorld.y,this.activePlaneVertsSagittal[5]=-this.zHalf+this.centerWorld.z,this.activePlaneVertsSagittal[6]=a*this.xSize-this.xHalf,this.activePlaneVertsSagittal[7]=this.yHalf+this.centerWorld.y,this.activePlaneVertsSagittal[8]=this.zHalf+this.centerWorld.z,this.activePlaneVertsSagittal[9]=a*this.xSize-this.xHalf,this.activePlaneVertsSagittal[10]=this.yHalf+this.centerWorld.y,this.activePlaneVertsSagittal[11]=-this.zHalf+this.centerWorld.z,this.activePlaneVertsSagittalEdges[0]=a*this.xSize-this.xHalf,this.activePlaneVertsSagittalEdges[1]=-this.yHalf+this.centerWorld.y,this.activePlaneVertsSagittalEdges[2]=this.zHalf+this.centerWorld.z,this.activePlaneVertsSagittalEdges[3]=a*this.xSize-this.xHalf,this.activePlaneVertsSagittalEdges[4]=-this.yHalf+this.centerWorld.y,this.activePlaneVertsSagittalEdges[5]=-this.zHalf+this.centerWorld.z,this.activePlaneVertsSagittalEdges[6]=a*this.xSize-this.xHalf,this.activePlaneVertsSagittalEdges[7]=-this.yHalf+this.centerWorld.y,this.activePlaneVertsSagittalEdges[8]=-this.zHalf+this.centerWorld.z,this.activePlaneVertsSagittalEdges[9]=a*this.xSize-this.xHalf,this.activePlaneVertsSagittalEdges[10]=this.yHalf+this.centerWorld.y,this.activePlaneVertsSagittalEdges[11]=-this.zHalf+this.centerWorld.z,this.activePlaneVertsSagittalEdges[12]=a*this.xSize-this.xHalf,this.activePlaneVertsSagittalEdges[13]=this.yHalf+this.centerWorld.y,this.activePlaneVertsSagittalEdges[14]=-this.zHalf+this.centerWorld.z,this.activePlaneVertsSagittalEdges[15]=a*this.xSize-this.xHalf,this.activePlaneVertsSagittalEdges[16]=this.yHalf+this.centerWorld.y,this.activePlaneVertsSagittalEdges[17]=this.zHalf+this.centerWorld.z,this.activePlaneVertsSagittalEdges[18]=a*this.xSize-this.xHalf,this.activePlaneVertsSagittalEdges[19]=this.yHalf+this.centerWorld.y,this.activePlaneVertsSagittalEdges[20]=this.zHalf+this.centerWorld.z,this.activePlaneVertsSagittalEdges[21]=a*this.xSize-this.xHalf,this.activePlaneVertsSagittalEdges[22]=-this.yHalf+this.centerWorld.y,this.activePlaneVertsSagittalEdges[23]=this.zHalf+this.centerWorld.z,this.crosshairLineVertsZ[0]=a*this.xSize-this.xHalf,this.crosshairLineVertsZ[1]=b*this.ySize-this.yHalf,this.crosshairLineVertsZ[2]=-this.zHalf+this.centerWorld.z,this.crosshairLineVertsZ[3]=a*this.xSize-this.xHalf,this.crosshairLineVertsZ[4]=b*this.ySize-this.yHalf,this.crosshairLineVertsZ[5]=this.zHalf+this.centerWorld.z,this.crosshairLineVertsY[0]=a*this.xSize-this.xHalf,this.crosshairLineVertsY[1]=-this.yHalf+this.centerWorld.y,this.crosshairLineVertsY[2]=c*this.zSize-this.zHalf,this.crosshairLineVertsY[3]=a*this.xSize-this.xHalf,this.crosshairLineVertsY[4]=this.yHalf+this.centerWorld.y,this.crosshairLineVertsY[5]=c*this.zSize-this.zHalf,this.crosshairLineVertsX[0]=-this.xHalf+this.centerWorld.x,this.crosshairLineVertsX[1]=b*this.ySize-this.yHalf,this.crosshairLineVertsX[2]=c*this.zSize-this.zHalf,this.crosshairLineVertsX[3]=this.xHalf+this.centerWorld.x,this.crosshairLineVertsX[4]=b*this.ySize-this.yHalf,this.crosshairLineVertsX[5]=c*this.zSize-this.zHalf,this.needsUpdateActivePlanes=!0)},papaya.viewer.ScreenSurface.prototype.pick=function(a,b,c){return this.needsPick=!0,this.pickLocX=a,this.pickLocY=b,this.draw(),c?this.pickedCoordinate:(this.draw(),this.pickedCoordinate)},papaya.viewer.ScreenSurface.prototype.pickRuler=function(a,b){return this.needsPick=!0,this.pickLocX=a,this.pickLocY=b,this.draw(),this.pickedCoordinate&&(this.rulerPoints[3*this.grabbedRulerPoint]=this.pickedCoordinate.coordinate[0],this.rulerPoints[3*this.grabbedRulerPoint+1]=this.pickedCoordinate.coordinate[1],this.rulerPoints[3*this.grabbedRulerPoint+2]=this.pickedCoordinate.coordinate[2],this.draw()),this.pickedCoordinate},papaya.viewer.ScreenSurface.prototype.pickColor=function(a,b){return this.needsPickColor=!0,this.pickLocX=a,this.pickLocY=b,this.draw(),this.draw(),this.pickedColor},papaya.viewer.ScreenSurface.prototype.findPickedCoordinate=function(a,b,c){var d,e,f,g=b,h=a.viewportHeight-1-c,i=[];return a.readPixels(g,h,1,1,a.RGBA,a.UNSIGNED_BYTE,this.pickingBuffer),d=this.unpackFloatFromVec4i(this.pickingBuffer)/255,d>=1?null:(e=[0,0,a.viewportWidth,a.viewportHeight],f=GLU.unProject(g,h,d,this.mvMatrix,this.pMatrix,e,i),f?{coordinate:i,depth:d}:null)},papaya.viewer.ScreenSurface.prototype.findInitialRulerPoints=function(a){var b,c,d,e,f,g=a.viewportWidth,h=a.viewportHeight,i=[],j=[];for(e=1;e<5;e+=1)c=parseInt(.1*g*e,10),d=parseInt(.1*h*e,10),b=this.pick(c,d,!0),b&&i.push(b),c=parseInt(g-.1*g*e,10),d=parseInt(.1*h*e,10),b=this.pick(c,d,!0),b&&i.push(b),c=parseInt(g-.1*g*e,10),d=parseInt(h-.1*h*e,10),b=this.pick(c,d,!0),b&&i.push(b),c=parseInt(.1*g*e,10),d=parseInt(h-.1*h*e,10),b=this.pick(c,d,!0),b&&i.push(b);if(i<2)return!1;for(f=0,e=0;e<i.length;e+=1)i[e].depth<i[f].depth&&(f=e);for(j.push(i[f].coordinate),i.splice(f,1),f=0,e=0;e<i.length;e+=1)i[e].depth<i[f].depth&&(f=e);return j.push(i[f].coordinate),this.rulerPoints[0]=j[0][0],this.rulerPoints[1]=j[0][1],this.rulerPoints[2]=j[0][2],this.rulerPoints[3]=j[1][0],this.rulerPoints[4]=j[1][1],this.rulerPoints[5]=j[1][2],!0},papaya.viewer.ScreenSurface.prototype.findPickedColor=function(a){var b;return a.readPixels(0,0,a.viewportWidth,a.viewportHeight,a.RGBA,a.UNSIGNED_BYTE,this.pickingBuffer),b=(a.viewportHeight-1-this.pickLocY)*a.viewportWidth*4+4*this.pickLocX,[this.pickingBuffer[b],this.pickingBuffer[b+1],this.pickingBuffer[b+2]]},papaya.viewer.ScreenSurface.prototype.getBackgroundColor=function(){return"rgba("+parseInt(255*this.backgroundColor[0]+.5)+","+parseInt(255*this.backgroundColor[1]+.5)+","+parseInt(255*this.backgroundColor[2]+.5)+",255)"},papaya.viewer.ScreenSurface.prototype.updatePreferences=function(){this.updateBackgroundColor()},papaya.viewer.ScreenSurface.prototype.updateBackgroundColor=function(){var a=this.viewer.container.preferences.surfaceBackgroundColor;"Black"===a?this.backgroundColor=[0,0,0]:"Dark Gray"===a?this.backgroundColor=[.25,.25,.25]:"Gray"===a?this.backgroundColor=[.5,.5,.5]:"Light Gray"===a?this.backgroundColor=[.75,.75,.75]:"White"===a?this.backgroundColor=[1,1,1]:this.backgroundColor=papaya.viewer.ScreenSurface.DEFAULT_BACKGROUND},papaya.viewer.ScreenSurface.prototype.isMainView=function(){return this.viewer.mainImage===this.viewer.surfaceView},papaya.viewer.ScreenSurface.prototype.processParams=function(a){this.viewer.container.isDesktopMode()||void 0!==a.surfaceBackground&&(this.viewer.container.preferences.surfaceBackgroundColor=a.surfaceBackground)},papaya.viewer.ScreenSurface.prototype.makeSphere=function(a,b,c){var d,e,f=[],g=[];for(d=0;d<=a;d++){var h=d*Math.PI/a,i=Math.sin(h),j=Math.cos(h);for(e=0;e<=b;e++){var k=2*e*Math.PI/b,l=Math.sin(k),m=Math.cos(k),n=m*i,o=j,p=l*i;g.push(n),g.push(o),g.push(p),f.push(c*n),f.push(c*o),f.push(c*p)}}var q=[];for(d=0;d<a;d++)for(e=0;e<b;e++){var r=d*(b+1)+e,s=r+b+1;q.push(r),q.push(s),q.push(r+1),q.push(s),q.push(s+1),q.push(r+1)}return{vertices:f,normals:g,indices:q}},papaya.viewer.ScreenSurface.prototype.getRulerLength=function(){return papaya.utilities.MathUtils.lineDistance3d(this.rulerPoints[0],this.rulerPoints[1],this.rulerPoints[2],this.rulerPoints[3],this.rulerPoints[4],this.rulerPoints[5])};var papaya=papaya||{};papaya.viewer=papaya.viewer||{},papaya.viewer.ScreenVolume=papaya.viewer.ScreenVolume||function(a,b,c,d,e,f){this.volume=a,this.lutName=c,this.colorTable=new papaya.viewer.ColorTable(this.lutName,d),this.screenMin=this.volume.header.imageRange.displayMin,this.screenMax=this.volume.header.imageRange.displayMax,this.imageMin=this.volume.header.imageRange.imageMin,this.imageMax=this.volume.header.imageRange.imageMax,this.alpha=1,this.currentTimepoint=0,this.parametric=void 0!==e&&e,this.negativeScreenVol=null,this.dti=!1,this.dtiLines=!1,this.dtiColors=!0,this.dtiVolumeMod=null,this.dtiAlphaFactor=1,this.rgb=this.volume.header.imageType.datatype===papaya.volume.ImageType.DATATYPE_RGB,this.hasCheckedImageRange=!1,this.interpolation=!0,this.error=null,this.hidden=!1,this.rotationX=.5,this.rotationY=.5,this.rotationZ=.5,this.rotationAbout="Rotate About Center",this.isHighResSlice=this.volume.header.imageDimensions.getNumVoxelsSlice()>262144,this.currentCoord=f;var g=b[this.volume.fileName];g?(void 0!==g.interpolation&&(this.interpolation=g.interpolation),void 0!==g.dti&&(this.dti=g.dti,this.dti&&3!==this.volume.numTimepoints&&(this.error=new Error("DTI vector series must have 3 series points!")),this.dti&&(this.dtiLines=g.dtiLines,this.dtiColors=g.dtiColors,this.dtiLines||this.dtiColors||(this.dtiColors=!0),this.initDTI())),void 0!==g.min&&void 0!==g.max?e?(this.screenMin=-1*Math.abs(g.min),this.screenMax=-1*Math.abs(g.max)):(this.screenMin=g.min,this.screenMax=g.max):this.findDisplayRange(e,g),e?void 0!==g.negative_lut&&(this.lutName=g.negative_lut,this.colorTable=new papaya.viewer.ColorTable(this.lutName,d)):void 0!==g.lut&&("string"==typeof g.lut||g.lut instanceof String?(this.lutName=g.lut,this.colorTable=new papaya.viewer.ColorTable(this.lutName,d)):(this.lutName="Object",this.colorTable=g.lut)),void 0===g.alpha||d||(this.alpha=g.alpha),d&&(void 0!==g.rotation&&g.rotation.length&&3===g.rotation.length&&(this.rotationX=(Math.min(Math.max(g.rotation[0],-90),90)+90)/180,this.rotationY=(Math.min(Math.max(g.rotation[1],-90),90)+90)/180,this.rotationZ=(Math.min(Math.max(g.rotation[2],-90),90)+90)/180),g.rotationPoint&&("origin"===g.rotationPoint.toLowerCase()?this.rotationAbout="Rotate About Origin":"crosshairs"===g.rotationPoint.toLowerCase()?this.rotationAbout="Rotate About Crosshairs":this.rotationAbout="Rotate About Center"),this.updateTransform())):this.findDisplayRange(e,{}),this.negative=!1,this.updateScreenRange(),this.canvasIcon=document.createElement("canvas"),this.canvasIcon.width=papaya.viewer.ColorTable.ICON_SIZE,this.canvasIcon.height=papaya.viewer.ColorTable.ICON_SIZE,this.contextIcon=this.canvasIcon.getContext("2d"),this.imageDataIcon=this.contextIcon.createImageData(papaya.viewer.ColorTable.ICON_SIZE,papaya.viewer.ColorTable.ICON_SIZE),this.icon=null,this.canvasBar=document.createElement("canvas"),this.canvasBar.width=papaya.viewer.ColorTable.COLOR_BAR_WIDTH,this.canvasBar.height=papaya.viewer.ColorTable.COLOR_BAR_HEIGHT,this.contextBar=this.canvasBar.getContext("2d"),this.imageDataBar=this.contextBar.createImageData(papaya.viewer.ColorTable.COLOR_BAR_WIDTH,papaya.viewer.ColorTable.COLOR_BAR_HEIGHT),this.colorBar=null,this.updateIcon(),this.updateColorBar()},papaya.viewer.ScreenVolume.makeSolidIcon=function(a,b,c){var d=document.createElement("canvas");d.width=papaya.viewer.ColorTable.ICON_SIZE,d.height=papaya.viewer.ColorTable.ICON_SIZE;var e=d.getContext("2d");return e.fillStyle="rgb("+parseInt(255*a,10)+","+parseInt(255*b,10)+","+parseInt(255*c,10)+")",e.fillRect(0,0,papaya.viewer.ColorTable.ICON_SIZE,papaya.viewer.ColorTable.ICON_SIZE),d.toDataURL()},papaya.viewer.ScreenVolume.prototype.setScreenRange=function(a,b){this.screenMin=a,this.screenMax=b,this.updateScreenRange()},papaya.viewer.ScreenVolume.prototype.setScreenRangeNegatives=function(a,b){this.negativeScreenVol.setScreenRange(a,b)},papaya.viewer.ScreenVolume.prototype.updateScreenRange=function(){this.screenRatio=papaya.viewer.ScreenSlice.SCREEN_PIXEL_MAX/(this.screenMax-this.screenMin),this.negative=this.screenMax<this.screenMin},papaya.viewer.ScreenVolume.prototype.isOverlay=function(){return!this.colorTable.isBaseImage},papaya.viewer.ScreenVolume.prototype.findImageRange=function(){var a,b,c,d,e,f,g,h,i,j;if(a=this.volume.header.imageRange.imageMin!==this.volume.header.imageRange.imageMax,!a&&!this.hasCheckedImageRange){for(this.hasCheckedImageRange=!0,b=Number.MAX_VALUE,c=Number.MIN_VALUE,d=this.volume.header.imageDimensions.xDim,e=this.volume.header.imageDimensions.yDim,f=this.volume.header.imageDimensions.zDim,g=0;g<f;g+=1)for(h=0;h<e;h+=1)for(i=0;i<d;i+=1)j=this.volume.getVoxelAtIndexNative(i,h,g,0,!0),j>c&&(c=j),j<b&&(b=j);
this.volume.header.imageRange.imageMin=this.imageMin=b,this.volume.header.imageRange.imageMax=this.imageMax=c}},papaya.viewer.ScreenVolume.prototype.findDisplayRange=function(a,b){var c,d,e,f;c=this.volume.header.imageRange.imageMin!==this.volume.header.imageRange.imageMax,d=this.screenMin,e=this.screenMax,a&&Math.abs(d)>Math.abs(e)&&(f=e,e=d,d=f),a||void 0===b.minPercent&&void 0===b.maxPercent?this.isOverlay()?((d===e||d<0&&e>0||d>0&&e<0||a&&(d>0||e>0)||b.symmetric)&&(this.findImageRange(),a?b.symmetric||0===this.imageMin?(d=-1*(this.imageMax-.75*this.imageMax),e=-1*(this.imageMax-.25*this.imageMax)):(d=this.imageMin-.75*this.imageMin,e=this.imageMin-.25*this.imageMin):(d=this.imageMax-.75*this.imageMax,e=this.imageMax-.25*this.imageMax)),d<1&&d>-1&&e<1&&e>-1||(d=Math.round(d),e=Math.round(e))):(d<1&&d>-1&&e<1&&e>-1||(d=Math.round(d),e=Math.round(e)),0===d&&0===e&&(this.findImageRange(),d=this.imageMin,e=this.imageMax),e<=d&&(this.findImageRange(),d=this.imageMin,e=this.imageMax),c&&d<this.imageMin&&(this.findImageRange(),d=this.imageMin),c&&e>this.imageMax&&(this.findImageRange(),e=this.imageMax)):(this.findImageRange(),d=void 0!==b.minPercent?this.imageMax*b.minPercent:this.imageMin,e=void 0!==b.maxPercent?this.imageMax*b.maxPercent:this.imageMax),this.screenMin=d,this.screenMax=e},papaya.viewer.ScreenVolume.prototype.isUsingColorTable=function(a){return this.lutName===a},papaya.viewer.ScreenVolume.prototype.isRotatingAbout=function(a){return this.rotationAbout===a},papaya.viewer.ScreenVolume.prototype.changeColorTable=function(a,b){this.colorTable=new papaya.viewer.ColorTable(b,(!this.isOverlay())),this.lutName=b,this.updateIcon(),this.updateColorBar(),a.drawViewer(!0)},papaya.viewer.ScreenVolume.prototype.getRange=function(){var a=new Array(2);return a[0]=this.colorTable.minLUT/(255/(this.screenMax-this.screenMin))+this.screenMin,a[1]=this.colorTable.maxLUT/(255/(this.screenMax-this.screenMin))+this.screenMin,a},papaya.viewer.ScreenVolume.prototype.getRangeNegative=function(){return this.negativeScreenVol.getRange()},papaya.viewer.ScreenVolume.prototype.getAlphaNegative=function(){return this.negativeScreenVol.alpha},papaya.viewer.ScreenVolume.prototype.incrementTimepoint=function(){var a=this.volume.numTimepoints;this.currentTimepoint+=1,this.currentTimepoint>=a&&(this.currentTimepoint=a-1)},papaya.viewer.ScreenVolume.prototype.decrementTimepoint=function(){this.currentTimepoint-=1,this.currentTimepoint<0&&(this.currentTimepoint=0)},papaya.viewer.ScreenVolume.prototype.setTimepoint=function(a){a<0?this.currentTimepoint=0:a>=this.volume.numTimepoints?this.currentTimepoint=this.volume.numTimepoints-1:this.currentTimepoint=a},papaya.viewer.ScreenVolume.prototype.updateMinLUT=function(a){this.colorTable.updateMinLUT(a)},papaya.viewer.ScreenVolume.prototype.updateMaxLUT=function(a){this.colorTable.updateMaxLUT(a)},papaya.viewer.ScreenVolume.prototype.updateLUT=function(a,b){this.colorTable.updateLUT(a,b)},papaya.viewer.ScreenVolume.prototype.supportsDynamicColorTable=function(){return void 0!==this.colorTable.updateMinLUT&&void 0!==this.colorTable.updateMaxLUT&&void 0!==this.colorTable.updateLUT},papaya.viewer.ScreenVolume.prototype.resetDynamicRange=function(){this.colorTable.minLUT=0,this.colorTable.maxLUT=papaya.viewer.ColorTable.LUT_MAX,this.updateLUT(this.colorTable.minLUT,this.colorTable.maxLUT),this.updateColorBar()},papaya.viewer.ScreenVolume.prototype.getCurrentTime=function(){return this.currentTimepoint*(this.volume.header.voxelDimensions.timeSize*this.volume.header.voxelDimensions.getTemporalUnitMultiplier())},papaya.viewer.ScreenVolume.prototype.setCurrentTime=function(a){var b=this.volume.header.voxelDimensions.timeSize*this.volume.header.voxelDimensions.getTemporalUnitMultiplier();0===b?this.setTimepoint(0):this.setTimepoint(parseInt(Math.round(a/b),10))},papaya.viewer.ScreenVolume.prototype.hasError=function(){return null!==this.error},papaya.viewer.ScreenVolume.prototype.initDTI=function(){this.volume.numTimepoints=1,this.volume.header.imageDimensions.timepoints=1,this.colorTable=new papaya.viewer.ColorTable(this.lutName,(!1),papaya.viewer.ColorTable.TABLE_DTI_SPECTRUM),this.volume.transform.voxelValue.forceABS=!this.dtiLines,this.updateIcon()},papaya.viewer.ScreenVolume.prototype.isDTILines=function(){return this.dtiLines&&!this.dtiColors},papaya.viewer.ScreenVolume.prototype.isDTIRGB=function(){return!this.dtiLines&&this.dtiColors},papaya.viewer.ScreenVolume.prototype.isDTILinesAndRGB=function(){return this.dtiLines&&this.dtiColors},papaya.viewer.ScreenVolume.prototype.getHiddenLabel=function(){return this.hidden?"Show Overlay":"Hide Overlay"},papaya.viewer.ScreenVolume.prototype.updateIcon=function(){var a,b,c,d,e;if(this.imageDataIcon){for(a=papaya.viewer.ColorTable.LUT_MAX/papaya.viewer.ColorTable.ICON_SIZE,b=0;b<papaya.viewer.ColorTable.ICON_SIZE;b+=1)for(c=0;c<papaya.viewer.ColorTable.ICON_SIZE;c+=1)d=4*(b*papaya.viewer.ColorTable.ICON_SIZE+c),e=Math.round(c*a),this.imageDataIcon.data[d]=this.colorTable.lookupRed(e),this.imageDataIcon.data[d+1]=this.colorTable.lookupGreen(e),this.imageDataIcon.data[d+2]=this.colorTable.lookupBlue(e),this.imageDataIcon.data[d+3]=255;this.contextIcon.putImageData(this.imageDataIcon,0,0),this.icon=this.canvasIcon.toDataURL()}},papaya.viewer.ScreenVolume.prototype.updateColorBar=function(){var a,b,c,d,e;if(this.imageDataBar){for(a=papaya.viewer.ColorTable.LUT_MAX/papaya.viewer.ColorTable.COLOR_BAR_WIDTH,b=0;b<papaya.viewer.ColorTable.COLOR_BAR_HEIGHT;b+=1)for(c=0;c<papaya.viewer.ColorTable.COLOR_BAR_WIDTH;c+=1)d=4*(b*papaya.viewer.ColorTable.COLOR_BAR_WIDTH+c),e=Math.round(c*a),this.imageDataBar.data[d]=this.colorTable.lookupRed(e),this.imageDataBar.data[d+1]=this.colorTable.lookupGreen(e),this.imageDataBar.data[d+2]=this.colorTable.lookupBlue(e),this.imageDataBar.data[d+3]=255;this.contextBar.putImageData(this.imageDataBar,0,0),this.colorBar=this.canvasBar.toDataURL()}},papaya.viewer.ScreenVolume.prototype.updateTransform=function(){var a,b,c,d=180*(this.rotationX-.5),e=180*(this.rotationY-.5),f=180*(this.rotationZ-.5);"Rotate About Origin"===this.rotationAbout?(a=this.volume.header.origin.x*this.volume.header.voxelDimensions.xSize,b=this.volume.header.origin.y*this.volume.header.voxelDimensions.ySize,c=this.volume.header.origin.z*this.volume.header.voxelDimensions.zSize):"Rotate About Crosshairs"===this.rotationAbout?(a=this.currentCoord.x*this.volume.header.voxelDimensions.xSize,b=this.currentCoord.y*this.volume.header.voxelDimensions.ySize,c=this.currentCoord.z*this.volume.header.voxelDimensions.zSize):(a=this.volume.header.imageDimensions.xDim/2*this.volume.header.voxelDimensions.xSize,b=this.volume.header.imageDimensions.yDim/2*this.volume.header.voxelDimensions.ySize,c=this.volume.header.imageDimensions.zDim/2*this.volume.header.voxelDimensions.zSize),this.volume.transform.updateImageMat(a,b,c,d,e,f)},papaya.viewer.ScreenVolume.prototype.resetTransform=function(){this.rotationX=.5,this.rotationY=.5,this.rotationZ=.5};var papaya=papaya||{};papaya.viewer=papaya.viewer||{};var PAPAYA_BUILD_NUM=PAPAYA_BUILD_NUM||"0";papaya.viewer.Viewer=papaya.viewer.Viewer||function(a,b,c,d){this.container=a,this.canvas=document.createElement("canvas"),this.canvas.width=b,this.canvas.height=c,this.context=this.canvas.getContext("2d"),this.canvas.style.padding=0,this.canvas.style.margin=0,this.canvas.style.border="none",this.atlas=null,this.initialized=!1,this.pageLoaded=!1,this.loadingVolume=null,this.volume=new papaya.volume.Volume(this.container.display,this),this.screenVolumes=[],this.surfaces=[],this.currentScreenVolume=null,this.axialSlice=null,this.coronalSlice=null,this.sagittalSlice=null,this.surfaceView=null,this.selectedSlice=null,this.mainImage=null,this.lowerImageBot2=null,this.lowerImageBot=null,this.lowerImageTop=null,this.viewerDim=0,this.worldSpace=!1,this.currentCoord=new papaya.core.Coordinate(0,0,0),this.cursorPosition=new papaya.core.Coordinate(0,0,0),this.longestDim=0,this.longestDimSize=0,this.draggingSliceDir=0,this.isDragging=!1,this.isWindowControl=!1,this.isZoomMode=!1,this.isContextMode=!1,this.isPanning=!1,this.didLongTouch=!1,this.isLongTouch=!1,this.zoomFactor=papaya.viewer.Viewer.ZOOM_FACTOR_MIN,this.zoomFactorPrevious=papaya.viewer.Viewer.ZOOM_FACTOR_MIN,this.zoomLocX=0,this.zoomLocY=0,this.zoomLocZ=0,this.panLocX=0,this.panLocY=0,this.panLocZ=0,this.panAmountX=0,this.panAmountY=0,this.panAmountZ=0,this.keyPressIgnored=!1,this.previousMousePosition=new papaya.core.Point,this.isControlKeyDown=!1,this.isAltKeyDown=!1,this.isShiftKeyDown=!1,this.toggleMainCrosshairs=!0,this.bgColor=null,this.hasSeries=!1,this.controlsHidden=!1,this.loadingDTI=!1,this.loadingDTIModRef=null,this.tempCoor=new papaya.core.Coordinate,this.listenerContextMenu=function(a){return a.preventDefault(),!1},this.listenerMouseMove=papaya.utilities.ObjectUtils.bind(this,this.mouseMoveEvent),this.listenerMouseDown=papaya.utilities.ObjectUtils.bind(this,this.mouseDownEvent),this.listenerMouseOut=papaya.utilities.ObjectUtils.bind(this,this.mouseOutEvent),this.listenerMouseLeave=papaya.utilities.ObjectUtils.bind(this,this.mouseLeaveEvent),this.listenerMouseUp=papaya.utilities.ObjectUtils.bind(this,this.mouseUpEvent),this.listenerMouseDoubleClick=papaya.utilities.ObjectUtils.bind(this,this.mouseDoubleClickEvent),this.listenerKeyDown=papaya.utilities.ObjectUtils.bind(this,this.keyDownEvent),this.listenerKeyUp=papaya.utilities.ObjectUtils.bind(this,this.keyUpEvent),this.listenerTouchMove=papaya.utilities.ObjectUtils.bind(this,this.touchMoveEvent),this.listenerTouchStart=papaya.utilities.ObjectUtils.bind(this,this.touchStartEvent),this.listenerTouchEnd=papaya.utilities.ObjectUtils.bind(this,this.touchEndEvent),this.initialCoordinate=null,this.listenerScroll=papaya.utilities.ObjectUtils.bind(this,this.scrolled),this.longTouchTimer=null,this.updateTimer=null,this.updateTimerEvent=null,this.drawEmptyViewer(),this.processParams(d)},papaya.viewer.Viewer.GAP=PAPAYA_SPACING,papaya.viewer.Viewer.BACKGROUND_COLOR="rgba(0, 0, 0, 255)",papaya.viewer.Viewer.CROSSHAIRS_COLOR="rgba(228, 173, 0, 255)",papaya.viewer.Viewer.KEYCODE_ROTATE_VIEWS=32,papaya.viewer.Viewer.KEYCODE_CENTER=67,papaya.viewer.Viewer.KEYCODE_ORIGIN=79,papaya.viewer.Viewer.KEYCODE_ARROW_UP=38,papaya.viewer.Viewer.KEYCODE_ARROW_DOWN=40,papaya.viewer.Viewer.KEYCODE_ARROW_RIGHT=39,papaya.viewer.Viewer.KEYCODE_ARROW_LEFT=37,papaya.viewer.Viewer.KEYCODE_PAGE_UP=33,papaya.viewer.Viewer.KEYCODE_PAGE_DOWN=34,papaya.viewer.Viewer.KEYCODE_SINGLE_QUOTE=222,papaya.viewer.Viewer.KEYCODE_FORWARD_SLASH=191,papaya.viewer.Viewer.KEYCODE_INCREMENT_MAIN=71,papaya.viewer.Viewer.KEYCODE_DECREMENT_MAIN=86,papaya.viewer.Viewer.KEYCODE_TOGGLE_CROSSHAIRS=65,papaya.viewer.Viewer.KEYCODE_SERIES_BACK=188,papaya.viewer.Viewer.KEYCODE_SERIES_FORWARD=190,papaya.viewer.Viewer.KEYCODE_RULER=82,papaya.viewer.Viewer.MAX_OVERLAYS=8,papaya.viewer.Viewer.ORIENTATION_MARKER_SUPERIOR="S",papaya.viewer.Viewer.ORIENTATION_MARKER_INFERIOR="I",papaya.viewer.Viewer.ORIENTATION_MARKER_ANTERIOR="A",papaya.viewer.Viewer.ORIENTATION_MARKER_POSTERIOR="P",papaya.viewer.Viewer.ORIENTATION_MARKER_LEFT="R",papaya.viewer.Viewer.ORIENTATION_MARKER_RIGHT="L",papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE=16,papaya.viewer.Viewer.ORIENTATION_CERTAINTY_UNKNOWN_COLOR="red",papaya.viewer.Viewer.ORIENTATION_CERTAINTY_LOW_COLOR="yellow",papaya.viewer.Viewer.ORIENTATION_CERTAINTY_HIGH_COLOR="white",papaya.viewer.Viewer.UPDATE_TIMER_INTERVAL=250,papaya.viewer.Viewer.ZOOM_FACTOR_MAX=10,papaya.viewer.Viewer.ZOOM_FACTOR_MIN=1,papaya.viewer.Viewer.MOUSE_SCROLL_THRESHLD=.25,papaya.viewer.Viewer.TITLE_MAX_LENGTH=30,papaya.viewer.Viewer.validDimBounds=function(a,b){return a<b?a:b-1},papaya.viewer.Viewer.getKeyCode=function(a){return a.keyCode||a.charCode},papaya.viewer.Viewer.isControlKey=function(a){var b=papaya.viewer.Viewer.getKeyCode(a);return"MacOS"===papaya.utilities.PlatformUtils.os&&(91===b||93===b||224===b)||"MacOS"!==papaya.utilities.PlatformUtils.os&&17===b},papaya.viewer.Viewer.isAltKey=function(a){var b=papaya.viewer.Viewer.getKeyCode(a);return 18===b},papaya.viewer.Viewer.isShiftKey=function(a){var b=!!a.shiftKey;return!b&&window.event&&(b=!!window.event.shiftKey),b},papaya.viewer.Viewer.getOffsetRect=function(a){var b=a.getBoundingClientRect(),c=document.body,d=document.documentElement,e=window.pageYOffset||d.scrollTop,f=window.pageXOffset||d.scrollLeft,g=d.clientTop||c.clientTop||0,h=d.clientLeft||c.clientLeft||0,i=b.top+e-g,j=b.left+f-h;return{top:Math.round(i),left:Math.round(j)}},papaya.viewer.Viewer.drawRoundRect=function(a,b,c,d,e,f,g,h){"undefined"==typeof h&&(h=!0),"undefined"==typeof f&&(f=5),a.beginPath(),a.moveTo(b+f,c),a.lineTo(b+d-f,c),a.quadraticCurveTo(b+d,c,b+d,c+f),a.lineTo(b+d,c+e-f),a.quadraticCurveTo(b+d,c+e,b+d-f,c+e),a.lineTo(b+f,c+e),a.quadraticCurveTo(b,c+e,b,c+e-f),a.lineTo(b,c+f),a.quadraticCurveTo(b,c,b+f,c),a.closePath(),h&&a.stroke(),g&&a.fill()},papaya.viewer.Viewer.prototype.loadImage=function(a,b,c,d){0===this.screenVolumes.length?this.loadBaseImage(a,b,c,d):this.loadOverlay(a,b,c,d)},papaya.viewer.Viewer.prototype.showDialog=function(a,b,c,d,e){var f,g=-1;for(f=0;f<papayaContainers.length;f+=1)if(papayaContainers[f]===this.container){g=f;break}var h=new papaya.ui.Dialog(this.container,a,b,c,d,e,g);h.showDialog()},papaya.viewer.Viewer.prototype.loadBaseImage=function(a,b,c,d){var e,f=[],g=this.container.findLoadableImages(a);if(this.volume=new papaya.volume.Volume(this.container.display,this,this.container.params),d){if(g)for(e=0;e<g.length;e+=1)f.push(g[e].encode);this.volume.readBinaryData(f,papaya.utilities.ObjectUtils.bind(this,this.initializeViewer))}else if(c){if(g)for(e=0;e<g.length;e+=1)f.push(g[e].encode);this.volume.readEncodedData(f,papaya.utilities.ObjectUtils.bind(this,this.initializeViewer))}else if(null!==g&&void 0!==g[0].encode){for(e=0;e<g.length;e+=1)f.push(g[e].encode);this.volume.readEncodedData(f,papaya.utilities.ObjectUtils.bind(this,this.initializeViewer))}else if(b)this.volume.readURLs(a,papaya.utilities.ObjectUtils.bind(this,this.initializeViewer));else if(null!==g&&void 0!==g[0].url){if(g)for(e=0;e<g.length;e+=1)f.push(g[e].url);this.volume.readURLs(f,papaya.utilities.ObjectUtils.bind(this,this.initializeViewer))}else this.volume.readFiles(a,papaya.utilities.ObjectUtils.bind(this,this.initializeViewer))},papaya.viewer.Viewer.prototype.loadOverlay=function(a,b,c,d){var e,f=this.container.findLoadableImage(a);this.loadingVolume=new papaya.volume.Volume(this.container.display,this,this.container.params),this.screenVolumes.length>papaya.viewer.Viewer.MAX_OVERLAYS?(this.loadingVolume.error=new Error("Maximum number of overlays ("+papaya.viewer.Viewer.MAX_OVERLAYS+") has been reached!"),this.initializeOverlay()):d?this.loadingVolume.readBinaryData(e,papaya.utilities.ObjectUtils.bind(this,this.initializeOverlay)):c?(e=f.encode,e instanceof Array||(e=[],e[0]=f.encode),this.loadingVolume.readEncodedData(e,papaya.utilities.ObjectUtils.bind(this,this.initializeOverlay))):null!==f&&void 0!==f.encode?(e=f.encode,e instanceof Array||(e=[],e[0]=f.encode),this.loadingVolume.readEncodedData(e,papaya.utilities.ObjectUtils.bind(this,this.initializeOverlay))):b?this.loadingVolume.readURLs(a,papaya.utilities.ObjectUtils.bind(this,this.initializeOverlay)):null!==f&&void 0!==f.url?this.loadingVolume.readURLs([f.url],papaya.utilities.ObjectUtils.bind(this,this.initializeOverlay)):this.loadingVolume.readFiles(a,papaya.utilities.ObjectUtils.bind(this,this.initializeOverlay))},papaya.viewer.Viewer.prototype.loadSurface=function(a,b,c){var d=this.container.findLoadableImage(a,!0);if(0==this.screenVolumes.length)return void this.container.display.drawError("Load an image before loading a surface!");var e=new papaya.surface.Surface(this.container.display,this.container.params);c?e.readEncodedData(a[0],this.volume,papaya.utilities.ObjectUtils.bind(this,this.initializeSurface)):null!==d&&void 0!==d.encode?e.readEncodedData(d.encode,this.volume,papaya.utilities.ObjectUtils.bind(this,this.initializeSurface)):b?e.readURL(a,this.volume,papaya.utilities.ObjectUtils.bind(this,this.initializeSurface)):null!==d&&void 0!==d.url?e.readURL(d.url,this.volume,papaya.utilities.ObjectUtils.bind(this,this.initializeSurface)):e.readFile(a[0],this.volume,papaya.utilities.ObjectUtils.bind(this,this.initializeSurface))},papaya.viewer.Viewer.prototype.initializeSurface=function(a){var b=a;if(a.error)a.error&&this.container.display.drawError(a.error);else{for(;null!==b;)this.surfaces.push(b),b=b.nextSurface;if(null===this.surfaceView)this.lowerImageBot2=this.surfaceView=new papaya.viewer.ScreenSurface(this.volume,this.surfaces,this,this.container.params),this.container.resizeViewerComponents(!0);else for(b=a;null!==b;)this.surfaceView.initBuffers(this.surfaceView.context,b),b=b.nextSurface;this.container.params.mainView&&"surface"===this.container.params.mainView.toLowerCase()&&(this.mainImage=this.surfaceView,this.lowerImageTop=this.axialSlice,this.lowerImageBot=this.sagittalSlice,this.lowerImageBot2=this.coronalSlice,this.viewsChanged()),this.container.toolbar.buildToolbar(),this.container.toolbar.updateImageButtons(),this.container.hasMoreToLoad()?this.container.loadNext():this.finishedLoading()}},papaya.viewer.Viewer.prototype.atlasLoaded=function(){this.finishedLoading()},papaya.viewer.Viewer.prototype.initializeViewer=function(){var a,b;if(b=this,this.volume.hasError())a=this.volume.error.message,this.resetViewer(),this.container.clearParams(),this.container.display.drawError(a);else{if(this.screenVolumes[0]=new papaya.viewer.ScreenVolume(this.volume,this.container.params,papaya.viewer.ColorTable.DEFAULT_COLOR_TABLE.name,(!0),(!1),this.currentCoord),this.loadingDTI&&(this.loadingDTI=!1,this.screenVolumes[0].dti=!0,this.screenVolumes[0].dti&&3!==this.screenVolumes[0].volume.numTimepoints&&(this.screenVolumes[0].error=new Error("DTI vector series must have 3 series points!")),this.screenVolumes[0].dti&&this.screenVolumes[0].initDTI()),this.screenVolumes[0].hasError())return a=this.screenVolumes[0].error.message,this.resetViewer(),this.container.clearParams(),void this.container.display.drawError(a);this.setCurrentScreenVol(0),this.axialSlice=new papaya.viewer.ScreenSlice(this.volume,papaya.viewer.ScreenSlice.DIRECTION_AXIAL,this.volume.getXDim(),this.volume.getYDim(),this.volume.getXSize(),this.volume.getYSize(),this.screenVolumes,this),this.coronalSlice=new papaya.viewer.ScreenSlice(this.volume,papaya.viewer.ScreenSlice.DIRECTION_CORONAL,this.volume.getXDim(),this.volume.getZDim(),this.volume.getXSize(),this.volume.getZSize(),this.screenVolumes,this),this.sagittalSlice=new papaya.viewer.ScreenSlice(this.volume,papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL,this.volume.getYDim(),this.volume.getZDim(),this.volume.getYSize(),this.volume.getZSize(),this.screenVolumes,this),void 0===this.container.params.mainView||"axial"===this.container.params.mainView.toLowerCase()?(this.mainImage=this.axialSlice,this.lowerImageTop=this.sagittalSlice,this.lowerImageBot=this.coronalSlice):"coronal"===this.container.params.mainView.toLowerCase()?(this.mainImage=this.coronalSlice,this.lowerImageTop=this.axialSlice,this.lowerImageBot=this.sagittalSlice):"sagittal"===this.container.params.mainView.toLowerCase()?(this.mainImage=this.sagittalSlice,this.lowerImageTop=this.coronalSlice,this.lowerImageBot=this.axialSlice):(this.mainImage=this.axialSlice,this.lowerImageTop=this.sagittalSlice,this.lowerImageBot=this.coronalSlice),this.canvas.addEventListener("mousemove",this.listenerMouseMove,!1),this.canvas.addEventListener("mousedown",this.listenerMouseDown,!1),this.canvas.addEventListener("mouseout",this.listenerMouseOut,!1),this.canvas.addEventListener("mouseleave",this.listenerMouseLeave,!1),this.canvas.addEventListener("mouseup",this.listenerMouseUp,!1),document.addEventListener("keydown",this.listenerKeyDown,!0),document.addEventListener("keyup",this.listenerKeyUp,!0),this.canvas.addEventListener("touchmove",this.listenerTouchMove,!1),this.canvas.addEventListener("touchstart",this.listenerTouchStart,!1),this.canvas.addEventListener("touchend",this.listenerTouchEnd,!1),this.canvas.addEventListener("dblclick",this.listenerMouseDoubleClick,!1),document.addEventListener("contextmenu",this.listenerContextMenu,!1),this.container.showControlBar?($(this.container.sliderControlHtml.find("."+PAPAYA_CONTROL_MAIN_SLIDER).find("button")).eq(0).click(function(){b.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?b.incrementAxial(!1):b.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?b.incrementCoronal(!1):b.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&b.incrementSagittal(!0)}),$(this.container.sliderControlHtml.find("."+PAPAYA_CONTROL_MAIN_SLIDER).find("button")).eq(1).click(function(){b.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?b.incrementAxial(!0):b.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?b.incrementCoronal(!0):b.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&b.incrementSagittal(!1)}),$(this.container.sliderControlHtml.find("."+PAPAYA_CONTROL_DIRECTION_SLIDER).eq(0).find("button").eq(0)).click(function(){b.incrementAxial(!1)}),$(this.container.sliderControlHtml.find("."+PAPAYA_CONTROL_DIRECTION_SLIDER).eq(0).find("button").eq(1)).click(function(){b.incrementAxial(!0)}),$(this.container.sliderControlHtml.find("."+PAPAYA_CONTROL_DIRECTION_SLIDER).eq(1).find("button").eq(0)).click(function(){b.incrementCoronal(!1)}),$(this.container.sliderControlHtml.find("."+PAPAYA_CONTROL_DIRECTION_SLIDER).eq(1).find("button").eq(1)).click(function(){b.incrementCoronal(!0)}),$(this.container.sliderControlHtml.find("."+PAPAYA_CONTROL_DIRECTION_SLIDER).eq(2).find("button").eq(0)).click(function(){b.incrementSagittal(!0)}),$(this.container.sliderControlHtml.find("."+PAPAYA_CONTROL_DIRECTION_SLIDER).eq(2).find("button").eq(1)).click(function(){b.incrementSagittal(!1)}),$(this.container.sliderControlHtml.find("."+PAPAYA_CONTROL_DIRECTION_SLIDER).eq(3).find("button").eq(0)).click(function(){b.decrementSeriesPoint()}),$(this.container.sliderControlHtml.find("."+PAPAYA_CONTROL_DIRECTION_SLIDER).eq(3).find("button").eq(1)).click(function(){b.incrementSeriesPoint()}),$(this.container.sliderControlHtml.find("."+PAPAYA_CONTROL_SWAP_BUTTON_CSS)).click(function(){b.rotateViews()}),$(this.container.sliderControlHtml.find("."+PAPAYA_CONTROL_GOTO_CENTER_BUTTON_CSS)).click(function(){var a=new papaya.core.Coordinate(Math.floor(b.volume.header.imageDimensions.xDim/2),Math.floor(b.volume.header.imageDimensions.yDim/2),Math.floor(b.volume.header.imageDimensions.zDim/2));b.gotoCoordinate(a)}),$(this.container.sliderControlHtml.find("."+PAPAYA_CONTROL_GOTO_ORIGIN_BUTTON_CSS)).click(function(){b.gotoCoordinate(b.volume.header.origin)}),$("."+PAPAYA_CONTROL_INCREMENT_BUTTON_CSS).prop("disabled",!1),$("."+PAPAYA_CONTROL_SWAP_BUTTON_CSS).prop("disabled",!1),$("."+PAPAYA_CONTROL_GOTO_CENTER_BUTTON_CSS).prop("disabled",!1),$("."+PAPAYA_CONTROL_GOTO_ORIGIN_BUTTON_CSS).prop("disabled",!1)):this.container.showControls&&($("#"+PAPAYA_CONTROL_MAIN_INCREMENT_BUTTON_CSS+this.container.containerIndex).css({display:"inline"}),$("#"+PAPAYA_CONTROL_MAIN_DECREMENT_BUTTON_CSS+this.container.containerIndex).css({display:"inline"}),$("#"+PAPAYA_CONTROL_MAIN_SWAP_BUTTON_CSS+this.container.containerIndex).css({display:"inline"}),$(this.container.containerHtml.find("#"+PAPAYA_CONTROL_MAIN_SWAP_BUTTON_CSS+this.container.containerIndex)).click(function(){b.rotateViews()}),$(this.container.containerHtml.find("#"+PAPAYA_CONTROL_MAIN_INCREMENT_BUTTON_CSS+this.container.containerIndex)).click(function(){b.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?b.incrementAxial(!1):b.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?b.incrementCoronal(!1):b.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&b.incrementSagittal(!0)}),$(this.container.containerHtml.find("#"+PAPAYA_CONTROL_MAIN_DECREMENT_BUTTON_CSS+this.container.containerIndex)).click(function(){b.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?b.incrementAxial(!0):b.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?b.incrementCoronal(!0):b.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&b.incrementSagittal(!1)}),$(this.container.containerHtml.find("#"+PAPAYA_CONTROL_MAIN_GOTO_CENTER_BUTTON_CSS+this.container.containerIndex)).click(function(){var a=new papaya.core.Coordinate(Math.floor(b.volume.header.imageDimensions.xDim/2),Math.floor(b.volume.header.imageDimensions.yDim/2),Math.floor(b.volume.header.imageDimensions.zDim/2));b.gotoCoordinate(a)}),$(this.container.containerHtml.find("#"+PAPAYA_CONTROL_MAIN_GOTO_ORIGIN_BUTTON_CSS+this.container.containerIndex)).click(function(){b.gotoCoordinate(b.volume.header.origin)})),this.hasSeries=this.volume.header.imageDimensions.timepoints>1,this.container.allowScroll&&this.addScroll(),this.setLongestDim(this.volume),this.calculateScreenSliceTransforms(this),this.currentCoord.setCoordinate(papayaFloorFast(this.volume.getXDim()/2),papayaFloorFast(this.volume.getYDim()/2),papayaFloorFast(this.volume.getZDim()/2)),this.updateOffsetRect(),this.bgColor=$("body").css("background-color"),"rgba(0, 0, 0, 0)"!==this.bgColor&&"transparent"!==this.bgColor||(this.bgColor="rgba(255, 255, 255, 255)"),this.context.fillStyle=this.bgColor,this.context.fillRect(0,0,this.canvas.offsetWidth,this.canvas.offsetHeight),this.volume.isWorldSpaceOnly()&&(this.worldSpace=!0),this.initialized=!0,this.container.resizeViewerComponents(!0),this.drawViewer(),this.container.toolbar.buildToolbar(),this.container.toolbar.updateImageButtons(),this.updateWindowTitle(),this.container.loadingImageIndex=1,this.container.hasMoreToLoad()?this.container.loadNext():this.finishedLoading()}},papaya.viewer.Viewer.prototype.finishedLoading=function(){this.pageLoaded||(this.goToInitialCoordinate(),this.updateSliceSliderControl(),this.pageLoaded=!0),this.container.loadingComplete&&(this.container.loadingComplete(),this.container.loadingComplete=null),this.container.toolbar.buildToolbar(),this.container.toolbar.updateImageButtons(),this.updateWindowTitle()},papaya.viewer.Viewer.prototype.addScroll=function(){window.addEventListener(papaya.utilities.PlatformUtils.getSupportedScrollEvent(),this.listenerScroll,!1)},papaya.viewer.Viewer.prototype.removeScroll=function(){window.removeEventListener(papaya.utilities.PlatformUtils.getSupportedScrollEvent(),this.listenerScroll,!1)},papaya.viewer.Viewer.prototype.updateOffsetRect=function(){this.canvasRect=papaya.viewer.Viewer.getOffsetRect(this.canvas)},papaya.viewer.Viewer.prototype.initializeOverlay=function(){var a,b,c,d,e,f,g;if(this.loadingVolume.hasError())this.container.display.drawError(this.loadingVolume.error.message),this.container.clearParams(),this.loadingVolume=null;else{if(a=this.container.params[this.loadingVolume.fileName],b=a&&a.parametric,f=a&&a.dtiMod,this.loadingDTIModRef)this.loadingDTIModRef.dtiVolumeMod=this.loadingVolume,this.loadingDTIModRef=null;else if(f)g=this.getScreenVolumeByName(a.dtiRef),g&&(g.dtiVolumeMod=this.loadingVolume,void 0!==a.dtiModAlphaFactor?g.dtiAlphaFactor=a.dtiModAlphaFactor:g.dtiAlphaFactor=1);else{if(d=new papaya.viewer.ScreenVolume(this.loadingVolume,this.container.params,b?papaya.viewer.ColorTable.PARAMETRIC_COLOR_TABLES[0].name:this.getNextColorTable(),(!1),(!1),this.currentCoord),this.loadingDTI&&(this.loadingDTI=!1,d.dti=!0,d.dti&&3!==d.volume.numTimepoints&&(d.error=new Error("DTI vector series must have 3 series points!")),d.dti&&d.initDTI()),d.hasError())return this.container.display.drawError(d.error.message),this.container.clearParams(),void(this.loadingVolume=null);this.screenVolumes[this.screenVolumes.length]=d,this.setCurrentScreenVol(this.screenVolumes.length-1),b&&(this.screenVolumes[this.screenVolumes.length-1].findImageRange(),this.screenVolumes[this.screenVolumes.length-1].volume.header.imageRange.imageMin<0&&(this.screenVolumes[this.screenVolumes.length]=e=new papaya.viewer.ScreenVolume(this.loadingVolume,this.container.params,papaya.viewer.ColorTable.PARAMETRIC_COLOR_TABLES[1].name,(!1),(!0),this.currentCoord),d.negativeScreenVol=e,this.setCurrentScreenVol(this.screenVolumes.length-1)))}for(this.container.toolbar.buildToolbar(),this.container.toolbar.updateImageButtons(),this.drawViewer(!0),this.hasSeries=!1,c=0;c<this.screenVolumes.length;c+=1)if(this.screenVolumes[c].volume.header.imageDimensions.timepoints>1){this.hasSeries=!0;break}this.container.resizeViewerComponents(),this.updateWindowTitle(),this.loadingVolume=null,this.container.hasMoreToLoad()?this.container.loadNext():this.finishedLoading()}},papaya.viewer.Viewer.prototype.closeOverlayByRef=function(a){this.closeOverlay(this.getScreenVolumeIndex(a))},papaya.viewer.Viewer.prototype.closeOverlay=function(a){var b;for(b=0;b<this.screenVolumes.length;b+=1)this.screenVolumes[b].negativeScreenVol===this.screenVolumes[a]&&(this.screenVolumes[b].negativeScreenVol=null);for(this.screenVolumes.splice(a,1),this.setCurrentScreenVol(this.screenVolumes.length-1),this.drawViewer(!0),this.container.toolbar.buildToolbar(),this.container.toolbar.updateImageButtons(),this.updateWindowTitle(),this.hasSeries=!1,b=0;b<this.screenVolumes.length;b+=1)if(this.screenVolumes[b].volume.header.imageDimensions.timepoints>1){this.hasSeries=!0;break}this.container.resizeViewerComponents()},papaya.viewer.Viewer.prototype.hasDefinedAtlas=function(){var a,b;return a=typeof papaya.data,"undefined"!==a&&(b=typeof papaya.data.Atlas,"undefined"!==b)},papaya.viewer.Viewer.prototype.loadAtlas=function(){var a=this;null===this.atlas&&(this.atlas=new papaya.viewer.Atlas(papaya.data.Atlas,this.container,papaya.utilities.ObjectUtils.bind(a,a.atlasLoaded)))},papaya.viewer.Viewer.prototype.isInsideMainSlice=function(a,b){return this.updateOffsetRect(),a-=this.canvasRect.left,b-=this.canvasRect.top,this.mainImage===this.axialSlice?this.insideScreenSlice(this.axialSlice,a,b,this.volume.getXDim(),this.volume.getYDim()):this.mainImage===this.coronalSlice?this.insideScreenSlice(this.coronalSlice,a,b,this.volume.getXDim(),this.volume.getZDim()):this.mainImage===this.sagittalSlice&&this.insideScreenSlice(this.sagittalSlice,a,b,this.volume.getYDim(),this.volume.getZDim())},papaya.viewer.Viewer.prototype.updatePosition=function(a,b,c,d){var e,f,g,h,i;a.updateOffsetRect(),h=b,i=c,b-=this.canvasRect.left,c-=this.canvasRect.top,this.insideScreenSlice(a.axialSlice,b,c,a.volume.getXDim(),a.volume.getYDim())?this.isDragging&&this.draggingSliceDir!==papaya.viewer.ScreenSlice.DIRECTION_AXIAL||(e=this.convertScreenToImageCoordinateX(b,a.axialSlice),f=this.convertScreenToImageCoordinateY(c,a.axialSlice),e===a.currentCoord.x&&f===a.currentCoord.y||(a.currentCoord.x=e,a.currentCoord.y=f,this.draggingSliceDir=papaya.viewer.ScreenSlice.DIRECTION_AXIAL)):this.insideScreenSlice(a.coronalSlice,b,c,a.volume.getXDim(),a.volume.getZDim())?this.isDragging&&this.draggingSliceDir!==papaya.viewer.ScreenSlice.DIRECTION_CORONAL||(e=this.convertScreenToImageCoordinateX(b,a.coronalSlice),f=this.convertScreenToImageCoordinateY(c,a.coronalSlice),e===a.currentCoord.x&&f===a.currentCoord.y||(a.currentCoord.x=e,a.currentCoord.z=f,this.draggingSliceDir=papaya.viewer.ScreenSlice.DIRECTION_CORONAL)):this.insideScreenSlice(a.sagittalSlice,b,c,a.volume.getYDim(),a.volume.getZDim())?this.isDragging&&this.draggingSliceDir!==papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL||(e=this.convertScreenToImageCoordinateX(b,a.sagittalSlice),f=this.convertScreenToImageCoordinateY(c,a.sagittalSlice),e===a.currentCoord.x&&f===a.currentCoord.y||(g=e,a.currentCoord.y=g,a.currentCoord.z=f,this.draggingSliceDir=papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL)):a.surfaceView&&this.insideScreenSlice(a.surfaceView,b,c,a.surfaceView.screenDim,a.surfaceView.screenDim)&&a.surfaceView.updateDynamic(h,i,this.selectedSlice===this.mainImage?1:3),
this.container.coordinateChanged(this),a.drawViewer(!1,d)},papaya.viewer.Viewer.prototype.convertScreenToImageCoordinateX=function(a,b){return papaya.viewer.Viewer.validDimBounds(papayaFloorFast((a-b.finalTransform[0][2])/b.finalTransform[0][0]),b.xDim)},papaya.viewer.Viewer.prototype.convertScreenToImageCoordinateY=function(a,b){return papaya.viewer.Viewer.validDimBounds(papayaFloorFast((a-b.finalTransform[1][2])/b.finalTransform[1][1]),b.yDim)},papaya.viewer.Viewer.prototype.convertScreenToImageCoordinate=function(a,b,c){var d,e,f;return void 0===c&&(c=this.mainImage),c.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?(d=this.convertScreenToImageCoordinateX(a,c),e=this.convertScreenToImageCoordinateY(b,c),f=this.axialSlice.currentSlice):c.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?(d=this.convertScreenToImageCoordinateX(a,c),f=this.convertScreenToImageCoordinateY(b,c),e=this.coronalSlice.currentSlice):c.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&(e=this.convertScreenToImageCoordinateX(a,c),f=this.convertScreenToImageCoordinateY(b,c),d=this.sagittalSlice.currentSlice),new papaya.core.Coordinate(d,e,f)},papaya.viewer.Viewer.prototype.convertCurrentCoordinateToScreen=function(a){return this.convertCoordinateToScreen(this.currentCoord,a)},papaya.viewer.Viewer.prototype.intersectsMainSlice=function(a){var b=this.mainImage.sliceDirection;return b===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?a.z===this.mainImage.currentSlice:b===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?a.y===this.mainImage.currentSlice:b===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&a.x===this.mainImage.currentSlice},papaya.viewer.Viewer.prototype.convertCoordinateToScreen=function(a,b){var c,d,e;return void 0===b&&(b=this.mainImage),e=b.sliceDirection,e===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?(c=papayaFloorFast(b.finalTransform[0][2]+(a.x+.5)*b.finalTransform[0][0]),d=papayaFloorFast(b.finalTransform[1][2]+(a.y+.5)*b.finalTransform[1][1])):e===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?(c=papayaFloorFast(b.finalTransform[0][2]+(a.x+.5)*b.finalTransform[0][0]),d=papayaFloorFast(b.finalTransform[1][2]+(a.z+.5)*b.finalTransform[1][1])):e===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&(c=papayaFloorFast(b.finalTransform[0][2]+(a.y+.5)*b.finalTransform[0][0]),d=papayaFloorFast(b.finalTransform[1][2]+(a.z+.5)*b.finalTransform[1][1])),new papaya.core.Point(c,d)},papaya.viewer.Viewer.prototype.updateCursorPosition=function(a,b,c){var d,e,f,g,h=null;this.container.display&&(b-=this.canvasRect.left,c-=this.canvasRect.top,this.insideScreenSlice(a.axialSlice,b,c,a.volume.getXDim(),a.volume.getYDim())?(d=this.convertScreenToImageCoordinateX(b,a.axialSlice),e=this.convertScreenToImageCoordinateY(c,a.axialSlice),f=a.axialSlice.currentSlice,g=!0):this.insideScreenSlice(a.coronalSlice,b,c,a.volume.getXDim(),a.volume.getZDim())?(d=this.convertScreenToImageCoordinateX(b,a.coronalSlice),f=this.convertScreenToImageCoordinateY(c,a.coronalSlice),e=a.coronalSlice.currentSlice,g=!0):this.insideScreenSlice(a.sagittalSlice,b,c,a.volume.getYDim(),a.volume.getZDim())?(e=this.convertScreenToImageCoordinateX(b,a.sagittalSlice),f=this.convertScreenToImageCoordinateY(c,a.sagittalSlice),d=a.sagittalSlice.currentSlice,g=!0):this.insideScreenSlice(a.surfaceView,b,c)&&(b-=a.surfaceView.screenOffsetX,c-=a.surfaceView.screenOffsetY,h=this.surfaceView.pick(b,c),h&&(this.getIndexCoordinateAtWorld(h.coordinate[0],h.coordinate[1],h.coordinate[2],this.tempCoor),d=this.tempCoor.x,e=this.tempCoor.y,f=this.tempCoor.z,g=!0)),g?(this.cursorPosition.x=d,this.cursorPosition.y=e,this.cursorPosition.z=f,this.container.display.drawDisplay(d,e,f)):this.container.display.drawEmptyDisplay())},papaya.viewer.Viewer.prototype.insideScreenSlice=function(a,b,c,d,e){var f,g,h,i;return!!a&&(a===this.surfaceView?(f=a.screenOffsetX,g=a.screenOffsetX+a.screenDim,h=a.screenOffsetY,i=a.screenOffsetY+a.screenDim):(f=papayaRoundFast(a.screenTransform[0][2]),g=papayaRoundFast(a.screenTransform[0][2]+d*a.screenTransform[0][0]),h=papayaRoundFast(a.screenTransform[1][2]),i=papayaRoundFast(a.screenTransform[1][2]+e*a.screenTransform[1][1])),b>=f&&b<g&&c>=h&&c<i)},papaya.viewer.Viewer.prototype.drawEmptyViewer=function(){var a,b,c,d,e;this.context.fillStyle="#000000",this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.fillStyle="#AAAAAA",this.container.readyForDnD()&&(b=18,this.context.font=b+"px sans-serif",a=this.canvas.height-22,c="",d=this.context.measureText(c),e=d.width,this.context.fillText(c,this.canvas.width/2-e/2,a)),this.canvas.width>900&&(b=14,this.context.font=b+"px sans-serif",a=this.canvas.height-20,c="",this.context.fillText(c,20,a),b=14,this.context.font=b+"px sans-serif",a=this.canvas.height-20,c="",d=this.context.measureText(c),e=d.width,this.context.fillText(c,this.canvas.width-e-20,a))},papaya.viewer.Viewer.prototype.drawViewer=function(a,b){var c="Yes"===this.container.preferences.radiological,d=!0;return this.initialized?(this.context.save(),b?(this.axialSlice.repaint(this.currentCoord.z,a,this.worldSpace),this.coronalSlice.repaint(this.currentCoord.y,a,this.worldSpace),this.sagittalSlice.repaint(this.volume.header.imageDimensions.xDim-this.currentCoord.x,a,this.worldSpace)):((a||this.draggingSliceDir!==papaya.viewer.ScreenSlice.DIRECTION_AXIAL)&&this.axialSlice.updateSlice(this.currentCoord.z,a,this.worldSpace),(a||this.draggingSliceDir!==papaya.viewer.ScreenSlice.DIRECTION_CORONAL)&&this.coronalSlice.updateSlice(this.currentCoord.y,a,this.worldSpace),(a||this.draggingSliceDir!==papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL)&&this.sagittalSlice.updateSlice(this.volume.header.imageDimensions.xDim-this.currentCoord.x,a,this.worldSpace)),void((!this.hasSurface()||papaya.utilities.PlatformUtils.smallScreen&&!a&&this.selectedSlice!==this.surfaceView)&&("No"===this.container.preferences.smoothDisplay?(this.context.imageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.msImageSmoothingEnabled=!1):(this.context.imageSmoothingEnabled=!0,this.context.mozImageSmoothingEnabled=!0,this.context.msImageSmoothingEnabled=!0),this.drawScreenSlice(this.mainImage,"imageLeft"),this.container.orthogonal&&(this.drawScreenSlice(this.lowerImageTop,"image1Right"),this.drawScreenSlice(this.lowerImageBot,"image2Right"),this.hasSurface())||((d||c)&&this.drawOrientation(),"Yes"===this.container.preferences.showCrosshairs&&this.drawCrosshairs(),"Yes"===this.container.preferences.showRuler&&this.drawRuler(),this.container.display&&this.container.display.drawDisplay(this.currentCoord.x,this.currentCoord.y,this.currentCoord.z),this.container.contextManager&&this.container.contextManager.drawToViewer&&this.container.contextManager.drawToViewer(this.context))))):void this.drawEmptyViewer()},papaya.viewer.Viewer.prototype.hasSurface=function(){return this.container.hasSurface()&&this.surfaceView&&this.surfaceView.initialized};var deepCopyMPR=function(a){if(a instanceof Array){for(var b=[],c=0;c<a.length;++c)b[c]=deepCopyMPR(a[c]);return b}if(a instanceof Object){var b={};for(var c in a)b[c]=deepCopyMPR(a[c]);return b}return a};papaya.viewer.Viewer.prototype.drawScreenSliceMode1=function(a,b){"imageLeft"==b&&(slicesObj.axialObj.rows=a.imageDataDraw.height,slicesObj.axialObj.columns=a.imageDataDraw.width,slicesObj.axialObj.height=a.imageDataDraw.height,slicesObj.axialObj.width=a.imageDataDraw.width,slicesObj.axialObj.columnPixelSpacing=a.xSize,slicesObj.axialObj.rowPixelSpacing=a.ySize,slicesObj.axialObj.canvsData=a.imageDataDraw,slicesObj.axialObj.imageDataDraw=a.imageData,slicesObj.axialObj.windowCenter=infoData.wc,slicesObj.axialObj.windowWidth=infoData.ww),"image1Right"==b&&(slicesObj.sagttialObj.rows=a.imageDataDraw.height,slicesObj.sagttialObj.columns=a.imageDataDraw.width,slicesObj.sagttialObj.height=a.imageDataDraw.height,slicesObj.sagttialObj.width=a.imageDataDraw.width,slicesObj.sagttialObj.columnPixelSpacing=a.xSize,slicesObj.sagttialObj.rowPixelSpacing=a.ySize,slicesObj.sagttialObj.canvsData=a.imageDataDraw,slicesObj.sagttialObj.imageDataDraw=a.imageData,slicesObj.sagttialObj.windowCenter=infoData.wc,slicesObj.sagttialObj.windowWidth=infoData.ww),"image2Right"==b&&(slicesObj.coronalObj.rows=a.imageDataDraw.height,slicesObj.coronalObj.columns=a.imageDataDraw.width,slicesObj.coronalObj.height=a.imageDataDraw.height,slicesObj.coronalObj.width=a.imageDataDraw.width,slicesObj.coronalObj.columnPixelSpacing=a.xSize,slicesObj.coronalObj.rowPixelSpacing=a.ySize,slicesObj.coronalObj.canvsData=a.imageDataDraw,slicesObj.coronalObj.imageDataDraw=a.imageData,slicesObj.coronalObj.windowCenter=infoData.wc,slicesObj.coronalObj.windowWidth=infoData.ww);var c,d,e,f=5;a===this.surfaceView?(this.context.fillStyle=this.surfaceView.getBackgroundColor(),this.context.fillRect(a.screenOffsetX,a.screenOffsetY,a.screenDim,a.screenDim),"Yes"===this.container.preferences.showRuler&&this.surfaceView===this.mainImage&&(this.context.font=papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE+"px sans-serif",c=this.context.measureText("Ruler Length: ").width,d=this.context.measureText("Ruler Length: 000.00").width,e=d/2,this.context.fillStyle="#ffb3db",this.context.fillText("Ruler Length:  ",a.screenDim/2-e/2,papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE+f),this.context.fillStyle="#FFFFFF",this.context.fillText(this.surfaceView.getRulerLength().toFixed(2),a.screenDim/2+c-e/2,papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE+f))):(this.context.fillStyle=papaya.viewer.Viewer.BACKGROUND_COLOR,this.context.setTransform(1,0,0,1,0,0),this.context.fillRect(a.screenOffsetX,a.screenOffsetY,a.screenDim,a.screenDim),this.context.save(),this.context.beginPath(),this.context.rect(a.screenOffsetX,a.screenOffsetY,a.screenDim,a.screenDim),this.context.clip(),this.context.setTransform(a.finalTransform[0][0],0,0,a.finalTransform[1][1],a.finalTransform[0][2],a.finalTransform[1][2]),this.context.drawImage(a.canvasMain,0,0),this.context.restore(),a.canvasDTILines&&this.context.drawImage(a.canvasDTILines,a.screenOffsetX,a.screenOffsetY))},papaya.viewer.Viewer.prototype.drawScreenSliceMode2=function(a,b){"imageLeft"==b&&(slicesObj.axialObj.rows=a.imageDataDraw.height,slicesObj.axialObj.columns=a.imageDataDraw.width,slicesObj.axialObj.height=a.imageDataDraw.height,slicesObj.axialObj.width=a.imageDataDraw.width,slicesObj.axialObj.columnPixelSpacing=a.xSize,slicesObj.axialObj.rowPixelSpacing=a.ySize,slicesObj.axialObj.imageDataDraw=a.imageDataDraw,slicesObj.axialObj.windowCenter=128,slicesObj.axialObj.windowWidth=255),"image1Right"==b&&(slicesObj.sagttialObj.rows=a.imageDataDraw.height,slicesObj.sagttialObj.columns=a.imageDataDraw.width,slicesObj.sagttialObj.height=a.imageDataDraw.height,slicesObj.sagttialObj.width=a.imageDataDraw.width,slicesObj.sagttialObj.columnPixelSpacing=a.xSize,slicesObj.sagttialObj.rowPixelSpacing=a.ySize,slicesObj.sagttialObj.imageDataDraw=a.imageDataDraw,slicesObj.sagttialObj.windowCenter=128,slicesObj.sagttialObj.windowWidth=255),"image2Right"==b&&(slicesObj.coronalObj.rows=a.imageDataDraw.height,slicesObj.coronalObj.columns=a.imageDataDraw.width,slicesObj.coronalObj.height=a.imageDataDraw.height,slicesObj.coronalObj.width=a.imageDataDraw.width,slicesObj.coronalObj.columnPixelSpacing=a.xSize,slicesObj.coronalObj.rowPixelSpacing=a.ySize,slicesObj.coronalObj.imageDataDraw=a.imageDataDraw,slicesObj.coronalObj.windowCenter=128,slicesObj.coronalObj.windowWidth=255);var c,d,e,f=5;a===this.surfaceView?(this.context.fillStyle=this.surfaceView.getBackgroundColor(),this.context.fillRect(a.screenOffsetX,a.screenOffsetY,a.screenDim,a.screenDim),"Yes"===this.container.preferences.showRuler&&this.surfaceView===this.mainImage&&(this.context.font=papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE+"px sans-serif",c=this.context.measureText("Ruler Length: ").width,d=this.context.measureText("Ruler Length: 000.00").width,e=d/2,this.context.fillStyle="#ffb3db",this.context.fillText("Ruler Length:  ",a.screenDim/2-e/2,papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE+f),this.context.fillStyle="#FFFFFF",this.context.fillText(this.surfaceView.getRulerLength().toFixed(2),a.screenDim/2+c-e/2,papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE+f))):(this.context.fillStyle="#000000",this.context.setTransform(1,0,0,1,0,0),this.context.fillRect(a.screenOffsetX,a.screenOffsetY,a.screenDim,a.screenDim),this.context.save(),this.context.beginPath(),this.context.rect(a.screenOffsetX,a.screenOffsetY,a.screenDim,a.screenDim),this.context.clip(),this.context.setTransform(a.finalTransform[0][0],0,0,a.finalTransform[1][1],a.finalTransform[0][2],a.finalTransform[1][2]),this.context.drawImage(a.canvasMain,0,0),this.context.restore(),a.canvasDTILines&&this.context.drawImage(a.canvasDTILines,a.screenOffsetX,a.screenOffsetY))},papaya.viewer.Viewer.prototype.drawScreenSlice=function(a,b){"imageLeft"==b&&(slicesObj.axialObj.rows=a.imageDataDraw.height,slicesObj.axialObj.columns=a.imageDataDraw.width,slicesObj.axialObj.height=a.imageDataDraw.height,slicesObj.axialObj.width=a.imageDataDraw.width,slicesObj.axialObj.columnPixelSpacing=a.xSize,slicesObj.axialObj.rowPixelSpacing=a.ySize,slicesObj.axialObj.canvsData=a.imageDataDraw,slicesObj.axialObj.imageDataDraw=a.imageData,slicesObj.axialObj.windowCenter=infoData.wc,slicesObj.axialObj.windowWidth=infoData.ww),"image1Right"==b&&(slicesObj.sagttialObj.rows=a.imageDataDraw.height,slicesObj.sagttialObj.columns=a.imageDataDraw.width,slicesObj.sagttialObj.height=a.imageDataDraw.height,slicesObj.sagttialObj.width=a.imageDataDraw.width,slicesObj.sagttialObj.columnPixelSpacing=a.xSize,slicesObj.sagttialObj.rowPixelSpacing=a.ySize,slicesObj.sagttialObj.canvsData=a.imageDataDraw,slicesObj.sagttialObj.imageDataDraw=a.imageData,slicesObj.sagttialObj.windowCenter=infoData.wc,slicesObj.sagttialObj.windowWidth=infoData.ww),"image2Right"==b&&(slicesObj.coronalObj.rows=a.imageDataDraw.height,slicesObj.coronalObj.columns=a.imageDataDraw.width,slicesObj.coronalObj.height=a.imageDataDraw.height,slicesObj.coronalObj.width=a.imageDataDraw.width,slicesObj.coronalObj.columnPixelSpacing=a.xSize,slicesObj.coronalObj.rowPixelSpacing=a.ySize,slicesObj.coronalObj.canvsData=a.imageDataDraw,slicesObj.coronalObj.imageDataDraw=a.imageData,slicesObj.coronalObj.windowCenter=infoData.wc,slicesObj.coronalObj.windowWidth=infoData.ww);var c,d,e,f=5;a===this.surfaceView?(this.context.fillStyle=this.surfaceView.getBackgroundColor(),this.context.fillRect(a.screenOffsetX,a.screenOffsetY,a.screenDim,a.screenDim),"Yes"===this.container.preferences.showRuler&&this.surfaceView===this.mainImage&&(this.context.font=papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE+"px sans-serif",c=this.context.measureText("Ruler Length: ").width,d=this.context.measureText("Ruler Length: 000.00").width,e=d/2,this.context.fillStyle="#ffb3db",this.context.fillText("Ruler Length:  ",a.screenDim/2-e/2,papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE+f),this.context.fillStyle="#FFFFFF",this.context.fillText(this.surfaceView.getRulerLength().toFixed(2),a.screenDim/2+c-e/2,papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE+f))):(this.context.fillStyle=papaya.viewer.Viewer.BACKGROUND_COLOR,this.context.setTransform(1,0,0,1,0,0),this.context.fillRect(a.screenOffsetX,a.screenOffsetY,a.screenDim,a.screenDim),this.context.save(),this.context.beginPath(),this.context.rect(a.screenOffsetX,a.screenOffsetY,a.screenDim,a.screenDim),this.context.clip(),this.context.setTransform(a.finalTransform[0][0],0,0,a.finalTransform[1][1],a.finalTransform[0][2],a.finalTransform[1][2]),this.context.drawImage(a.canvasMain,0,0),this.context.restore(),a.canvasDTILines&&this.context.drawImage(a.canvasDTILines,a.screenOffsetX,a.screenOffsetY))},papaya.viewer.Viewer.prototype.drawOrientation=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n=!0;if(this.mainImage!==this.surfaceView){this.context.setTransform(1,0,0,1,0,0),this.context.fillStyle="#ADFF2F",this.context.font=papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE+"px Arial",a=this.context.measureText("X"),b=a.width,c="Yes"===this.container.preferences.radiological,this.mainImage===this.axialSlice?(d=papaya.viewer.Viewer.ORIENTATION_MARKER_ANTERIOR,e=papaya.viewer.Viewer.ORIENTATION_MARKER_POSTERIOR,c?(f=papaya.viewer.Viewer.ORIENTATION_MARKER_RIGHT,g=papaya.viewer.Viewer.ORIENTATION_MARKER_LEFT):(f=papaya.viewer.Viewer.ORIENTATION_MARKER_LEFT,g=papaya.viewer.Viewer.ORIENTATION_MARKER_RIGHT)):this.mainImage===this.coronalSlice?(d=papaya.viewer.Viewer.ORIENTATION_MARKER_SUPERIOR,e=papaya.viewer.Viewer.ORIENTATION_MARKER_INFERIOR,c?(f=papaya.viewer.Viewer.ORIENTATION_MARKER_RIGHT,g=papaya.viewer.Viewer.ORIENTATION_MARKER_LEFT):(f=papaya.viewer.Viewer.ORIENTATION_MARKER_LEFT,g=papaya.viewer.Viewer.ORIENTATION_MARKER_RIGHT)):this.mainImage===this.sagittalSlice&&(d=papaya.viewer.Viewer.ORIENTATION_MARKER_SUPERIOR,e=papaya.viewer.Viewer.ORIENTATION_MARKER_INFERIOR,f=papaya.viewer.Viewer.ORIENTATION_MARKER_ANTERIOR,g=papaya.viewer.Viewer.ORIENTATION_MARKER_POSTERIOR),h=this.mainImage.screenOffsetX,i=this.mainImage.screenOffsetX+this.mainImage.screenDim,j=Math.round(i/2),k=this.mainImage.screenOffsetY,l=this.mainImage.screenOffsetY+this.mainImage.screenDim,m=Math.round(l/2),(n||this.mainImage.isRadiologicalSensitive())&&(this.context.fillText(f,h+papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE,m+.5*papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE),this.context.fillText(g,i-1.5*papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE,m+.5*papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE)),n&&(this.context.fillText(d,j-b/2,k+1.5*papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE),this.context.fillText(e,j-b/2,l-papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE));var o,p,q,r,s,t,u,v,w,x,y,z;if(this.lowerImageBot!==this.surfaceView){o=this.context.measureText("X"),p=o.width,this.lowerImageBot===this.axialSlice?(q=papaya.viewer.Viewer.ORIENTATION_MARKER_ANTERIOR,r=papaya.viewer.Viewer.ORIENTATION_MARKER_POSTERIOR,c?(s=papaya.viewer.Viewer.ORIENTATION_MARKER_RIGHT,t=papaya.viewer.Viewer.ORIENTATION_MARKER_LEFT):(s=papaya.viewer.Viewer.ORIENTATION_MARKER_LEFT,t=papaya.viewer.Viewer.ORIENTATION_MARKER_RIGHT)):this.lowerImageBot===this.coronalSlice?(q=papaya.viewer.Viewer.ORIENTATION_MARKER_SUPERIOR,r=papaya.viewer.Viewer.ORIENTATION_MARKER_INFERIOR,c?(s=papaya.viewer.Viewer.ORIENTATION_MARKER_RIGHT,t=papaya.viewer.Viewer.ORIENTATION_MARKER_LEFT):(s=papaya.viewer.Viewer.ORIENTATION_MARKER_LEFT,t=papaya.viewer.Viewer.ORIENTATION_MARKER_RIGHT)):this.lowerImageBot===this.sagittalSlice&&(q=papaya.viewer.Viewer.ORIENTATION_MARKER_SUPERIOR,r=papaya.viewer.Viewer.ORIENTATION_MARKER_INFERIOR,s=papaya.viewer.Viewer.ORIENTATION_MARKER_ANTERIOR,t=papaya.viewer.Viewer.ORIENTATION_MARKER_POSTERIOR),u=this.lowerImageBot.screenOffsetX,v=this.lowerImageBot.screenOffsetX+this.lowerImageBot.screenDim,w=Math.round(v/2),x=this.lowerImageBot.screenOffsetY,y=this.lowerImageBot.screenOffsetY+this.lowerImageBot.screenDim,z=Math.round(y/2);var A=(u+papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE+v-1.5*papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE)/2,B=(x+1.5*papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE+y-papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE)/2;(n||this.lowerImageBot.isRadiologicalSensitive())&&(this.context.fillText(s,u+papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE-5,B),this.context.fillText(t,v-1.5*papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE+5,B)),n&&(this.context.fillText(q,A,x+1.5*papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE-5),this.context.fillText(r,A,y-papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE+5));var C,D,E,F,G,H,I,J,K,L,M,N;if(this.lowerImageTop!==this.surfaceView&&(C=this.context.measureText("X"),D=C.width,this.lowerImageTop===this.axialSlice?(E=papaya.viewer.Viewer.ORIENTATION_MARKER_ANTERIOR,F=papaya.viewer.Viewer.ORIENTATION_MARKER_POSTERIOR,c?(G=papaya.viewer.Viewer.ORIENTATION_MARKER_RIGHT,H=papaya.viewer.Viewer.ORIENTATION_MARKER_LEFT):(G=papaya.viewer.Viewer.ORIENTATION_MARKER_LEFT,H=papaya.viewer.Viewer.ORIENTATION_MARKER_RIGHT)):this.lowerImageTop===this.coronalSlice?(E=papaya.viewer.Viewer.ORIENTATION_MARKER_SUPERIOR,F=papaya.viewer.Viewer.ORIENTATION_MARKER_INFERIOR,c?(G=papaya.viewer.Viewer.ORIENTATION_MARKER_RIGHT,H=papaya.viewer.Viewer.ORIENTATION_MARKER_LEFT):(G=papaya.viewer.Viewer.ORIENTATION_MARKER_LEFT,H=papaya.viewer.Viewer.ORIENTATION_MARKER_RIGHT)):this.lowerImageTop===this.sagittalSlice&&(E=papaya.viewer.Viewer.ORIENTATION_MARKER_SUPERIOR,F=papaya.viewer.Viewer.ORIENTATION_MARKER_INFERIOR,G=papaya.viewer.Viewer.ORIENTATION_MARKER_ANTERIOR,H=papaya.viewer.Viewer.ORIENTATION_MARKER_POSTERIOR),I=this.lowerImageTop.screenOffsetX,J=this.lowerImageTop.screenOffsetX+this.lowerImageTop.screenDim,K=Math.round(J/2),L=this.lowerImageTop.screenOffsetY,M=this.lowerImageTop.screenOffsetY+this.lowerImageTop.screenDim,N=Math.round(M/2),(n||this.lowerImageTop.isRadiologicalSensitive())&&(this.context.fillText(G,I+papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE-5,N+.5*papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE),this.context.fillText(H,J-1.5*papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE+5,N+.5*papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE)),n)){var O=(I+papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE+J-1.5*papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE)/2;this.context.fillText(E,O,L+1.5*papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE-5),this.context.fillText(F,O,M-papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE+5)}}}},papaya.viewer.Viewer.prototype.drawRuler=function(){var a,b,c,d,e,f,g,h,i,j,k;this.mainImage!==this.surfaceView&&(this.mainImage===this.axialSlice?(a=this.axialSlice.finalTransform[0][2]+(this.axialSlice.rulerPoints[0].x+.5)*this.axialSlice.finalTransform[0][0],b=this.axialSlice.finalTransform[1][2]+(this.axialSlice.rulerPoints[0].y+.5)*this.axialSlice.finalTransform[1][1],c=this.axialSlice.finalTransform[0][2]+(this.axialSlice.rulerPoints[1].x+.5)*this.axialSlice.finalTransform[0][0],d=this.axialSlice.finalTransform[1][2]+(this.axialSlice.rulerPoints[1].y+.5)*this.axialSlice.finalTransform[1][1]):this.mainImage===this.coronalSlice?(a=this.coronalSlice.finalTransform[0][2]+(this.coronalSlice.rulerPoints[0].x+.5)*this.coronalSlice.finalTransform[0][0],b=this.coronalSlice.finalTransform[1][2]+(this.coronalSlice.rulerPoints[0].y+.5)*this.coronalSlice.finalTransform[1][1],c=this.coronalSlice.finalTransform[0][2]+(this.coronalSlice.rulerPoints[1].x+.5)*this.coronalSlice.finalTransform[0][0],d=this.coronalSlice.finalTransform[1][2]+(this.coronalSlice.rulerPoints[1].y+.5)*this.coronalSlice.finalTransform[1][1]):this.mainImage===this.sagittalSlice&&(a=this.sagittalSlice.finalTransform[0][2]+(this.sagittalSlice.rulerPoints[0].x+.5)*this.sagittalSlice.finalTransform[0][0],b=this.sagittalSlice.finalTransform[1][2]+(this.sagittalSlice.rulerPoints[0].y+.5)*this.sagittalSlice.finalTransform[1][1],c=this.sagittalSlice.finalTransform[0][2]+(this.sagittalSlice.rulerPoints[1].x+.5)*this.sagittalSlice.finalTransform[0][0],d=this.sagittalSlice.finalTransform[1][2]+(this.sagittalSlice.rulerPoints[1].y+.5)*this.sagittalSlice.finalTransform[1][1]),this.context.setTransform(1,0,0,1,0,0),this.context.strokeStyle="#FF1493",this.context.fillStyle="#FF1493",this.context.lineWidth=2,this.context.save(),this.context.beginPath(),this.context.moveTo(a,b),this.context.lineTo(c,d),this.context.stroke(),this.context.closePath(),this.context.beginPath(),this.context.arc(a,b,3,0,2*Math.PI,!1),this.context.arc(c,d,3,0,2*Math.PI,!1),this.context.fill(),this.context.closePath(),e=papaya.utilities.StringUtils.formatNumber(papaya.utilities.MathUtils.lineDistance(this.mainImage.rulerPoints[0].x*this.mainImage.xSize,this.mainImage.rulerPoints[0].y*this.mainImage.ySize,this.mainImage.rulerPoints[1].x*this.mainImage.xSize,this.mainImage.rulerPoints[1].y*this.mainImage.ySize),!1),f=this.context.measureText(e),g=f.width,h=14,i=2,j=parseInt((a+c)/2)-g/2,k=parseInt((b+d)/2)+h/2,this.context.fillStyle="#FFFFFF",papaya.viewer.Viewer.drawRoundRect(this.context,j-i,k-h-i+1,g+2*i,h+2*i,5,!0,!1),this.context.font=papaya.viewer.Viewer.ORIENTATION_MARKER_SIZE+"px sans-serif",this.context.strokeStyle="#FF1493",this.context.fillStyle="#FF1493",this.context.fillText(e,j,k))},papaya.viewer.Viewer.prototype.drawCrosshairs=function(){var a,b,c,d,e,f;this.context.setTransform(1,0,0,1,0,0),this.context.strokeStyle=papaya.viewer.Viewer.CROSSHAIRS_COLOR,this.context.lineWidth=1,(this.mainImage!==this.axialSlice||this.toggleMainCrosshairs)&&(this.context.save(),this.context.beginPath(),this.context.rect(this.axialSlice.screenOffsetX,this.axialSlice.screenOffsetY,this.axialSlice.screenDim,this.axialSlice.screenDim),this.context.closePath(),this.context.clip(),this.context.beginPath(),a=this.axialSlice.finalTransform[0][2]+(this.currentCoord.x+.5)*this.axialSlice.finalTransform[0][0],b=this.axialSlice.finalTransform[1][2],c=this.axialSlice.finalTransform[1][2]+this.axialSlice.yDim*this.axialSlice.finalTransform[1][1],this.context.moveTo(a,b),this.context.lineTo(a,c),d=this.axialSlice.finalTransform[1][2]+(this.currentCoord.y+.5)*this.axialSlice.finalTransform[1][1],e=this.axialSlice.finalTransform[0][2],f=this.axialSlice.finalTransform[0][2]+this.axialSlice.xDim*this.axialSlice.finalTransform[0][0],this.context.moveTo(e,d),this.context.lineTo(f,d),this.context.closePath(),this.context.stroke(),this.context.restore()),(this.mainImage!==this.coronalSlice||this.toggleMainCrosshairs)&&(this.context.save(),this.context.beginPath(),this.context.rect(this.coronalSlice.screenOffsetX,this.coronalSlice.screenOffsetY,this.coronalSlice.screenDim,this.coronalSlice.screenDim),this.context.closePath(),this.context.clip(),this.context.beginPath(),a=this.coronalSlice.finalTransform[0][2]+(this.currentCoord.x+.5)*this.coronalSlice.finalTransform[0][0],b=this.coronalSlice.finalTransform[1][2],c=this.coronalSlice.finalTransform[1][2]+this.coronalSlice.yDim*this.coronalSlice.finalTransform[1][1],this.context.moveTo(a,b),this.context.lineTo(a,c),d=this.coronalSlice.finalTransform[1][2]+(this.currentCoord.z+.5)*this.coronalSlice.finalTransform[1][1],e=this.coronalSlice.finalTransform[0][2],f=this.coronalSlice.finalTransform[0][2]+this.coronalSlice.xDim*this.coronalSlice.finalTransform[0][0],this.context.moveTo(e,d),this.context.lineTo(f,d),this.context.closePath(),this.context.stroke(),this.context.restore()),(this.mainImage!==this.sagittalSlice||this.toggleMainCrosshairs)&&(this.context.save(),this.context.beginPath(),this.context.rect(this.sagittalSlice.screenOffsetX,this.sagittalSlice.screenOffsetY,this.sagittalSlice.screenDim,this.sagittalSlice.screenDim),this.context.closePath(),this.context.clip(),this.context.beginPath(),a=this.sagittalSlice.finalTransform[0][2]+(this.currentCoord.y+.5)*this.sagittalSlice.finalTransform[0][0],b=this.sagittalSlice.finalTransform[1][2],c=this.sagittalSlice.finalTransform[1][2]+this.sagittalSlice.yDim*this.sagittalSlice.finalTransform[1][1],this.context.moveTo(a,b),this.context.lineTo(a,c),d=this.sagittalSlice.finalTransform[1][2]+(this.currentCoord.z+.5)*this.sagittalSlice.finalTransform[1][1],e=this.sagittalSlice.finalTransform[0][2],f=this.sagittalSlice.finalTransform[0][2]+this.sagittalSlice.xDim*this.sagittalSlice.finalTransform[0][0],this.context.moveTo(e,d),this.context.lineTo(f,d),this.context.closePath(),this.context.stroke(),this.context.restore())},papaya.viewer.Viewer.prototype.calculateScreenSliceTransforms=function(){this.container.orthogonalTall?this.container.hasSurface()?(this.viewerDim=this.canvas.height/1.333,this.getTransformParameters(this.mainImage,this.viewerDim,!1,3),this.mainImage.screenTransform[0][2]+=this.mainImage.screenOffsetX=0,this.mainImage.screenTransform[1][2]+=this.mainImage.screenOffsetY=0,this.getTransformParameters(this.lowerImageTop,this.viewerDim,!0,3),this.lowerImageTop.screenTransform[0][2]+=this.lowerImageTop.screenOffsetX=0,this.lowerImageTop.screenTransform[1][2]+=this.lowerImageTop.screenOffsetY=this.viewerDim+papaya.viewer.Viewer.GAP,this.getTransformParameters(this.lowerImageBot,this.viewerDim,!0,3),this.lowerImageBot.screenTransform[0][2]+=this.lowerImageBot.screenOffsetX=(this.viewerDim-papaya.viewer.Viewer.GAP)/3+papaya.viewer.Viewer.GAP,this.lowerImageBot.screenTransform[1][2]+=this.lowerImageBot.screenOffsetY=this.viewerDim+papaya.viewer.Viewer.GAP,this.getTransformParameters(this.lowerImageBot2,this.viewerDim,!0,3),this.lowerImageBot2.screenTransform[0][2]+=this.lowerImageBot2.screenOffsetX=2*((this.viewerDim-papaya.viewer.Viewer.GAP)/3+papaya.viewer.Viewer.GAP),this.lowerImageBot2.screenTransform[1][2]+=this.lowerImageBot2.screenOffsetY=this.viewerDim+papaya.viewer.Viewer.GAP):(this.viewerDim=this.canvas.height/1.5,this.getTransformParameters(this.mainImage,this.viewerDim,!1,2),this.mainImage.screenTransform[0][2]+=this.mainImage.screenOffsetX=0,this.mainImage.screenTransform[1][2]+=this.mainImage.screenOffsetY=0,this.getTransformParameters(this.lowerImageBot,this.viewerDim,!0,2),this.lowerImageBot.screenTransform[0][2]+=this.lowerImageBot.screenOffsetX=0,this.lowerImageBot.screenTransform[1][2]+=this.lowerImageBot.screenOffsetY=this.viewerDim+papaya.viewer.Viewer.GAP,this.getTransformParameters(this.lowerImageTop,this.viewerDim,!0,2),this.lowerImageTop.screenTransform[0][2]+=this.lowerImageTop.screenOffsetX=(this.viewerDim-papaya.viewer.Viewer.GAP)/2+papaya.viewer.Viewer.GAP,this.lowerImageTop.screenTransform[1][2]+=this.lowerImageTop.screenOffsetY=this.viewerDim+papaya.viewer.Viewer.GAP):(this.viewerDim=this.canvas.height,this.container.hasSurface()?(this.getTransformParameters(this.mainImage,this.viewerDim,!1,3),this.mainImage.screenTransform[0][2]+=this.mainImage.screenOffsetX=0,this.mainImage.screenTransform[1][2]+=this.mainImage.screenOffsetY=0,this.getTransformParameters(this.lowerImageTop,this.viewerDim,!0,3),this.lowerImageTop.screenTransform[0][2]+=this.lowerImageTop.screenOffsetX=this.viewerDim+papaya.viewer.Viewer.GAP,this.lowerImageTop.screenTransform[1][2]+=this.lowerImageTop.screenOffsetY=0,this.getTransformParameters(this.lowerImageBot,this.viewerDim,!0,3),this.lowerImageBot.screenTransform[0][2]+=this.lowerImageBot.screenOffsetX=this.viewerDim+papaya.viewer.Viewer.GAP,this.lowerImageBot.screenTransform[1][2]+=this.lowerImageBot.screenOffsetY=(this.viewerDim-papaya.viewer.Viewer.GAP)/3+papaya.viewer.Viewer.GAP,this.getTransformParameters(this.lowerImageBot2,this.viewerDim,!0,3),this.lowerImageBot2.screenTransform[0][2]+=this.lowerImageBot2.screenOffsetX=this.viewerDim+papaya.viewer.Viewer.GAP,this.lowerImageBot2.screenTransform[1][2]+=this.lowerImageBot2.screenOffsetY=(this.viewerDim-papaya.viewer.Viewer.GAP)/3*2+2*papaya.viewer.Viewer.GAP):(this.getTransformParameters(this.mainImage,this.viewerDim,!1,2),this.mainImage.screenTransform[0][2]+=this.mainImage.screenOffsetX=0,this.mainImage.screenTransform[1][2]+=this.mainImage.screenOffsetY=0,this.getTransformParameters(this.lowerImageBot,this.viewerDim,!0,2),this.lowerImageBot.screenTransform[0][2]+=this.lowerImageBot.screenOffsetX=this.viewerDim+papaya.viewer.Viewer.GAP,this.lowerImageBot.screenTransform[1][2]+=this.lowerImageBot.screenOffsetY=(this.viewerDim-papaya.viewer.Viewer.GAP)/2+papaya.viewer.Viewer.GAP,this.getTransformParameters(this.lowerImageTop,this.viewerDim,!0,2),this.lowerImageTop.screenTransform[0][2]+=this.lowerImageTop.screenOffsetX=this.viewerDim+papaya.viewer.Viewer.GAP,this.lowerImageTop.screenTransform[1][2]+=this.lowerImageTop.screenOffsetY=0)),this.updateScreenSliceTransforms()},papaya.viewer.Viewer.prototype.updateScreenSliceTransforms=function(){this.axialSlice.updateFinalTransform(),this.coronalSlice.updateFinalTransform(),this.sagittalSlice.updateFinalTransform()},papaya.viewer.Viewer.prototype.getTransformParameters=function(a,b,c,d){var e,f,g,h,i;return e=c?d:1,a===this.surfaceView?void this.surfaceView.resize(this.viewerDim/e):(a.getRealWidth()>a.getRealHeight()?(f=(c?b-papaya.viewer.Viewer.GAP:b)/this.longestDim/e*(a.getXSize()/this.longestDimSize),g=(c?b-papaya.viewer.Viewer.GAP:b)/this.longestDim*a.getYXratio()/e*(a.getXSize()/this.longestDimSize)):(f=(c?b-papaya.viewer.Viewer.GAP:b)/this.longestDim*a.getXYratio()/e*(a.getYSize()/this.longestDimSize),
g=(c?b-papaya.viewer.Viewer.GAP:b)/this.longestDim/e*(a.getYSize()/this.longestDimSize)),h=((c?b-papaya.viewer.Viewer.GAP:b)/e-a.getXDim()*f)/2,i=((c?b-papaya.viewer.Viewer.GAP:b)/e-a.getYDim()*g)/2,a.screenDim=c?(b-papaya.viewer.Viewer.GAP)/d:b,a.screenTransform[0][0]=f,a.screenTransform[1][1]=g,a.screenTransform[0][2]=h,a.screenTransform[1][2]=i,a.screenTransform2[0][0]=f,a.screenTransform2[1][1]=g,a.screenTransform2[0][2]=h,void(a.screenTransform2[1][2]=i))},papaya.viewer.Viewer.prototype.setLongestDim=function(a){this.longestDim=a.getXDim(),this.longestDimSize=a.getXSize(),a.getYDim()*a.getYSize()>this.longestDim*this.longestDimSize&&(this.longestDim=a.getYDim(),this.longestDimSize=a.getYSize()),a.getZDim()*a.getZSize()>this.longestDim*this.longestDimSize&&(this.longestDim=a.getZDim(),this.longestDimSize=a.getZSize())},papaya.viewer.Viewer.prototype.keyDownEvent=function(a){var b,c;this.keyPressIgnored=!1,this.container.toolbar.isShowingMenus()||(papayaContainers.length>1||papayaContainers[0].nestedViewer)&&papaya.Container.papayaLastHoveredViewer!==this||(b=papaya.viewer.Viewer.getKeyCode(a),papaya.viewer.Viewer.isControlKey(a)?this.isControlKeyDown=!0:papaya.viewer.Viewer.isAltKey(a)?this.isAltKeyDown=!0:papaya.viewer.Viewer.isShiftKey(a)?this.isShiftKeyDown=!0:b===papaya.viewer.Viewer.KEYCODE_ROTATE_VIEWS?this.rotateViews():b===papaya.viewer.Viewer.KEYCODE_CENTER?(c=new papaya.core.Coordinate(Math.floor(this.volume.header.imageDimensions.xDim/2),Math.floor(this.volume.header.imageDimensions.yDim/2),Math.floor(this.volume.header.imageDimensions.zDim/2)),this.gotoCoordinate(c)):b===papaya.viewer.Viewer.KEYCODE_ORIGIN?this.gotoCoordinate(this.volume.header.origin):b===papaya.viewer.Viewer.KEYCODE_ARROW_UP?this.incrementCoronal(!1):b===papaya.viewer.Viewer.KEYCODE_ARROW_DOWN?this.incrementCoronal(!0):b===papaya.viewer.Viewer.KEYCODE_ARROW_LEFT?this.incrementSagittal(!0):b===papaya.viewer.Viewer.KEYCODE_ARROW_RIGHT?this.incrementSagittal(!1):b===papaya.viewer.Viewer.KEYCODE_PAGE_DOWN||b===papaya.viewer.Viewer.KEYCODE_FORWARD_SLASH?this.incrementAxial(!0):b===papaya.viewer.Viewer.KEYCODE_PAGE_UP||b===papaya.viewer.Viewer.KEYCODE_SINGLE_QUOTE?this.incrementAxial(!1):b===papaya.viewer.Viewer.KEYCODE_INCREMENT_MAIN?this.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?this.incrementAxial(!1):this.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?this.incrementCoronal(!1):this.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&this.incrementSagittal(!0):b===papaya.viewer.Viewer.KEYCODE_DECREMENT_MAIN?this.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?this.incrementAxial(!0):this.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?this.incrementCoronal(!0):this.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&this.incrementSagittal(!1):b===papaya.viewer.Viewer.KEYCODE_TOGGLE_CROSSHAIRS?"Yes"===this.container.preferences.showCrosshairs&&(this.toggleMainCrosshairs=!this.toggleMainCrosshairs,this.drawViewer(!0)):b===papaya.viewer.Viewer.KEYCODE_SERIES_FORWARD?this.incrementSeriesPoint():b===papaya.viewer.Viewer.KEYCODE_SERIES_BACK?this.decrementSeriesPoint():b===papaya.viewer.Viewer.KEYCODE_RULER?("Yes"===this.container.preferences.showRuler?this.container.preferences.showRuler="No":this.container.preferences.showRuler="Yes",this.drawViewer(!0,!0)):this.keyPressIgnored=!0,this.keyPressIgnored||(a.handled=!0,a.preventDefault()))},papaya.viewer.Viewer.prototype.keyUpEvent=function(a){papayaContainers.length>1&&papaya.Container.papayaLastHoveredViewer!==this||(this.isControlKeyDown=!1,this.isAltKeyDown=!1,this.isShiftKeyDown=!1,this.keyPressIgnored||(a.handled=!0,a.preventDefault()),this.hasSurface()&&papaya.utilities.PlatformUtils.smallScreen&&this.drawViewer(!0,!1))},papaya.viewer.Viewer.prototype.rotateViews=function(){var a;this.container.contextManager&&this.container.contextManager.clearContext&&this.container.contextManager.clearContext(),this.hasSurface()?(a=this.lowerImageBot2,this.lowerImageBot2=this.lowerImageBot,this.lowerImageBot=this.lowerImageTop,this.lowerImageTop=this.mainImage,this.mainImage=a):(a=this.lowerImageBot,this.lowerImageBot=this.lowerImageTop,this.lowerImageTop=this.mainImage,this.mainImage=a),this.viewsChanged()},papaya.viewer.Viewer.prototype.viewsChanged=function(){this.calculateScreenSliceTransforms(),this.hasSurface()&&this.lowerImageBot2.clearDTILinesImage(),this.lowerImageBot.clearDTILinesImage(),this.lowerImageTop.clearDTILinesImage(),this.mainImage.clearDTILinesImage(),this.controlsHidden||(this.mainImage!==this.surfaceView?this.fadeInControls():($("#"+PAPAYA_CONTROL_MAIN_INCREMENT_BUTTON_CSS+this.container.containerIndex).fadeOut(),$("#"+PAPAYA_CONTROL_MAIN_DECREMENT_BUTTON_CSS+this.container.containerIndex).fadeOut()),$("#"+PAPAYA_DEFAULT_SLIDER_ID+this.container.containerIndex+"main").find("button").prop("disabled",this.mainImage===this.surfaceView)),this.drawViewer(!0),this.updateSliceSliderControl()},papaya.viewer.Viewer.prototype.timepointChanged=function(){this.drawViewer(!0),this.updateSliceSliderControl(),this.updateWindowTitle()},papaya.viewer.Viewer.prototype.resetUpdateTimer=function(a){var b=this;null!==this.updateTimer&&(window.clearTimeout(this.updateTimer),this.updateTimer=null,this.updateTimerEvent=null),null!==a&&(this.updateTimerEvent=a,this.updateTimer=window.setTimeout(papaya.utilities.ObjectUtils.bind(b,function(){b.updatePosition(this,papaya.utilities.PlatformUtils.getMousePositionX(b.updateTimerEvent),papaya.utilities.PlatformUtils.getMousePositionY(b.updateTimerEvent))}),papaya.viewer.Viewer.UPDATE_TIMER_INTERVAL))},papaya.viewer.Viewer.prototype.mouseDownEvent=function(a){var b,c,d,e=!0;if(papaya.Container.allowPropagation||a.stopPropagation(),a.preventDefault(),this.showingContextMenu)return this.container.toolbar.closeAllMenus(),void(a.handled=!0);if("IMG"===a.target.nodeName||"CANVAS"===a.target.nodeName){if(a.handled!==!0){if(this.container.toolbar.closeAllMenus(),this.previousMousePosition.x=papaya.utilities.PlatformUtils.getMousePositionX(a),this.previousMousePosition.y=papaya.utilities.PlatformUtils.getMousePositionY(a),this.findClickedSlice(this,this.previousMousePosition.x,this.previousMousePosition.y),(2===a.button||this.isControlKeyDown||this.isLongTouch)&&this.container.contextManager&&this.selectedSlice===this.mainImage&&this.mainImage===this.surfaceView)this.contextMenuMousePositionX=this.previousMousePosition.x-this.canvasRect.left,this.contextMenuMousePositionY=this.previousMousePosition.y-this.canvasRect.top,this.container.contextManager.prefersColorPicking&&this.container.contextManager.prefersColorPicking()&&(d=this.surfaceView.pickColor(this.contextMenuMousePositionX,this.contextMenuMousePositionY),b=this.container.contextManager.getContextAtColor(d[0],d[1],d[2])),b&&(this.isContextMode=!0,c=this.container.toolbar.buildMenu(b,null,null,null,!0),papaya.ui.Toolbar.applyContextState(c),e=!1,c.showMenu(),this.showingContextMenu=!0),this.isContextMode=!0;else if((2===a.button||this.isControlKeyDown||this.isLongTouch)&&this.container.contextManager&&this.selectedSlice===this.mainImage){if(this.isLongTouch){var f=this.convertCurrentCoordinateToScreen(this.mainImage);this.contextMenuMousePositionX=f.x,this.contextMenuMousePositionY=f.y,b=this.container.contextManager.getContextAtImagePosition(this.currentCoord.x,this.currentCoord.y,this.currentCoord.z)}else this.contextMenuMousePositionX=this.previousMousePosition.x-this.canvasRect.left,this.contextMenuMousePositionY=this.previousMousePosition.y-this.canvasRect.top,b=this.container.contextManager.getContextAtImagePosition(this.cursorPosition.x,this.cursorPosition.y,this.cursorPosition.z);b&&(this.isContextMode=!0,c=this.container.toolbar.buildMenu(b,null,null,null,!0),papaya.ui.Toolbar.applyContextState(c),e=!1,c.showMenu(),this.showingContextMenu=!0)}else 2!==a.button&&!this.isControlKeyDown||this.currentScreenVolume.rgb?this.isAltKeyDown&&this.selectedSlice?(this.isZoomMode=!0,this.selectedSlice===this.surfaceView?(this.isPanning=this.isShiftKeyDown,this.surfaceView.setStartDynamic(this.previousMousePosition.x,this.previousMousePosition.y)):this.isZooming()&&this.isShiftKeyDown?(this.isPanning=!0,this.setStartPanLocation(this.convertScreenToImageCoordinateX(this.previousMousePosition.x,this.selectedSlice),this.convertScreenToImageCoordinateY(this.previousMousePosition.y,this.selectedSlice),this.selectedSlice.sliceDirection)):this.setZoomLocation()):this.selectedSlice&&this.selectedSlice!==this.surfaceView?(this.grabbedHandle=this.selectedSlice.findProximalRulerHandle(this.convertScreenToImageCoordinateX(this.previousMousePosition.x-this.canvasRect.left,this.selectedSlice),this.convertScreenToImageCoordinateY(this.previousMousePosition.y-this.canvasRect.top,this.selectedSlice)),null===this.grabbedHandle&&(this.updatePosition(this,papaya.utilities.PlatformUtils.getMousePositionX(a),papaya.utilities.PlatformUtils.getMousePositionY(a),!1),this.resetUpdateTimer(a))):this.selectedSlice&&this.selectedSlice===this.surfaceView&&(this.surfaceView.findProximalRulerHandle(this.previousMousePosition.x-this.canvasRect.left,this.previousMousePosition.y-this.canvasRect.top)||(this.isPanning=this.isShiftKeyDown,this.surfaceView.setStartDynamic(this.previousMousePosition.x,this.previousMousePosition.y)),this.container.display.drawEmptyDisplay()):(this.isWindowControl=!0,this.container.showImageButtons&&(this.container.showControlBar||!this.container.kioskMode)&&this.screenVolumes[this.getCurrentScreenVolIndex()].supportsDynamicColorTable()&&this.container.toolbar.showImageMenu(this.getCurrentScreenVolIndex()));this.isDragging=e,a.handled=!0}this.controlsHidden||(this.controlsHiddenPrimed=!0)}},papaya.viewer.Viewer.prototype.mouseUpEvent=function(a){return papaya.Container.allowPropagation||a.stopPropagation(),a.preventDefault(),this.showingContextMenu?(this.showingContextMenu=!1,void(a.handled=!0)):("IMG"!==a.target.nodeName&&"CANVAS"!==a.target.nodeName||a.handled!==!0&&(this.isWindowControl||this.isZoomMode||this.isContextMode||null!==this.grabbedHandle||this.surfaceView&&this.surfaceView.grabbedRulerPoint!==-1||this.updatePosition(this,papaya.utilities.PlatformUtils.getMousePositionX(a),papaya.utilities.PlatformUtils.getMousePositionY(a)),this.selectedSlice===this.surfaceView&&this.updateCursorPosition(this,papaya.utilities.PlatformUtils.getMousePositionX(a),papaya.utilities.PlatformUtils.getMousePositionY(a)),this.zoomFactorPrevious=this.zoomFactor,this.isDragging=!1,this.isWindowControl=!1,this.isZoomMode=!1,this.isPanning=!1,this.selectedSlice=null,this.controlsHiddenPrimed=!1,a.handled=!0),this.grabbedHandle=null,this.isContextMode=!1,this.updateWindowTitle(),this.updateSliceSliderControl(),this.container.toolbar.closeAllMenus(!0),this.hasSurface()&&(this.surfaceView.grabbedRulerPoint===-1?this.surfaceView.updateCurrent():this.surfaceView.grabbedRulerPoint=-1,papaya.utilities.PlatformUtils.smallScreen&&this.drawViewer(!0,!1)),void(this.controlsHidden&&(this.controlsHidden=!1,this.fadeInControls())))},papaya.viewer.Viewer.prototype.fadeOutControls=function(){$("#"+PAPAYA_CONTROL_MAIN_INCREMENT_BUTTON_CSS+this.container.containerIndex).fadeOut(),$("#"+PAPAYA_CONTROL_MAIN_DECREMENT_BUTTON_CSS+this.container.containerIndex).fadeOut(),$("#"+PAPAYA_CONTROL_MAIN_SWAP_BUTTON_CSS+this.container.containerIndex).fadeOut(),$("#"+PAPAYA_CONTROL_MAIN_GOTO_CENTER_BUTTON_CSS+this.container.containerIndex).fadeOut(),$("#"+PAPAYA_CONTROL_MAIN_GOTO_ORIGIN_BUTTON_CSS+this.container.containerIndex).fadeOut()},papaya.viewer.Viewer.prototype.fadeInControls=function(){this.container.getViewerDimensions()[0]<600?(this.mainImage!==this.surfaceView&&($("#"+PAPAYA_CONTROL_MAIN_INCREMENT_BUTTON_CSS+this.container.containerIndex).fadeIn(),$("#"+PAPAYA_CONTROL_MAIN_DECREMENT_BUTTON_CSS+this.container.containerIndex).fadeIn()),$("#"+PAPAYA_CONTROL_MAIN_SWAP_BUTTON_CSS+this.container.containerIndex).fadeIn()):(this.mainImage!==this.surfaceView&&($("#"+PAPAYA_CONTROL_MAIN_INCREMENT_BUTTON_CSS+this.container.containerIndex).fadeIn(),$("#"+PAPAYA_CONTROL_MAIN_DECREMENT_BUTTON_CSS+this.container.containerIndex).fadeIn()),$("#"+PAPAYA_CONTROL_MAIN_SWAP_BUTTON_CSS+this.container.containerIndex).fadeIn(),$("#"+PAPAYA_CONTROL_MAIN_GOTO_CENTER_BUTTON_CSS+this.container.containerIndex).fadeIn(),$("#"+PAPAYA_CONTROL_MAIN_GOTO_ORIGIN_BUTTON_CSS+this.container.containerIndex).fadeIn())},papaya.viewer.Viewer.prototype.findClickedSlice=function(a,b,c){b-=this.canvasRect.left,c-=this.canvasRect.top,this.insideScreenSlice(a.axialSlice,b,c,a.volume.getXDim(),a.volume.getYDim())?this.selectedSlice=this.axialSlice:this.insideScreenSlice(a.coronalSlice,b,c,a.volume.getXDim(),a.volume.getZDim())?this.selectedSlice=this.coronalSlice:this.insideScreenSlice(a.sagittalSlice,b,c,a.volume.getYDim(),a.volume.getZDim())?this.selectedSlice=this.sagittalSlice:this.insideScreenSlice(a.surfaceView,b,c,a.volume.getYDim(),a.volume.getZDim())?this.selectedSlice=this.surfaceView:this.selectedSlice=null},papaya.viewer.Viewer.prototype.mouseMoveEvent=function(a){if(a.preventDefault(),this.showingContextMenu)return void(a.handled=!0);var b,c,d;papaya.Container.papayaLastHoveredViewer=this,b=papaya.utilities.PlatformUtils.getMousePositionX(a),c=papaya.utilities.PlatformUtils.getMousePositionY(a),this.isDragging?this.grabbedHandle?this.isInsideMainSlice(b,c)&&(this.grabbedHandle.x=this.convertScreenToImageCoordinateX(b-this.canvasRect.left,this.selectedSlice),this.grabbedHandle.y=this.convertScreenToImageCoordinateY(c-this.canvasRect.top,this.selectedSlice),this.drawViewer(!0,!0)):this.isWindowControl?(this.windowLevelChanged(this.previousMousePosition.x-b,this.previousMousePosition.y-c),this.previousMousePosition.x=b,this.previousMousePosition.y=c):this.isPanning?this.selectedSlice===this.surfaceView?(this.surfaceView.updateTranslateDynamic(papaya.utilities.PlatformUtils.getMousePositionX(a),papaya.utilities.PlatformUtils.getMousePositionY(a),this.selectedSlice===this.mainImage?1:3),this.drawViewer(!1,!0)):this.setCurrentPanLocation(this.convertScreenToImageCoordinateX(b,this.selectedSlice),this.convertScreenToImageCoordinateY(c,this.selectedSlice),this.selectedSlice.sliceDirection):this.isZoomMode?(this.selectedSlice===this.surfaceView?(d=.5*(this.previousMousePosition.y-c)*this.surfaceView.scaleFactor,this.surfaceView.zoom+=d,this.previousMousePosition.x=b,this.previousMousePosition.y=c):(d=.05*(this.previousMousePosition.y-c),this.setZoomFactor(this.zoomFactorPrevious-d),this.axialSlice.updateZoomTransform(this.zoomFactor,this.zoomLocX,this.zoomLocY,this.panAmountX,this.panAmountY,this),this.coronalSlice.updateZoomTransform(this.zoomFactor,this.zoomLocX,this.zoomLocZ,this.panAmountX,this.panAmountZ,this),this.sagittalSlice.updateZoomTransform(this.zoomFactor,this.zoomLocY,this.zoomLocZ,this.panAmountY,this.panAmountZ,this)),this.drawViewer(!0)):(this.resetUpdateTimer(null),null!==this.selectedSlice&&(this.selectedSlice===this.surfaceView?this.surfaceView.grabbedRulerPoint!==-1?(this.surfaceView.pickRuler(b-this.canvasRect.left,c-this.canvasRect.top),this.drawViewer(!1,!0)):(this.surfaceView.updateDynamic(papaya.utilities.PlatformUtils.getMousePositionX(a),papaya.utilities.PlatformUtils.getMousePositionY(a),this.selectedSlice===this.mainImage?1:3),this.drawViewer(!1,!0),this.container.display.drawEmptyDisplay()):this.updatePosition(this,papaya.utilities.PlatformUtils.getMousePositionX(a),papaya.utilities.PlatformUtils.getMousePositionY(a)))):(this.updateCursorPosition(this,papaya.utilities.PlatformUtils.getMousePositionX(a),papaya.utilities.PlatformUtils.getMousePositionY(a)),this.isZoomMode=!1),this.controlsHidden&&!this.isDragging&&(this.controlsHidden=!1,this.fadeInControls()),this.controlsTimer&&(clearTimeout(this.controlsTimer),this.controlsTimer=null),this.controlsTimer=setTimeout(papaya.utilities.ObjectUtils.bind(this,function(){this.controlsHidden=!0,this.fadeOutControls()}),8e3),this.controlsHiddenPrimed&&(this.controlsHiddenPrimed=!1,this.controlsHidden=!0,this.fadeOutControls())},papaya.viewer.Viewer.prototype.mouseDoubleClickEvent=function(){this.isAltKeyDown&&(this.zoomFactorPrevious=1,this.setZoomFactor(1))},papaya.viewer.Viewer.prototype.mouseOutEvent=function(a){papaya.Container.papayaLastHoveredViewer=null,this.isDragging?this.mouseUpEvent(a):(this.container.display&&this.container.display.drawEmptyDisplay(),this.grabbedHandle=null)},papaya.viewer.Viewer.prototype.mouseLeaveEvent=function(){},papaya.viewer.Viewer.prototype.touchMoveEvent=function(a){this.didLongTouch||(this.longTouchTimer&&(clearTimeout(this.longTouchTimer),this.longTouchTimer=null),this.isDragging||(this.mouseDownEvent(a),this.isDragging=!0),this.mouseMoveEvent(a))},papaya.viewer.Viewer.prototype.touchStartEvent=function(a){papaya.Container.allowPropagation||a.stopPropagation(),a.preventDefault(),this.longTouchTimer=setTimeout(papaya.utilities.ObjectUtils.bind(this,function(){this.doLongTouch(a)}),500)},papaya.viewer.Viewer.prototype.touchEndEvent=function(a){this.didLongTouch||(this.longTouchTimer&&(clearTimeout(this.longTouchTimer),this.longTouchTimer=null),this.isDragging||this.mouseDownEvent(a),this.mouseUpEvent(a)),this.didLongTouch=!1,this.isLongTouch=!1},papaya.viewer.Viewer.prototype.doLongTouch=function(a){this.longTouchTimer=null,this.didLongTouch=!0,this.isLongTouch=!0,this.updateCursorPosition(this,papaya.utilities.PlatformUtils.getMousePositionX(a),papaya.utilities.PlatformUtils.getMousePositionY(a)),this.mouseDownEvent(a),this.mouseUpEvent(a)},papaya.viewer.Viewer.prototype.windowLevelChanged=function(a,b){var c,d,e,f;c=this.currentScreenVolume.screenMax-this.currentScreenVolume.screenMin,d=.025*c,Math.abs(a)>Math.abs(b)?(e=this.currentScreenVolume.screenMin+d*papaya.utilities.MathUtils.signum(a),f=this.currentScreenVolume.screenMax+-1*d*papaya.utilities.MathUtils.signum(a),f<=e&&(e=this.currentScreenVolume.screenMin,f=this.currentScreenVolume.screenMin)):(e=this.currentScreenVolume.screenMin+d*papaya.utilities.MathUtils.signum(b),f=this.currentScreenVolume.screenMax+d*papaya.utilities.MathUtils.signum(b)),this.currentScreenVolume.setScreenRange(e,f),this.container.showImageButtons&&this.container.toolbar.updateImageMenuRange(this.getCurrentScreenVolIndex(),parseFloat(e.toPrecision(7)),parseFloat(f.toPrecision(7))),this.drawViewer(!0)},papaya.viewer.Viewer.prototype.gotoCoordinate=function(a,b){if(this.initialized){var c=this.volume.header.imageDimensions.xDim,d=this.volume.header.imageDimensions.yDim,e=this.volume.header.imageDimensions.zDim;a.x<0?this.currentCoord.x=0:a.x>=c?this.currentCoord.x=c-1:this.currentCoord.x=a.x,a.y<0?this.currentCoord.y=0:a.y>=d?this.currentCoord.y=d-1:this.currentCoord.y=a.y,a.z<0?this.currentCoord.z=0:a.z>=e?this.currentCoord.z=e-1:this.currentCoord.z=a.z,this.drawViewer(!0),this.updateSliceSliderControl(),b||(this.container.coordinateChanged(this),this.drawViewer(!1))}},papaya.viewer.Viewer.prototype.gotoWorldCoordinate=function(a,b){var c=new papaya.core.Coordinate;this.gotoCoordinate(this.getIndexCoordinateAtWorld(a.x,a.y,a.z,c),b)},papaya.viewer.Viewer.prototype.resizeViewer=function(a){var b,c,d,e,f,g;PAPAYA_PADDING/2;if(this.canvas.width=a[0],this.canvas.height=a[1],this.initialized&&(this.calculateScreenSliceTransforms(),this.canvasRect=this.canvas.getBoundingClientRect(),this.drawViewer(!0),this.container.showControls)){b=$(this.canvas).offset();var h=$("#papayaViewer0").width();$("#papayaViewer0").height();$("#papayaViewer0").css({position:"relative"}),e=$("#"+PAPAYA_CONTROL_MAIN_INCREMENT_BUTTON_CSS+this.container.containerIndex),e.css({top:5,left:2*h/3,position:"absolute"}),f=$("#"+PAPAYA_CONTROL_MAIN_DECREMENT_BUTTON_CSS+this.container.containerIndex),f.css({top:25,left:2*h/3,position:"absolute"}),c=$("#"+PAPAYA_CONTROL_MAIN_SWAP_BUTTON_CSS+this.container.containerIndex),c.css({bottom:5,left:2*h/3,position:"absolute"}),g=$("#"+PAPAYA_CONTROL_MAIN_GOTO_CENTER_BUTTON_CSS+this.container.containerIndex),g.css({bottom:5,left:5,position:"absolute"}),d=$("#"+PAPAYA_CONTROL_MAIN_GOTO_ORIGIN_BUTTON_CSS+this.container.containerIndex),d.css({bottom:5,left:35,position:"absolute"})}},papaya.viewer.Viewer.prototype.getWorldCoordinateAtIndex=function(a,b,c,d){return d.setCoordinate((a-this.volume.header.origin.x)*this.volume.header.voxelDimensions.xSize,(this.volume.header.origin.y-b)*this.volume.header.voxelDimensions.ySize,(this.volume.header.origin.z-c)*this.volume.header.voxelDimensions.zSize),d},papaya.viewer.Viewer.prototype.getIndexCoordinateAtWorld=function(a,b,c,d){return d.setCoordinate(a/this.volume.header.voxelDimensions.xSize+this.volume.header.origin.x,-1*(b/this.volume.header.voxelDimensions.ySize-this.volume.header.origin.y),-1*(c/this.volume.header.voxelDimensions.zSize-this.volume.header.origin.z),!0),d},papaya.viewer.Viewer.prototype.getNextColorTable=function(){var a,b,c=0;for(a=1;a<this.screenVolumes.length;a+=1)this.screenVolumes[a].dti||(c+=1);return b=c%papaya.viewer.ColorTable.OVERLAY_COLOR_TABLES.length,papaya.viewer.ColorTable.OVERLAY_COLOR_TABLES[b].name},papaya.viewer.Viewer.prototype.getCurrentValueAt=function(a,b,c){var d=this.axialSlice.xDim-a-1,e=!this.currentScreenVolume.interpolation;return e&="Yes"===this.container.preferences.smoothDisplay,this.worldSpace?(e|=this.currentScreenVolume.volume===this.volume&&this.volume.isWorldSpaceOnly(),this.currentScreenVolume.volume.getVoxelAtCoordinate((d-this.volume.header.origin.x)*this.volume.header.voxelDimensions.xSize,(this.volume.header.origin.y-b)*this.volume.header.voxelDimensions.ySize,(this.volume.header.origin.z-c)*this.volume.header.voxelDimensions.zSize,this.currentScreenVolume.currentTimepoint,!e)):this.currentScreenVolume.volume.getVoxelAtMM(d*this.volume.header.voxelDimensions.xSize,b*this.volume.header.voxelDimensions.ySize,c*this.volume.header.voxelDimensions.zSize,this.currentScreenVolume.currentTimepoint,!e)},papaya.viewer.Viewer.prototype.resetViewer=function(){this.container.showControlBar?($("."+PAPAYA_CONTROL_INCREMENT_BUTTON_CSS).prop("disabled",!0),$("."+PAPAYA_CONTROL_SWAP_BUTTON_CSS).prop("disabled",!0),$("."+PAPAYA_CONTROL_GOTO_CENTER_BUTTON_CSS).prop("disabled",!0),$("."+PAPAYA_CONTROL_GOTO_ORIGIN_BUTTON_CSS).prop("disabled",!0)):this.container.showControls&&($("#"+PAPAYA_CONTROL_MAIN_INCREMENT_BUTTON_CSS+this.container.containerIndex).css({display:"none"}),$("#"+PAPAYA_CONTROL_MAIN_DECREMENT_BUTTON_CSS+this.container.containerIndex).css({display:"none"}),$("#"+PAPAYA_CONTROL_MAIN_SWAP_BUTTON_CSS+this.container.containerIndex).css({display:"none"}),$("#"+PAPAYA_CONTROL_MAIN_GOTO_CENTER_BUTTON_CSS+this.container.containerIndex).css({display:"none"}),$("#"+PAPAYA_CONTROL_MAIN_GOTO_ORIGIN_BUTTON_CSS+this.container.containerIndex).css({display:"none"})),this.initialized=!1,this.loadingVolume=null,this.volume=new papaya.volume.Volume(this.container.display,this),this.screenVolumes=[],this.surfaces=[],this.surfaceView=null,this.currentScreenVolume=null,this.axialSlice=null,this.coronalSlice=null,this.sagittalSlice=null,this.mainImage=null,this.lowerImageBot2=null,this.lowerImageBot=null,this.lowerImageTop=null,this.viewerDim=0,this.currentCoord=new papaya.core.Coordinate(0,0,0),this.longestDim=0,this.longestDimSize=0,this.draggingSliceDir=0,this.isDragging=!1,this.isWindowControl=!1,this.hasSeries=!1,this.previousMousePosition=new papaya.core.Point,this.canvas.removeEventListener("mousemove",this.listenerMouseMove,!1),this.canvas.removeEventListener("mousedown",this.listenerMouseDown,!1),this.canvas.removeEventListener("mouseout",this.listenerMouseOut,!1),this.canvas.removeEventListener("mouseleave",this.listenerMouseLeave,!1),this.canvas.removeEventListener("mouseup",this.listenerMouseUp,!1),document.removeEventListener("keydown",this.listenerKeyDown,!0),document.removeEventListener("keyup",this.listenerKeyUp,!0),document.removeEventListener("contextmenu",this.listenerContextMenu,!1),this.canvas.removeEventListener("touchmove",this.listenerTouchMove,!1),this.canvas.removeEventListener("touchstart",this.listenerTouchStart,!1),this.canvas.removeEventListener("touchend",this.listenerTouchEnd,!1),this.canvas.removeEventListener("dblclick",this.listenerMouseDoubleClick,!1),this.removeScroll(),this.updateTimer=null,this.updateTimerEvent=null,this.drawEmptyViewer(),this.container.display&&this.container.display.drawEmptyDisplay(),this.updateSliceSliderControl(),this.container.toolbar.buildToolbar()},papaya.viewer.Viewer.prototype.getHeaderDescription=function(a){return a=a||0,this.screenVolumes[a].volume.header.toString()},papaya.viewer.Viewer.prototype.getImageDimensionsDescription=function(a){var b,c;return b=this.screenVolumes[a].volume.header.orientation.orientation,c=this.screenVolumes[a].volume.header.imageDimensions,"("+b.charAt(0)+", "+b.charAt(1)+", "+b.charAt(2)+") "+c.cols+" x "+c.rows+" x "+c.slices},papaya.viewer.Viewer.prototype.getVoxelDimensionsDescription=function(a){var b,c;return b=this.screenVolumes[a].volume.header.orientation.orientation,c=this.screenVolumes[a].volume.header.voxelDimensions,"("+b.charAt(0)+", "+b.charAt(1)+", "+b.charAt(2)+") "+papaya.utilities.StringUtils.formatNumber(c.colSize,!0)+" x "+papaya.utilities.StringUtils.formatNumber(c.rowSize,!0)+" x "+papaya.utilities.StringUtils.formatNumber(c.sliceSize,!0)+" "+c.getSpatialUnitString()},papaya.viewer.Viewer.prototype.getSeriesDimensionsDescription=function(a){var b=this.screenVolumes[a].volume.header.imageDimensions;return b.timepoints.toString()},papaya.viewer.Viewer.prototype.getSeriesSizeDescription=function(a){var b=this.screenVolumes[a].volume.header.voxelDimensions;return b.timeSize.toString()+" "+b.getTemporalUnitString()},papaya.viewer.Viewer.prototype.getFilename=function(a){return papaya.utilities.StringUtils.wordwrap(this.screenVolumes[a].volume.fileName,25,"<br />",!0)},papaya.viewer.Viewer.prototype.getSurfaceFilename=function(a){return papaya.utilities.StringUtils.wordwrap(this.surfaces[a].filename,25,"<br />",!0)},papaya.viewer.Viewer.prototype.getSurfaceNumPoints=function(a){return this.surfaces[a].numPoints},papaya.viewer.Viewer.prototype.getSurfaceNumTriangles=function(a){return this.surfaces[a].numTriangles},papaya.viewer.Viewer.prototype.getNiceFilename=function(a){var b,c;return b="...",c=this.screenVolumes[a].volume.fileName.replace(".nii","").replace(".gz",""),c.length>papaya.viewer.Viewer.TITLE_MAX_LENGTH&&(c=c.substr(0,papaya.viewer.Viewer.TITLE_MAX_LENGTH-b.length)+b),c},papaya.viewer.Viewer.prototype.getFileLength=function(a){return papaya.utilities.StringUtils.getSizeString(this.screenVolumes[a].volume.fileLength)},papaya.viewer.Viewer.prototype.getByteTypeDescription=function(a){return this.screenVolumes[a].volume.header.imageType.numBytes+"-Byte "+this.screenVolumes[a].volume.header.imageType.getTypeDescription()},papaya.viewer.Viewer.prototype.getByteOrderDescription=function(a){return this.screenVolumes[a].volume.header.imageType.getOrderDescription()},papaya.viewer.Viewer.prototype.getCompressedDescription=function(a){return this.screenVolumes[a].volume.header.imageType.compressed?"Yes":"No"},papaya.viewer.Viewer.prototype.getOrientationDescription=function(a){return this.screenVolumes[a].volume.header.orientation.getOrientationDescription()},papaya.viewer.Viewer.prototype.getImageDescription=function(a){return papaya.utilities.StringUtils.wordwrap(this.screenVolumes[a].volume.header.imageDescription.notes,35,"<br />",!0)},papaya.viewer.Viewer.prototype.setCurrentScreenVol=function(a){this.currentScreenVolume=this.screenVolumes[a],this.updateWindowTitle()},papaya.viewer.Viewer.prototype.updateWindowTitle=function(){var a;this.initialized&&(a=this.getNiceFilename(this.getCurrentScreenVolIndex()),this.currentScreenVolume.volume.numTimepoints>1&&(a=a+" ("+(this.currentScreenVolume.currentTimepoint+1)+" of "+this.currentScreenVolume.volume.numTimepoints+")"),this.isZooming()&&(a=a+" "+this.getZoomString()),this.container.toolbar.updateTitleBar(a))},papaya.viewer.Viewer.prototype.getCurrentScreenVolIndex=function(){var a;for(a=0;a<this.screenVolumes.length;a+=1)if(this.screenVolumes[a]===this.currentScreenVolume)return a;return-1},papaya.viewer.Viewer.prototype.toggleWorldSpace=function(){this.worldSpace=!this.worldSpace,this.container.syncOverlaySeries&&this.reconcileOverlaySeriesPoint(this.currentScreenVolume)},papaya.viewer.Viewer.prototype.isSelected=function(a){return this.isSelectable()&&a===this.getCurrentScreenVolIndex()},papaya.viewer.Viewer.prototype.isSelectable=function(){return this.screenVolumes.length>1},papaya.viewer.Viewer.prototype.processParams=function(a){a.worldSpace&&(this.worldSpace=!0),a.coordinate&&(this.initialCoordinate=a.coordinate),this.container.isDesktopMode()||(void 0!==a.showOrientation&&(this.container.preferences.showOrientation=a.showOrientation?"Yes":"No"),void 0!==a.smoothDisplay&&(this.container.preferences.smoothDisplay=a.smoothDisplay?"Yes":"No"),void 0!==a.radiological&&(this.container.preferences.radiological=a.radiological?"Yes":"No"),void 0!==a.showRuler&&(this.container.preferences.showRuler=a.showRuler?"Yes":"No"),void 0!==a.showSurfacePlanes&&(this.container.preferences.showSurfacePlanes=a.showSurfacePlanes?"Yes":"No"),void 0!==a.showSurfaceCrosshairs&&(this.container.preferences.showSurfaceCrosshairs=a.showSurfaceCrosshairs?"Yes":"No"))},papaya.viewer.Viewer.prototype.hasLoadedDTI=function(){return 1===this.screenVolumes.length&&this.screenVolumes[0].dti&&null===this.screenVolumes[0].dtiVolumeMod},papaya.viewer.Viewer.prototype.goToInitialCoordinate=function(){var a=new papaya.core.Coordinate;this.screenVolumes.length>0&&(null===this.initialCoordinate?a.setCoordinate(papayaFloorFast(this.volume.header.imageDimensions.xDim/2),papayaFloorFast(this.volume.header.imageDimensions.yDim/2),papayaFloorFast(this.volume.header.imageDimensions.zDim/2),!0):(this.worldSpace?this.getIndexCoordinateAtWorld(this.initialCoordinate[0],this.initialCoordinate[1],this.initialCoordinate[2],a):a.setCoordinate(this.initialCoordinate[0],this.initialCoordinate[1],this.initialCoordinate[2],!0),this.initialCoordinate=null),this.gotoCoordinate(a),this.container.display&&this.container.display.drawDisplay(this.currentCoord.x,this.currentCoord.y,this.currentCoord.z))},papaya.viewer.Viewer.prototype.getOrientationCertaintyColor=function(){var a=this.screenVolumes[0].volume.header.orientationCertainty;return a===papaya.volume.Header.ORIENTATION_CERTAINTY_LOW?papaya.viewer.Viewer.ORIENTATION_CERTAINTY_LOW_COLOR:a===papaya.volume.Header.ORIENTATION_CERTAINTY_HIGH?papaya.viewer.Viewer.ORIENTATION_CERTAINTY_HIGH_COLOR:papaya.viewer.Viewer.ORIENTATION_CERTAINTY_UNKNOWN_COLOR},papaya.viewer.Viewer.prototype.isUsingAtlas=function(a){return a===this.atlas.currentAtlas},papaya.viewer.Viewer.prototype.scrolled=function(a){var b,c;a=a||window.event,a.target==this.canvas&&(a.preventDefault&&a.preventDefault(),a.returnValue=!1,c="Increment Slice"===this.container.preferences.scrollBehavior,b=papaya.utilities.PlatformUtils.getScrollSign(a,!c),c?b<0?(this.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?this.incrementAxial(!1,Math.abs(b)):this.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?this.incrementCoronal(!1,Math.abs(b)):this.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&this.incrementSagittal(!1,Math.abs(b)),this.gotoCoordinate(this.currentCoord)):b>0&&(this.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?this.incrementAxial(!0,Math.abs(b)):this.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?this.incrementCoronal(!0,Math.abs(b)):this.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&this.incrementSagittal(!0,Math.abs(b)),this.gotoCoordinate(this.currentCoord)):0!==b&&(this.isZoomMode=!0,this.mainImage===this.surfaceView?(this.surfaceView.zoom+=b*-5*this.surfaceView.scaleFactor,
this.drawViewer(!1,!0)):(this.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?this.setZoomLocation(this.currentCoord.x,this.currentCoord.y,this.mainImage.sliceDirection):this.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?this.setZoomLocation(this.currentCoord.x,this.currentCoord.z,this.mainImage.sliceDirection):this.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&this.setZoomLocation(this.currentCoord.y,this.currentCoord.z,this.mainImage.sliceDirection),this.setZoomFactor(this.zoomFactorPrevious+.1*b*this.zoomFactorPrevious)),this.zoomFactorPrevious=this.zoomFactor))},papaya.viewer.Viewer.prototype.incrementAxial=function(a,b){var c=this.volume.header.imageDimensions.zDim;void 0===b&&(b=1),a?(this.currentCoord.z+=b,this.currentCoord.z>=c&&(this.currentCoord.z=c-1)):(this.currentCoord.z-=b,this.currentCoord.z<0&&(this.currentCoord.z=0)),this.gotoCoordinate(this.currentCoord)},papaya.viewer.Viewer.prototype.incrementCoronal=function(a,b){var c=this.volume.header.imageDimensions.yDim;void 0===b&&(b=1),a?(this.currentCoord.y+=b,this.currentCoord.y>=c&&(this.currentCoord.y=c-1)):(this.currentCoord.y-=b,this.currentCoord.y<0&&(this.currentCoord.y=0)),this.gotoCoordinate(this.currentCoord)},papaya.viewer.Viewer.prototype.incrementSagittal=function(a,b){var c=this.volume.header.imageDimensions.xDim;void 0===b&&(b=1),a?(this.currentCoord.x-=b,this.currentCoord.x<0&&(this.currentCoord.x=0)):(this.currentCoord.x+=b,this.currentCoord.x>=c&&(this.currentCoord.x=c-1)),this.gotoCoordinate(this.currentCoord)},papaya.viewer.Viewer.prototype.setZoomFactor=function(a){a>papaya.viewer.Viewer.ZOOM_FACTOR_MAX?a=papaya.viewer.Viewer.ZOOM_FACTOR_MAX:a<papaya.viewer.Viewer.ZOOM_FACTOR_MIN&&(a=papaya.viewer.Viewer.ZOOM_FACTOR_MIN),this.zoomFactor=a,1===this.zoomFactor&&(this.panAmountX=this.panAmountY=this.panAmountZ=0),this.axialSlice.updateZoomTransform(this.zoomFactor,this.zoomLocX,this.zoomLocY,this.panAmountX,this.panAmountY,this),this.coronalSlice.updateZoomTransform(this.zoomFactor,this.zoomLocX,this.zoomLocZ,this.panAmountX,this.panAmountZ,this),this.sagittalSlice.updateZoomTransform(this.zoomFactor,this.zoomLocY,this.zoomLocZ,this.panAmountY,this.panAmountZ,this),this.drawViewer(!1,!0),this.updateWindowTitle()},papaya.viewer.Viewer.prototype.getZoomString=function(){return parseInt(100*this.zoomFactor,10)+"%"},papaya.viewer.Viewer.prototype.isZooming=function(){return this.zoomFactor>1},papaya.viewer.Viewer.prototype.setZoomLocation=function(){1===this.zoomFactor&&(this.zoomLocX=this.currentCoord.x,this.zoomLocY=this.currentCoord.y,this.zoomLocZ=this.currentCoord.z,this.axialSlice.updateZoomTransform(this.zoomFactor,this.zoomLocX,this.zoomLocY,this.panAmountX,this.panAmountY,this),this.coronalSlice.updateZoomTransform(this.zoomFactor,this.zoomLocX,this.zoomLocZ,this.panAmountX,this.panAmountZ,this),this.sagittalSlice.updateZoomTransform(this.zoomFactor,this.zoomLocY,this.zoomLocZ,this.panAmountY,this.panAmountZ,this),this.drawViewer(!1,!0))},papaya.viewer.Viewer.prototype.setStartPanLocation=function(a,b,c){var d;this.zoomFactor>1&&(c===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?(this.panLocX=a,this.panLocY=b,this.panLocZ=this.axialSlice.currentSlice):c===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?(this.panLocX=a,this.panLocY=this.coronalSlice.currentSlice,this.panLocZ=b):c===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&(this.panLocX=this.sagittalSlice.currentSlice,d=a,this.panLocY=d,this.panLocZ=b))},papaya.viewer.Viewer.prototype.setCurrentPanLocation=function(a,b,c){this.zoomFactor>1&&(c===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?(this.panAmountX+=a-this.panLocX,this.panAmountY+=b-this.panLocY,this.panAmountZ=0):c===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?(this.panAmountX+=a-this.panLocX,this.panAmountY=0,this.panAmountZ+=b-this.panLocZ):c===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&(this.panAmountX=0,this.panAmountY+=a-this.panLocY,this.panAmountZ+=b-this.panLocZ),this.axialSlice.updateZoomTransform(this.zoomFactor,this.zoomLocX,this.zoomLocY,this.panAmountX,this.panAmountY,this),this.coronalSlice.updateZoomTransform(this.zoomFactor,this.zoomLocX,this.zoomLocZ,this.panAmountX,this.panAmountZ,this),this.sagittalSlice.updateZoomTransform(this.zoomFactor,this.zoomLocY,this.zoomLocZ,this.panAmountY,this.panAmountZ,this),this.drawViewer(!1,!0))},papaya.viewer.Viewer.prototype.isWorldMode=function(){return this.worldSpace},papaya.viewer.Viewer.prototype.isRadiologicalMode=function(){return"Yes"===this.container.preferences.radiological},papaya.viewer.Viewer.prototype.isCollapsable=function(){return this.container.collapsable},papaya.viewer.Viewer.prototype.mainSliderControlChanged=function(){this.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?this.currentCoord.z=parseInt(this.mainSliderControl.val(),10):this.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?this.currentCoord.y=parseInt(this.mainSliderControl.val(),10):this.mainImage.sliceDirection===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL&&(this.currentCoord.x=parseInt(this.mainSliderControl.val(),10)),this.gotoCoordinate(this.currentCoord)},papaya.viewer.Viewer.prototype.axialSliderControlChanged=function(){this.currentCoord.z=parseInt(this.axialSliderControl.val(),10),this.gotoCoordinate(this.currentCoord)},papaya.viewer.Viewer.prototype.coronalSliderControlChanged=function(){this.currentCoord.y=parseInt(this.coronalSliderControl.val(),10),this.gotoCoordinate(this.currentCoord)},papaya.viewer.Viewer.prototype.sagittalSliderControlChanged=function(){this.currentCoord.x=parseInt(this.sagittalSliderControl.val(),10),this.gotoCoordinate(this.currentCoord)},papaya.viewer.Viewer.prototype.seriesSliderControlChanged=function(){this.currentScreenVolume.setTimepoint(parseInt(this.seriesSliderControl.val(),10)),this.currentScreenVolume.isOverlay()&&this.container.syncOverlaySeries&&this.reconcileOverlaySeriesPoint(this.currentScreenVolume),this.timepointChanged()},papaya.viewer.Viewer.prototype.updateSliceSliderControl=function(){this.mainSliderControl&&this.doUpdateSliceSliderControl(this.mainSliderControl,this.mainImage.sliceDirection),this.axialSliderControl&&this.doUpdateSliceSliderControl(this.axialSliderControl,papaya.viewer.ScreenSlice.DIRECTION_AXIAL),this.coronalSliderControl&&this.doUpdateSliceSliderControl(this.coronalSliderControl,papaya.viewer.ScreenSlice.DIRECTION_CORONAL),this.sagittalSliderControl&&this.doUpdateSliceSliderControl(this.sagittalSliderControl,papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL),this.seriesSliderControl&&this.doUpdateSliceSliderControl(this.seriesSliderControl,papaya.viewer.ScreenSlice.DIRECTION_TEMPORAL)},papaya.viewer.Viewer.prototype.doUpdateSliceSliderControl=function(a,b){this.initialized?(a.prop("disabled",!1),a.prop("min","0"),a.prop("step","1"),b===papaya.viewer.ScreenSlice.DIRECTION_AXIAL?(a.prop("max",(this.volume.header.imageDimensions.zDim-1).toString()),a.val(this.currentCoord.z)):b===papaya.viewer.ScreenSlice.DIRECTION_CORONAL?(a.prop("max",(this.volume.header.imageDimensions.yDim-1).toString()),a.val(this.currentCoord.y)):b===papaya.viewer.ScreenSlice.DIRECTION_SAGITTAL?(a.prop("max",(this.volume.header.imageDimensions.xDim-1).toString()),a.val(this.currentCoord.x)):b===papaya.viewer.ScreenSlice.DIRECTION_TEMPORAL&&(a.prop("max",(this.currentScreenVolume.volume.header.imageDimensions.timepoints-1).toString()),a.val(this.currentScreenVolume.currentTimepoint))):(a.prop("disabled",!0),a.prop("min","0"),a.prop("step","1"),a.prop("max","1"),a.val(0))},papaya.viewer.Viewer.prototype.incrementSeriesPoint=function(){this.currentScreenVolume.incrementTimepoint(),this.currentScreenVolume.isOverlay()&&this.container.syncOverlaySeries&&this.reconcileOverlaySeriesPoint(this.currentScreenVolume),this.timepointChanged()},papaya.viewer.Viewer.prototype.decrementSeriesPoint=function(){this.currentScreenVolume.decrementTimepoint(),this.currentScreenVolume.isOverlay()&&this.container.syncOverlaySeries&&this.reconcileOverlaySeriesPoint(this.currentScreenVolume),this.timepointChanged()},papaya.viewer.Viewer.prototype.reconcileOverlaySeriesPoint=function(a){var b,c,d;if(this.worldSpace)for(d=a.getCurrentTime(),b=1;b<this.screenVolumes.length;b+=1)this.screenVolumes[b]!==a&&this.screenVolumes[b].setCurrentTime(d);else for(c=a.currentTimepoint,b=1;b<this.screenVolumes.length;b+=1)this.screenVolumes[b]!==a&&this.screenVolumes[b].setTimepoint(c)},papaya.viewer.Viewer.prototype.hasParametricPair=function(a){return!!a&&null!==this.screenVolumes[a].negativeScreenVol},papaya.viewer.Viewer.prototype.getScreenVolumeIndex=function(a){var b;if(a)for(b=0;b<this.screenVolumes.length;b+=1)if(a===this.screenVolumes[b])return b;return-1},papaya.viewer.Viewer.prototype.getScreenVolumeByName=function(a){var b;for(b=0;b<this.screenVolumes.length;b+=1)if(a==this.screenVolumes[b].volume.fileName)return this.screenVolumes[b];return null},papaya.viewer.Viewer.prototype.isShowingRuler=function(){return"Yes"===this.container.preferences.showRuler},papaya.viewer.Viewer.prototype.isShowingOrientation=function(){return"Yes"===this.container.preferences.showOrientation},papaya.viewer.Viewer.prototype.isShowingCrosshairs=function(){return"Yes"===this.container.preferences.showCrosshairs},papaya.viewer.Viewer.prototype.isShowingSurfacePlanes=function(){return this.surfaceView&&this.surfaceView.showSurfacePlanes},papaya.viewer.Viewer.prototype.isShowingSurfaceCrosshairs=function(){return this.surfaceView&&this.surfaceView.showSurfaceCrosshairs},papaya.viewer.Viewer.prototype.restart=function(a,b,c,d){this.resetViewer(),this.container.toolbar.updateImageButtons(),this.loadImage(a,b,c,d)},papaya.viewer.Viewer.prototype.removeOverlay=function(a){var b,c;b=this.container.viewer.screenVolumes[a],c=b.negativeScreenVol,this.closeOverlayByRef(b),this.container.combineParametric&&this.closeOverlayByRef(c),this.drawViewer(!0,!1)},papaya.viewer.Viewer.prototype.toggleOverlay=function(a){var b,c;return b=this.container.viewer.screenVolumes[a],b.hidden=!b.hidden,c=b.negativeScreenVol,this.container.combineParametric&&c&&(c.hidden=!c.hidden),this.drawViewer(!0,!1),b.hidden},papaya.viewer.Viewer.prototype.addParametric=function(a){var b,c=this.container.viewer.screenVolumes[a];null===c.negativeScreenVol&&(this.screenVolumes[this.screenVolumes.length]=b=new papaya.viewer.ScreenVolume(c.volume,{},papaya.viewer.ColorTable.PARAMETRIC_COLOR_TABLES[1].name,(!1),(!0),this.currentCoord),c.negativeScreenVol=b,this.setCurrentScreenVol(this.screenVolumes.length-1),this.drawViewer(!0,!1),this.container.toolbar.buildToolbar(),this.container.toolbar.updateImageButtons())};